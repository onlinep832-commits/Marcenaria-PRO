<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="google-adsense-account" content="ca-pub-7068124591666531">
        <title>Marcenaria PRO - Listagem e Or√ßamento (Design 2026)</title>

        <!-- Depend√™ncias Externas (Bibliotecas) - CARREGADAS VIA CDN -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

        <!-- Fontes do Google -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

        <!-- Estilos (CSS) - TEMA VISUAL 2026 (CLARO & MODERNO) -->
        <style>
            :root {
                /* Paleta de Cores 2025 (Modern Gradient) */
                --cor-principal: #6366f1;       /* Indigo Premium */
                --cor-principal-hover: #4f46e5;
                --cor-secundaria: #8b5cf6;      /* Purple */
                --cor-sucesso: #10b981;         /* Emerald */
                --cor-perigo: #ef4444;          /* Red */
                --cor-aviso: #f59e0b;           /* Amber */
                
                --cor-fundo: #f0f4f8;           /* Ultra Light Indigo */
                --cor-card: #ffffff;            /* Branco Puro */
                --cor-input-bg: #f3f4f6;        /* Light Gray */
                
                --cor-texto: #1f2937;           /* Dark Gray */
                --cor-texto-suave: #6b7280;     /* Medium Gray */
                --cor-borda: #e5e7eb;           /* Light Border */
                
                --radius-sm: 10px;
                --radius-md: 14px;
                --radius-lg: 18px;
                
                --sombra-card: 0 2px 8px rgba(99, 102, 241, 0.08);
                --sombra-flutuante: 0 12px 24px rgba(99, 102, 241, 0.15);
                --sombra-profunda: 0 20px 40px rgba(99, 102, 241, 0.2);
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            body {
                font-family: "Segoe UI", "Roboto", "Inter", sans-serif;
                background: linear-gradient(135deg, var(--cor-fundo) 0%, #faf9f7 100%);
                color: var(--cor-texto);
                line-height: 1.6;
                padding-bottom: 40px;
                min-height: 100vh;
            }

            /* --- HEADER --- */
            header {
                background: linear-gradient(135deg, var(--cor-principal) 0%, var(--cor-secundaria) 100%);
                color: white;
                padding: 2.5rem 2rem;
                text-align: center;
                border-bottom: none;
                box-shadow: var(--sombra-profunda);
                margin-bottom: 40px;
                position: relative;
                overflow: hidden;
            }
            
            header::before {
                content: '';
                position: absolute;
                top: -50%;
                right: -10%;
                width: 300px;
                height: 300px;
                background: rgba(255,255,255,0.1);
                border-radius: 50%;
                filter: blur(40px);
            }

            header h1 {
                font-weight: 900;
                font-size: 2.5rem;
                letter-spacing: -1px;
                color: white;
                margin-bottom: 8px;
                position: relative;
                z-index: 1;
            }

            header p {
                color: rgba(255,255,255,0.9);
                font-weight: 500;
                font-size: 1.05rem;
                position: relative;
                z-index: 1;
            }

            /* --- LAYOUT PRINCIPAL --- */
            main {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 20px;
                display: flex;
                flex-direction: column;
                gap: 30px;
            }

            .app-view {
                display: flex;
                flex-direction: column;
                gap: 30px;
            }

            /* --- CARDS & SECTIONS --- */
            .card {
                background-color: var(--cor-card);
                padding: 36px;
                border-radius: var(--radius-lg);
                border: 1px solid var(--cor-borda);
                box-shadow: var(--sombra-card);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
            }
            
            .card:hover {
                box-shadow: var(--sombra-flutuante);
                border-color: rgba(99, 102, 241, 0.2);
            }

            /* Efeito sutil ao passar o mouse apenas em cards interativos */
            .modulo-selecao-card:hover {
                transform: translateY(-6px);
                box-shadow: var(--sombra-flutuante);
                border-color: var(--cor-principal);
            }

            /* --- TYPOGRAPHY --- */
            h2 {
                font-size: 1.8rem;
                font-weight: 800;
                color: var(--cor-texto);
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 20px;
                letter-spacing: -0.03em;
            }
            
            h3 {
                font-size: 1.3rem;
                color: var(--cor-texto);
                font-weight: 700;
                margin-top: 28px;
                margin-bottom: 18px;
                padding-bottom: 12px;
                border-bottom: 2px solid var(--cor-borda);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            h4 {
                font-size: 1.05rem;
                font-weight: 700;
                color: var(--cor-principal);
                margin-top: 18px;
                margin-bottom: 12px;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                font-size: 0.9rem;
            }

            .card > p {
                color: var(--cor-texto-suave);
                margin-bottom: 28px;
                font-size: 1.02rem;
            }

            /* Bolinha do passo a passo */
            h2 .step-number {
                background: linear-gradient(135deg, var(--cor-principal) 0%, var(--cor-secundaria) 100%);
                color: white;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem;
                font-weight: 800;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }

            /* --- FORMS & INPUTS --- */
            .form-grid {
                display: grid;
                gap: 24px;
                margin-top: 18px;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            }

            .form-group {
                display: flex;
                flex-direction: column;
            }

            .form-group label {
                font-weight: 700;
                font-size: 0.9rem;
                color: var(--cor-texto);
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.04em;
                display: flex;
                align-items: center;
                gap: 6px;
            }
            
            .form-group .formula-helper {
                font-size: 0.8rem;
                color: var(--cor-principal);
                margin-top: 6px;
                font-weight: 500;
                background: rgba(99, 102, 241, 0.1);
                padding: 6px 12px;
                border-radius: 6px;
                display: inline-block;
                width: fit-content;
            }

            input, select, textarea {
                width: 100%;
                padding: 14px 18px;
                border: 2px solid transparent;
                border-radius: var(--radius-sm);
                font-size: 1rem;
                font-family: inherit;
                background-color: var(--cor-input-bg);
                color: var(--cor-texto);
                transition: all 0.3s ease;
                font-weight: 500;
            }

            input:focus, select:focus, textarea:focus {
                outline: none;
                background-color: #fff;
                border-color: var(--cor-principal);
                box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            }
            
            /* Inputs readonly parecem desabilitados mas leg√≠veis */
            input:read-only, select:disabled {
                background-color: #f3f4f6;
                color: var(--cor-texto-suave);
                cursor: not-allowed;
                opacity: 0.7;
            }

            /* --- BOT√ïES --- */
            button, .btn {
                padding: 14px 28px;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                font-weight: 700;
                font-size: 0.98rem;
                font-family: inherit;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                color: white;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                position: relative;
                overflow: hidden;
            }

            button::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: rgba(255,255,255,0.2);
                transition: left 0.3s ease;
                z-index: 0;
            }

            button:hover::before {
                left: 100%;
            }

            button:hover, .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            }
            
            button:active {
                transform: translateY(0);
            }

            .btn-primary { 
                background: linear-gradient(135deg, var(--cor-principal) 0%, var(--cor-secundaria) 100%);
            }

            .btn-success { 
                background: linear-gradient(135deg, var(--cor-sucesso) 0%, #059669 100%);
            }

            .btn-danger { 
                background: linear-gradient(135deg, var(--cor-perigo) 0%, #dc2626 100%);
            }

            .btn-warning { 
                background: linear-gradient(135deg, var(--cor-aviso) 0%, #d97706 100%);
                color: white;
            }

            .btn-secondary { 
                background: linear-gradient(135deg, var(--cor-texto-suave) 0%, #4b5563 100%);
            }
            
            .btn-sm {
                padding: 8px 16px;
                font-size: 0.85rem;
                border-radius: 8px;
                text-transform: capitalize;
                letter-spacing: 0;
            }

            .botoes-acao {
                display: flex;
                gap: 14px;
                align-items: flex-end;
                margin-top: 24px;
                flex-wrap: wrap;
            }
            
            /* Navega√ß√£o Superior */
            nav.card {
                padding: 18px 28px;
                background: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 16px;
            }
            
            nav.card h2 {
                margin: 0;
            }
            
            nav .botoes-acao {
                margin: 0;
            }

            /* --- TABELAS --- */
            .table-responsive {
                overflow-x: auto;
                border-radius: var(--radius-md);
                border: 1px solid var(--cor-borda);
            }

            table {
                width: 100%;
                border-collapse: collapse;
                background-color: white;
            }

            th {
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                color: var(--cor-texto);
                font-weight: 800;
                text-transform: uppercase;
                font-size: 0.82rem;
                letter-spacing: 0.06em;
                padding: 18px;
                border-bottom: 2px solid var(--cor-principal);
                text-align: left;
            }

            td {
                padding: 16px 18px;
                border-bottom: 1px solid var(--cor-borda);
                color: var(--cor-texto-suave);
                font-size: 0.98rem;
                vertical-align: middle;
            }

            tbody tr:last-child td {
                border-bottom: none;
            }

            tbody tr:hover {
                background: linear-gradient(90deg, rgba(99, 102, 241, 0.03) 0%, transparent 100%);
            }
            
            /* Linhas de cabe√ßalho de grupo na tabela */
            .group-header td, 
            #lista-materiais-compra .group-header-shopping td {
                background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
                color: var(--cor-principal);
                font-weight: 800;
                border-top: 2px solid var(--cor-principal);
                border-bottom: 2px solid var(--cor-principal);
            }

            /* Inputs edit√°veis na tabela */
            td input.editable-input {
                width: 80px;
                padding: 8px;
                background: white;
                border: 2px solid var(--cor-borda);
                text-align: center;
                border-radius: 6px;
                font-weight: 600;
            }

            /* --- OR√áAMENTO FINAL --- */
            #orcamento-final {
                margin-top: 36px;
                background: linear-gradient(135deg, #f0fdf4 0%, #f0f9ff 100%);
                padding: 32px;
                border-radius: var(--radius-lg);
                border: 2px solid var(--cor-sucesso);
                box-shadow: 0 8px 16px rgba(16, 185, 129, 0.1);
            }

            #orcamento-final p {
                display: flex;
                justify-content: space-between;
                font-size: 1.1rem;
                margin-bottom: 12px;
                color: var(--cor-texto);
                font-weight: 600;
            }
            
            #orcamento-final span:first-child {
                color: var(--cor-texto-suave);
            }

            #orcamento-total {
                font-size: 2.8rem;
                color: #15803d;
                font-weight: 900;
                margin-top: 20px;
                text-align: right;
                letter-spacing: -1px;
            }

            /* --- COMPONENTES VISUAIS --- */
            
            /* Preview de Imagens */
            .item-preview {
                width: 100%;
                height: 120px;
                border-radius: var(--radius-md);
                object-fit: cover;
                background: linear-gradient(135deg, var(--cor-input-bg) 0%, #e5e7eb 100%);
                border: 2px solid var(--cor-borda);
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .item-preview:hover {
                border-color: var(--cor-principal);
                box-shadow: 0 8px 16px rgba(99, 102, 241, 0.15);
            }
            
            #imagemModuloPreviewProjeto {
                width: 120px;
                height: 120px;
                border-radius: var(--radius-md);
                border: 2px solid var(--cor-borda);
                object-fit: contain;
                background: linear-gradient(135deg, white 0%, #f3f4f6 100%);
                padding: 8px;
            }

            .seletor-com-preview {
                display: flex;
                gap: 28px;
                align-items: flex-end;
                margin-top: 14px;
                flex-wrap: wrap;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, transparent 100%);
                padding: 24px;
                border-radius: var(--radius-lg);
                border: 1px solid rgba(99, 102, 241, 0.1);
            }
            
            #displayModuloSelecionado {
                padding: 14px 20px;
                border: 2px solid var(--cor-borda);
                border-radius: var(--radius-sm);
                background-color: white;
                flex-grow: 1;
                color: var(--cor-texto);
                font-weight: 700;
                display: flex;
                align-items: center;
                transition: all 0.3s ease;
            }
            
            #displayModuloSelecionado:hover {
                border-color: var(--cor-principal);
            }

            /* Lista Catalogo / Gerenciador */
            .catalogo-gerenciador {
                display: flex;
                flex-direction: column;
                gap: 14px;
                margin-top: 20px;
                max-height: 450px;
                overflow-y: auto;
                padding-right: 12px;
            }
            
            /* Scrollbar bonita */
            ::-webkit-scrollbar { width: 10px; height: 10px; }
            ::-webkit-scrollbar-track { background: transparent; }
            ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--cor-principal) 0%, var(--cor-secundaria) 100%); border-radius: 5px; }
            ::-webkit-scrollbar-thumb:hover { background: var(--cor-principal); }

            .catalogo-item {
                display: flex;
                align-items: center;
                gap: 18px;
                padding: 14px;
                border-radius: var(--radius-sm);
                border: 2px solid transparent;
                background: linear-gradient(135deg, white 0%, #f9fafb 100%);
                transition: all 0.3s ease;
            }
            
            .catalogo-item:hover {
                border-color: var(--cor-principal);
                box-shadow: var(--sombra-card);
                transform: translateX(4px);
            }
            }
            
            .catalogo-item:hover {
                border-color: var(--cor-principal);
            }

            .catalogo-item img {
                width: 48px;
                height: 48px;
                border-radius: 6px;
                object-fit: cover;
                background: var(--cor-input-bg);
                border: 1px solid var(--cor-borda);
            }

            .catalogo-item span {
                flex-grow: 1;
                font-weight: 500;
                color: var(--cor-texto);
            }

            /* Resumo do Projeto */
            .resumo-projeto li {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px;
                border-bottom: 1px solid var(--cor-borda);
                background: white;
            }
            .resumo-projeto li:first-child { border-top-left-radius: var(--radius-sm); border-top-right-radius: var(--radius-sm); }
            .resumo-projeto li:last-child { border-bottom: none; border-bottom-left-radius: var(--radius-sm); border-bottom-right-radius: var(--radius-sm); }

            .resumo-projeto li .item-info img {
                width: 40px;
                height: 40px;
                border-radius: 6px;
                object-fit: cover;
                margin-right: 12px;
            }
            
            .resumo-detalhes-cores {
                font-size: 0.8rem;
                color: var(--cor-texto-suave);
                margin-top: 4px;
            }

            /* --- MODAL --- */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(15, 23, 42, 0.4); /* Backdrop escuro transl√∫cido */
                backdrop-filter: blur(4px);
                z-index: 1050;
                display: none;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .modal-overlay.active { display: flex; }

            .modal-content {
                background: var(--cor-card);
                padding: 32px;
                border-radius: var(--radius-lg);
                width: 100%;
                max-width: 1100px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: var(--sombra-flutuante);
                position: relative;
                animation: modalSlideUp 0.3s ease-out;
            }
            
            @keyframes modalSlideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--cor-borda);
                padding-bottom: 20px;
                margin-bottom: 24px;
            }

            .modal-close {
                font-size: 2rem;
                color: var(--cor-texto-suave);
                background: none;
                border: none;
                cursor: pointer;
                line-height: 1;
                padding: 0 8px;
            }
            .modal-close:hover { color: var(--cor-perigo); }
            
            .filtro-modal, .filtro-view {
                padding: 10px 16px;
                border: 1px solid var(--cor-borda);
                border-radius: 20px; /* Mais arredondado para busca */
                width: 250px;
            }

            /* --- GRID SELE√á√ÉO M√ìDULOS --- */
            #grid-selecao-modulos {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 20px;
                padding: 10px 4px;
            }

            .modulo-selecao-card {
                border: 1px solid var(--cor-borda);
                border-radius: var(--radius-md);
                padding: 16px;
                text-align: center;
                cursor: pointer;
                background-color: white;
                transition: all 0.2s ease;
            }

            .modulo-selecao-card img {
                width: 100%;
                height: 100px;
                object-fit: contain;
                margin-bottom: 12px;
            }
            
            .modulo-selecao-card p {
                font-weight: 600;
                font-size: 0.9rem;
                color: var(--cor-texto);
            }
            
            .grid-category-header {
                grid-column: 1 / -1;
                font-size: 1.1rem;
                color: var(--cor-principal);
                border-bottom: 2px solid var(--cor-borda);
                padding-bottom: 8px;
                margin-top: 24px;
            }

            /* --- PE√áAS ITEM (EDITOR) --- */
            .peca-item-wrapper {
                background-color: var(--cor-fundo);
                border: 1px solid var(--cor-borda);
                padding: 24px;
                border-radius: var(--radius-md);
                margin-bottom: 20px;
            }

            .peca-item {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 16px;
                align-items: flex-end;
            }

            /* --- TOAST --- */
            #toast-container {
                position: fixed;
                top: 24px;
                right: 24px;
                z-index: 2000;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .toast {
                padding: 16px 24px;
                border-radius: var(--radius-sm);
                background: white;
                color: var(--cor-texto);
                box-shadow: var(--sombra-flutuante);
                border-left: 5px solid var(--cor-principal);
                font-weight: 500;
                transform: translateX(120%);
                transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            }
            
            .toast.show { transform: translateX(0); }
            .toast.success { border-left-color: var(--cor-sucesso); }
            .toast.error { border-left-color: var(--cor-perigo); }
            .toast.warning { border-left-color: var(--cor-aviso); }

            /* --- RESPONSIVIDADE --- */
            @media (max-width: 768px) {
                header { padding: 1rem; }
                header h1 { font-size: 1.5rem; }
                .card { padding: 20px; }
                .botoes-acao { flex-direction: column; }
                .botoes-acao button, .botoes-acao select { width: 100%; }
                .peca-item { grid-template-columns: 1fr; }
                .seletor-com-preview { flex-direction: column-reverse; align-items: center; }
                #imagemModuloPreviewProjeto { width: 100%; max-width: 200px; height: auto; }
            }

            /* --- PRINT --- */
            @media print {
                body { background: white; color: black; }
                nav, header, .botoes-acao, .form-grid { display: none !important; }
            }
        </style>
      </head>
    <body>
        <div id="toast-container"></div>
        <header>
            <h1>Marcenaria PRO</h1>
            <p>Sistema de Listagem e Or√ßamento Autom√°tico</p>
        </header>

        <main>
            <!-- NAVEGA√á√ÉO PRINCIPAL -->
            <nav class="card">
                <div class="botoes-acao" style="margin-top: 0; justify-content: center;">
                    <button id="btnNavProjeto" class="btn-primary">Montagem do Projeto</button>
                    <button id="btnNavGerenciarModulos" class="btn-warning">Gerenciar M√≥dulos</button>
                    <button id="btnNavGerenciarCatalogos" class="btn-secondary">Gerenciar Cat√°logos</button>
                    <button id="btnNavVisualizarCatalogo" class="btn-secondary">Visualizar Cat√°logo</button>
                    <button id="btnNavProjetosClientes" class="btn-primary">üìÅ Meus Projetos</button>
                    <button id="btnNavConfig" class="btn-secondary">‚öôÔ∏è Configura√ß√µes</button>
                    <button id="btnNavDados" class="btn-secondary">Dados Locais</button>
                </div>
            </nav>

            <!-- TELA: MONTAGEM DO PROJETO (PRINCIPAL) -->
            <div id="view-projeto" class="app-view">
                <section class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2><span class="step-number">1</span>Montagem do Projeto</h2>
                        <button type="button" class="btn-secondary btn-sm" title="Ver status dos dados" onclick="window.verificarStatusDados();">‚ÑπÔ∏è Status de Dados</button>
                    </div>
                    <p>Defina as dimens√µes e cores do projeto, depois adicione os m√≥dulos e ferragens extras que desejar.</p>
                    <h3>Dados Gerais</h3>
                    <div class="form-grid">
                        <input type="text" id="nomeCliente" placeholder="Nome do Cliente (para o PDF)" />
                        <input type="text" id="nomeAmbiente" placeholder="Ambiente (Ex: Cozinha, Quarto Casal)" />
                        <div class="form-group">
                            <label>Cor Material Interno</label>
                            <select id="projCorInterna"></select>
                        </div>
                        <div class="form-group">
                            <label>Cor Material Externo</label>
                            <select id="projCorExterna"></select>
                        </div>
                        <div class="form-group">
                            <label>Cor da Borda Interna (Projeto)</label>
                            <select id="projCorBordaInterna"></select>
                        </div>
                        <div class="form-group">
                            <label>Cor da Borda Externa (Projeto)</label>
                            <select id="projCorBordaExterna"></select>
                        </div>
                        <div class="form-group">
                            <label>Perfil de Alum√≠nio Padr√£o (para o Projeto)</label>
                            <select id="projPerfilAluminio"></select>
                        </div>
                    </div>

                    <hr style="margin: 25px 0; border-color: var(--cor-borda);" />
                    <h3>Adicionar M√≥dulos e Pe√ßas</h3>
                    <div class="form-grid" style="grid-template-columns: 1fr 200px; align-items: flex-end;">
                        <div class="form-group" style="margin: 0;">
                            <label for="tipoModuloProjeto" id="labelTipoModuloProjeto">Tipo de M√≥dulo a Adicionar</label>
                            <select id="tipoModuloProjeto">
                                <option value="reto">M√≥dulo Reto</option>
                                <option value="canto">M√≥dulo de Canto (em L)</option>
                            </select>
                        </div>
                        <div></div>
                    </div>
                    <div id="dimensoes-container-reto">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="projAltura" id="labelProjAltura">Altura Final (A) em mm</label>
                                <input type="number" id="projAltura" placeholder="Altura Final (A) em mm" />
                            </div>
                            <div class="form-group">
                                <label for="projLargura" id="labelProjLargura">Largura Final (L) em mm</label>
                                <input type="number" id="projLargura" placeholder="Largura Final (L) em mm" />
                            </div>
                            <div class="form-group">
                                <label for="projProfundidade" id="labelProjProfundidade">Profundidade Final (P) em mm</label>
                                <input type="number" id="projProfundidade" placeholder="Profundidade Final (P) em mm" />
                            </div>
                        </div>
                    </div>
                    <div id="dimensoes-container-canto" style="display: none;">
                        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <input type="number" id="projAlturaCanto" placeholder="Altura (A) em mm" />
                            <input type="number" id="projLadoA" placeholder="Lado A (mm)" />
                            <input type="number" id="projLadoB" placeholder="Lado B (mm)" />
                            <input type="number" id="projProfA" placeholder="Profundidade A (mm)" />
                            <input type="number" id="projProfB" placeholder="Profundidade B (mm)" />
                        </div>
                    </div>

                    <div class="seletor-com-preview">
                        <div style="flex-grow: 1;">
                            <div class="form-grid" style="margin-top: 0; gap: 15px; grid-template-columns: 2fr 1.5fr;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Escolha um M√≥dulo ou Pe√ßa</label>
                                    <div style="display: flex; gap: 10px;">
                                        <div id="displayModuloSelecionado" data-value="">-- Selecione um item --</div>
                                        <button id="btnAbrirSelecaoModulo" class="btn-primary" style="flex-shrink: 0;">Selecionar</button>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="moduloTipoPuxador">Tipo de Puxador</label>
                                    <select id="moduloTipoPuxador">
                                        <option value="externo">Puxador Externo (Padr√£o)</option>
                                        <option value="cava_horizontal">Puxador Cava (Horizontal)</option>
                                        <option value="cava_vertical">Puxador Cava (Vertical)</option>
                                        <option value="perfil_horizontal">Puxador Perfil de Alum√≠nio (Horizontal)</option>
                                        <option value="perfil_vertical">Puxador Perfil de Alum√≠nio (Vertical)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="botoes-acao" style="margin-top: 15px; align-items: flex-end;">
                                <div class="form-group" style="flex: 0 1 120px; margin-bottom: 0;">
                                    <label for="quantidadeModuloProjeto">Quantidade</label>
                                    <input type="number" id="quantidadeModuloProjeto" value="1" min="1" style="text-align: center;" />
                                </div>
                                <button type="button" id="btnAdicionarModulo" class="btn-primary" style="flex-grow: 1;">Adicionar ao Projeto</button>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <label>Preview</label>
                            <img id="imagemModuloPreviewProjeto" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Preview do m√≥dulo selecionado" />
                        </div>
                    </div>

                    <h3>Ferragens Extras</h3>
                    <div class="botoes-acao">
                        <select id="ferragensExtrasSelect">
                            <option value="">-- Escolha do cat√°logo --</option>
                        </select>
                        <input type="number" id="ferragemExtraValor" placeholder="Qtd ou Medida" /><button type="button" id="btnAdicionarFerragemExtra" class="btn-primary">Adicionar Ferragem Extra</button>
                    </div>
                    <div id="resumo-projeto-container" style="display: none;">
                        <h3>Resumo do Projeto Atual</h3>
                        <div class="resumo-projeto"><ul id="lista-resumo-projeto"></ul></div>
                    </div>
                </section>

                <section class="card">
                    <h2><span class="step-number">2</span>Gerar Listagem e Or√ßamento</h2>
                    <div class="botoes-acao">
                        <button type="button" id="btnGerarListagem" class="btn-success" style="flex-grow: 1; padding: 15px; font-size: 1.2rem;">Gerar Listagem Completa</button>
                    </div>
                </section>

                <section id="output-section" class="card" style="display: none;">
                    <h2>Resultado Final</h2>
                    <h3>Listagem de Pe√ßas para Corte</h3>
                    <div class="table-responsive">
                        <table id="lista-pecas">
                            <thead>
                                <tr>
                                    <th>Nome Pe√ßa</th>
                                    <th>Qtd</th>
                                    <th>Altura</th>
                                    <th>Largura</th>
                                    <th>Espessura</th>
                                    <th>Material</th>
                                    <th>Bordas</th>
                                    <th>Cor Borda</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <h3>Lista de Ferragens Gerais e Extras</h3>
                    <div class="table-responsive">
                        <table id="lista-ferragens">
                            <thead>
                                <tr>
                                    <th>Nome Ferragem</th>
                                    <th>Qtd/Medida</th>
                                    <th>Custo Unit/M</th>
                                    <th>Custo Total</th>
                                    <th>A√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <h3>Lista de Compras</h3>
                    <div class="table-responsive">
                        <table id="lista-materiais-compra">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div id="orcamento-final">
                        <h3>Resumo do Or√ßamento</h3>
                        <p><span>Custo Total de Material:</span> <b id="orcamento-custo-total-material"></b></p>
                        <p><span>Lucro sobre Material:</span> <b id="orcamento-lucro-material"></b></p>
                        <hr style="margin: 15px 0; border-color: var(--cor-borda);" />
                        <h3 id="orcamento-total"></h3>
                    </div>

                    <div class="botoes-export botoes-acao">
                        <button id="btnSalvarProjeto" class="btn-success">üíæ Salvar Projeto Cliente</button>
                        <button id="btnExportarProducao" class="btn-secondary">Exportar PDF (Produ√ß√£o)</button>
                        <button id="btnExportarExcel" class="btn-secondary">Exportar Excel (Plano de Corte)</button>
                        <button id="btnGerarPreContrato" class="btn-success">Gerar PDF (Enviar p/ Cliente)</button>
                        <button id="btnExportarCortcloud" class="btn-warning">Exportar para Cortcloud</button>
                    </div>
                </section>
            </div>

            <!-- TELA: GERENCIAMENTO DE DADOS -->
            <div id="view-dados" class="app-view" style="display: none;">
                <section class="card" style="border-top: 4px solid var(--cor-aviso);">
                    <h2>Gerenciamento de Dados Locais</h2>
                    <p>
                        Seus dados s√£o carregados dos dados embutidos neste arquivo HTML. Ap√≥s fazer altera√ß√µes, use o bot√£o "Baixar Backup" para baixar o arquivo `dados.json` atualizado.
                        <strong>Para salvar permanentemente, voc√™ deve copiar o conte√∫do do arquivo baixado e colar de volta na se√ß√£o de dados deste HTML.</strong>
                    </p>
                    <div class="botoes-acao">
                        <button id="btnSalvarDadosJson" class="btn-success">Baixar Backup (dados.json)</button>
                        <label id="labelImportarDadosDados" class="btn btn-primary" style="cursor: pointer;">Importar (Carregar Backup)</label>
                        <input type="file" id="importarDadosInputDados" accept=".json" style="display: none;" />
                    </div>
                </section>
            </div>

            <!-- TELA: EDITAR/VISUALIZAR PROJETO CARREGADO -->
            <div id="view-editar-projeto" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2>üìã Detalhes do Projeto</h2>
                    </div>
                    <div class="view-body">
                        <!-- INFORMA√á√ïES DO PROJETO -->
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid var(--cor-primaria);">
                            <div class="form-group">
                                <label>Cliente</label>
                                <input type="text" id="editar-cliente-nome" placeholder="Nome do Cliente" disabled style="background: #f5f5f5;" />
                            </div>
                            <div class="form-group">
                                <label>Projeto</label>
                                <input type="text" id="editar-projeto-nome" placeholder="Nome do Projeto" />
                            </div>
                            <div class="form-group">
                                <label>Data de Cria√ß√£o</label>
                                <input type="text" id="editar-projeto-data" placeholder="Data" disabled style="background: #f5f5f5;" />
                            </div>
                        </div>

                        <!-- LISTAGEM DE PE√áAS PARA CORTE (Geradas do M√≥dulo) -->
                        <div style="margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>üìê Listagem de Pe√ßas para Corte</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">Base</th>
                                            <th style="padding: 12px; text-align: center;">Qtd</th>
                                            <th style="padding: 12px; text-align: center;">Altura</th>
                                            <th style="padding: 12px; text-align: center;">Largura</th>
                                            <th style="padding: 12px; text-align: center;">Espessura</th>
                                            <th style="padding: 12px; text-align: center;">Material</th>
                                            <th style="padding: 12px; text-align: center;">Bordas</th>
                                            <th style="padding: 12px; text-align: center;">Cor Borda</th>
                                            <th style="padding: 12px; text-align: center;">A√ß√£o</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editar-pecas-geradas-tbody">
                                        <tr><td colspan="9" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa gerada</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- PE√áAS UTILIZADAS -->
                        <div style="margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>ü™ë Pe√ßas Utilizadas (Adicionais)</h3>
                                <button type="button" class="btn-secondary btn-sm" onclick="window.adicionarPecaEmProjeto();">+ Adicionar Pe√ßa</button>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">Pe√ßa</th>
                                            <th style="padding: 12px; text-align: center;">Quantidade</th>
                                            <th style="padding: 12px; text-align: center;">Altura</th>
                                            <th style="padding: 12px; text-align: center;">Largura</th>
                                            <th style="padding: 12px; text-align: right;">Pre√ßo Unit.</th>
                                            <th style="padding: 12px; text-align: right;">Total</th>
                                            <th style="padding: 12px; text-align: center;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editar-pecas-tbody">
                                        <tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa adicionada ainda</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- FERRAGENS EXTRAS -->
                        <div style="margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>‚öôÔ∏è Ferragens Extras</h3>
                                <button type="button" class="btn-secondary btn-sm" onclick="window.adicionarFerragemEmProjeto();">+ Adicionar Ferragem</button>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">Ferragem</th>
                                            <th style="padding: 12px; text-align: center;">Quantidade/Medida</th>
                                            <th style="padding: 12px; text-align: right;">Pre√ßo Unit.</th>
                                            <th style="padding: 12px; text-align: right;">Total</th>
                                            <th style="padding: 12px; text-align: center;">A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editar-ferragens-tbody">
                                        <tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem adicionada ainda</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- LISTA DE FERRAGENS GERADAS -->
                        <div style="margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>üî© Lista de Ferragens Gerais e Extras</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">Nome Ferragem</th>
                                            <th style="padding: 12px; text-align: center;">Qtd/Medida</th>
                                            <th style="padding: 12px; text-align: right;">Custo Unit/M</th>
                                            <th style="padding: 12px; text-align: right;">Custo Total</th>
                                            <th style="padding: 12px; text-align: left;">Tipo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editar-ferragens-geradas-tbody">
                                        <tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem gerada</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- LISTA DE COMPRAS -->
                        <div style="margin-bottom: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3>üõí Lista de Compras (Materiais)</h3>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left;">Material</th>
                                            <th style="padding: 12px; text-align: center;">Qtd/Medida</th>
                                            <th style="padding: 12px; text-align: right;">Custo Unit</th>
                                            <th style="padding: 12px; text-align: right;">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody id="editar-lista-compras-tbody">
                                        <tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhum material para comprar</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- OR√áAMENTO TOTAL -->
                        <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Or√ßamento Total do Projeto</p>
                            <h2 style="margin: 10px 0 0 0; font-size: 2.5rem;" id="editar-orcamento-total">R$ 0,00</h2>
                        </div>
                    </div>

                    <div class="view-footer">
                        <button type="button" class="btn-secondary" onclick="window.navigateTo('view-projetos-clientes');">Voltar</button>
                        <button type="button" class="btn-primary" onclick="window.gerarRelatorioProjeto();">üìÑ Gerar Relat√≥rio Completo</button>
                        <button type="button" class="btn-success" onclick="window.salvarAlteracoesProjetoCarregado();">üíæ Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </div>

            <!-- TELA: RELAT√ìRIO COMPLETO DO PROJETO -->
            <div id="view-relatorio-projeto" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2>üìä Relat√≥rio Completo do Projeto</h2>
                    </div>
                    <div class="view-body" style="max-height: 80vh; overflow-y: auto;">
                        <!-- CABE√áALHO DO RELAT√ìRIO -->
                        <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                                <div>
                                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Cliente</p>
                                    <h3 style="margin: 5px 0 0 0;" id="rel-cliente"></h3>
                                </div>
                                <div>
                                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Projeto</p>
                                    <h3 style="margin: 5px 0 0 0;" id="rel-projeto"></h3>
                                </div>
                                <div>
                                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">Data</p>
                                    <h3 style="margin: 5px 0 0 0;" id="rel-data"></h3>
                                </div>
                            </div>
                        </div>

                        <!-- PE√áAS GERADAS (TODAS) -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px;">ü™ë Pe√ßas Geradas do M√≥dulo</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: #f0f4ff; color: #333; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Pe√ßa</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Qtd</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Altura</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Largura</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Material</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rel-pecas-geradas">
                                        <tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- PE√áAS ADICIONADAS MANUALMENTE -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px;">‚ûï Pe√ßas Adicionadas Manualmente</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: #f0f4ff; color: #333; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Pe√ßa</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Qtd</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Altura</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Largura</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Pre√ßo Unit.</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rel-pecas-manuais">
                                        <tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa adicionada</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- FERRAGENS -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px;">‚öôÔ∏è Ferragens Extras</h3>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <thead style="background: #f0f4ff; color: #333; font-weight: bold;">
                                        <tr>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Ferragem</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Qtd/Medida</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Pre√ßo Unit.</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rel-ferragens">
                                        <tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- RESUMO FINANCEIRO -->
                        <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                                <div>
                                    <p style="margin: 0; opacity: 0.9;">Pe√ßas Manuais</p>
                                    <h3 style="margin: 5px 0 0 0;" id="rel-total-pecas">R$ 0,00</h3>
                                </div>
                                <div>
                                    <p style="margin: 0; opacity: 0.9;">Ferragens</p>
                                    <h3 style="margin: 5px 0 0 0;" id="rel-total-ferragens">R$ 0,00</h3>
                                </div>
                                <div>
                                    <p style="margin: 0; opacity: 0.9; font-size: 1.2rem;">TOTAL DO PROJETO</p>
                                    <h2 style="margin: 5px 0 0 0; font-size: 2rem;" id="rel-total-geral">R$ 0,00</h2>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="view-footer">
                        <button type="button" class="btn-secondary" onclick="window.navigateTo('view-editar-projeto');">Voltar</button>
                        <button type="button" class="btn-primary" onclick="window.imprimirRelatorio();">üñ®Ô∏è Imprimir</button>
                        <button type="button" class="btn-success" onclick="window.exportarRelatorioCSV();">üì• Exportar CSV</button>
                    </div>
                </div>
            </div>

            <!-- TELA: PROJETOS SALVOS DOS CLIENTES -->
            <div id="view-projetos-clientes" class="app-view" style="display: none;">
                <section class="card">
                    <h2>üìÅ Projetos Salvos - Meus Clientes</h2>
                    <p>Visualize, carregue e gerencie todos os projetos j√° criados para seus clientes.</p>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label>Selecione um Cliente</label>
                        <select id="seletorClienteProjetos" style="width: 100%; padding: 12px;">
                            <option value="">-- Escolha um cliente --</option>
                        </select>
                    </div>

                    <div id="container-projetos-cliente" style="display: none;">
                        <h3>Projetos de <span id="nome-cliente-selecionado"></span></h3>
                        <div id="lista-projetos-cliente" class="catalogo-gerenciador" style="max-height: 500px; background: white; padding: 12px; border-radius: 10px; border: 1px solid var(--cor-borda);"></div>
                    </div>

                    <div id="aviso-nenhum-cliente" style="text-align: center; padding: 40px; color: var(--cor-texto-suave);">
                        <p style="font-size: 1.2rem; margin-bottom: 10px;">üì≠ Nenhum projeto salvo ainda</p>
                        <p>Crie um novo projeto e salve-o para um cliente para v√™-lo aqui.</p>
                    </div>
                </section>
            </div>

            <!-- TELA: EDITOR/CRIADOR DE M√ìDULO -->
            <div id="view-editor-modulo" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2 id="modal-modulo-titulo">Criar Novo M√≥dulo</h2>
                    </div>
                    <div class="view-body">
                        <p id="modal-modulo-descricao">Crie ou edite modelos completos, definindo suas pe√ßas, f√≥rmulas e as ferragens necess√°rias.</p>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr 200px; align-items: flex-start;">
                            <div style="grid-column: 1 / 3;">
                                <div class="form-grid" style="margin-top: 0; grid-template-columns: 1fr 1fr 1fr;">
                                    <div class="form-group">
                                        <label>Categoria</label>
                                        <select id="categoriaModuloSelect"></select>
                                        <input type="text" id="novaCategoriaInput" placeholder="Nova Categoria" style="display: none; margin-top: 10px;" />
                                    </div>
                                    <div class="form-group"><label>Nome do M√≥dulo</label><input type="text" id="nomeModulo" placeholder="Ex: Balc√£o 2 Portas" /></div>
                                    <div class="form-group">
                                        <label>Tipo de M√≥dulo (para as f√≥rmulas)</label>
                                        <select id="moduloTipo">
                                            <option value="reto">M√≥dulo Reto (Usa A, L, P)</option>
                                            <option value="canto">M√≥dulo de Canto L (Usa LadoA/B, ProfA/B)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Cor Borda Interna Padr√£o</label>
                                        <select id="moduloCorBordaInterna"></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Cor Borda Externa Padr√£o</label>
                                        <select id="moduloCorBordaExterna"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Imagem do M√≥dulo (Opcional)</label>
                                <img id="imagemModuloPreview" class="item-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" /><input type="file" class="imagem-input" style="display: none;" accept="image/*" />
                            </div>
                        </div>

                        <h3>Pe√ßas do M√≥dulo</h3>
                        <div id="pecas-container"></div>
                        <div class="botoes-acao">
                            <button type="button" id="btnAdicionarPeca" class="btn-primary">Adicionar Pe√ßa</button>
                            <select id="pecas-predefinidas">
                                <option value="">-- Ou adicione uma pe√ßa pr√©-definida --</option>
                            </select>
                            <button type="button" id="btnAbrirModalRipado" class="btn-secondary">Gerar Painel Ripado</button>
                        </div>

                        <h3>Corredi√ßas do M√≥dulo</h3>
                        <div class="botoes-acao">
                            <select id="moduloCorredicaSelect" style="flex: 2;">
                                <option value="">-- Escolha uma corredi√ßa --</option>
                            </select>
                            <input type="text" id="moduloCorredicaQtd" placeholder="Qtd (ex: 2 ou NumGavetas)" style="flex: 1;" />
                            <input type="text" id="moduloCorredicaMedida" placeholder="Profundidade (ex: P-50)" style="flex: 1;" />
                            <button type="button" id="btnAdicionarCorredicaModulo" class="btn-primary">Adicionar Corredi√ßa</button>
                        </div>
                        <small class="formula-helper" style="margin-top: 5px;">
                            Use 'A' (altura), 'L' (largura), 'P' (profundidade), 'NumGavetas' (qtd de frentes de gaveta no m√≥dulo), 'LadoA', 'LadoB', 'ProfA', 'ProfB' e vari√°veis de folga nas f√≥rmulas, como MedidaCorredica.
                        </small>
                        <div id="corredicas-modulo-container" class="catalogo-gerenciador"></div>

                        <h3>Ferragens Gerais do M√≥dulo</h3>
                        <div class="botoes-acao">
                            <select id="moduloFerragemSelect">
                                <option value="">-- Escolha uma ferragem do cat√°logo --</option>
                            </select>
                            <input type="text" id="moduloFerragemValor" placeholder="Qtd ou Medida" /><button type="button" id="btnAdicionarFerragemModulo" class="btn-primary">Adicionar Ferragem</button>
                        </div>
                        <div id="ferragens-modulo-container" class="catalogo-gerenciador"></div>
                    </div>
                    <div class="view-footer"><button type="button" class="btn-secondary btn-voltar">Voltar</button><button type="button" id="btnSalvarModulo" class="btn-success">Salvar M√≥dulo</button></div>
                </div>
            </div>

            <!-- TELA: GERENCIAMENTO DE M√ìDULOS -->
            <div id="view-gerenciar-modulos" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2>Gerenciar M√≥dulos Salvos</h2>
                        <input type="search" id="filtroModulos" class="filtro-view" placeholder="Filtrar por nome ou categoria..." />
                    </div>
                    <div class="view-body">
                        <div class="botoes-acao" style="justify-content: flex-start; margin-top: 0; margin-bottom: 20px;">
                            <button id="btnAbrirEditorModulo" class="btn-primary">Criar Novo M√≥dulo</button>
                        </div>
                        <div id="lista-modulos-salvos" class="catalogo-gerenciador" style="max-height: none;"></div>
                    </div>
                    <div class="view-footer"><button class="btn-secondary btn-voltar">Voltar</button></div>
                </div>
            </div>

            <!-- TELA: GERENCIAR CAT√ÅLOGOS -->
            <div id="view-gerenciar-catalogos" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2>Gerenciar Cat√°logos</h2>
                        <input type="search" id="filtroCatalogo" class="filtro-view" placeholder="Filtrar itens do cat√°logo..." />
                    </div>
                    <div class="view-body">
                        <h3>Cat√°logo de Materiais</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div>
                                <h4>Cores de MDF</h4>
                                <div id="listaCoresMDF" class="catalogo-gerenciador"></div>
                            </div>
                            <div>
                                <h4>Cores de Fita de Borda</h4>
                                <div id="listaCoresBorda" class="catalogo-gerenciador"></div>
                            </div>
                        </div>

                        <fieldset style="border: 1px solid var(--cor-borda); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <legend id="material-form-titulo" style="font-weight: 500; padding: 0 10px;">Adicionar Novo Material</legend>
                            <div class="form-grid" style="grid-template-columns: 1fr 2fr 150px; align-items: flex-end;">
                                <div class="form-group">
                                    <label>Tipo de Material</label>
                                    <select id="novoMaterialTipo">
                                        <option value="mdf">MDF</option>
                                        <option value="borda">Fita de Borda</option>
                                    </select>
                                </div>
                                <div class="form-group"><label>Nome</label><input type="text" id="novoMaterialNome" placeholder="Ex: Branco Diamante" /></div>
                                <div class="form-group">
                                    <label>Imagem</label
                                    ><img id="novoMaterialPreview" class="item-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" /><input type="file" class="imagem-input" style="display: none;" accept="image/*" />
                                </div>
                            </div>
                            <div id="campos-preco-mdf" class="form-grid" style="margin-top: 5px; grid-template-columns: 1fr 1fr;">
                                <div class="form-group"><label>Pre√ßo da Chapa (R$)</label><input type="number" id="novoMaterialPrecoChapa" placeholder="250.00" step="0.01" /></div>
                                <div class="form-group"><label>Pre√ßo Calculado (R$/m¬≤)</label><input type="number" id="novoMaterialPrecoCalculado" readonly /></div>
                            </div>
                            <div id="campos-preco-borda" class="form-grid" style="margin-top: 5px; grid-template-columns: 1fr 1fr 1fr; display: none;">
                                <div class="form-group">
                                    <label>Pre√ßo do Rolo (R$) <small>(Opcional)</small></label><input type="number" id="novoMaterialPrecoRoloBorda" placeholder="50.00" step="0.01" />
                                </div>
                                <div class="form-group">
                                    <label>Metragem do Rolo (m) <small>(Opcional)</small></label><input type="number" id="novoMaterialMetragemRoloBorda" placeholder="20" step="1" />
                                </div>
                                <div class="form-group"><label>Pre√ßo Final por Metro (R$/m)</label><input type="number" id="novoMaterialPrecoFinalBorda" placeholder="2.50" step="0.01" /></div>
                            </div>

                            <div class="botoes-acao" style="margin-top: 10px; justify-content: flex-start;">
                                <button id="btnAddMaterial" class="btn-primary">Adicionar ao Cat√°logo</button>
                                <button id="btnCancelarEdicaoMaterial" class="btn-secondary" style="display: none;">Cancelar Edi√ß√£o</button>
                            </div>
                        </fieldset>

                        <hr style="margin: 25px 0; border-color: var(--cor-borda);" />

                        <h3>Cat√°logo de Perfis de Puxador</h3>
                        <div id="listaPerfisPuxador" class="catalogo-gerenciador"></div>
                        <fieldset style="border: 1px solid var(--cor-borda); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <legend id="perfil-form-titulo" style="font-weight: 500; padding: 0 10px;">Adicionar Novo Perfil</legend>
                            <div class="form-grid" style="grid-template-columns: 1fr 150px; align-items: flex-end;">
                                <div class="form-group"><label>Nome do Perfil</label><input type="text" id="novoPerfilNome" placeholder="Ex: Perfil Gola Alum√≠nio Bronze" /></div>
                                <div class="form-group">
                                    <label>Imagem</label><img id="novoPerfilPreview" class="item-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" /><input type="file" class="imagem-input" style="display: none;" accept="image/*" />
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: 5px; grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label>Pre√ßo da Barra (R$)</label>
                                    <input type="number" id="novoPerfilPrecoBarra" placeholder="90.00" step="0.01" />
                                </div>
                                <div class="form-group">
                                    <label>Metragem da Barra (m)</label>
                                    <input type="number" id="novoPerfilMetragemBarra" placeholder="3" step="0.01" />
                                </div>
                                <div class="form-group">
                                    <label>Pre√ßo Calculado (R$/m)</label>
                                    <input type="number" id="novoPerfilPrecoMetro" readonly />
                                </div>
                            </div>
                            <div class="botoes-acao" style="margin-top: 10px; justify-content: flex-start;">
                                <button id="btnSalvarPerfil" class="btn-primary">Adicionar</button>
                                <button id="btnCancelarEdicaoPerfil" class="btn-secondary" style="display: none;">Cancelar</button>
                            </div>
                        </fieldset>

                        <hr style="margin: 25px 0; border-color: var(--cor-borda);" />

                        <h3>Cat√°logo de Ferragens (Geral)</h3>
                        <div id="listaFerragensCatalogo" class="catalogo-gerenciador"></div>
                        <fieldset style="border: 1px solid var(--cor-borda); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <legend id="ferragem-form-titulo" style="font-weight: 500; padding: 0 10px;">Adicionar Nova Ferragem</legend>
                            <div class="form-grid" style="grid-template-columns: 1fr 150px; align-items: flex-end;">
                                <div class="form-group"><label>Nome</label><input type="text" id="novaFerragemNome" placeholder="Ex: Dobradi√ßa Reta 35mm" /></div>
                                <div class="form-group">
                                    <label>Imagem</label><img id="novaFerragemPreview" class="item-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" /><input type="file" class="imagem-input" style="display: none;" accept="image/*" />
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: 5px; grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label>Tipo de Ferragem</label>
                                    <select id="novaFerragemTipo">
                                        <option value="geral">Geral</option>
                                        <option value="corredica">Corredi√ßa</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Unidade</label>
                                    <select id="novaFerragemUnidade">
                                        <option value="UN">Unidade (UN)</option>
                                        <option value="M">Metro (M)</option>
                                        <option value="PAR">Par (PAR)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label id="labelPrecoFinalFerragem">Pre√ßo (R$)</label>
                                    <input type="number" id="novaFerragemPreco" placeholder="4.50" step="0.01" />
                                </div>
                            </div>
                            <div id="campos-preco-barra-ferragem" style="display: none;">
                                <div class="form-grid" style="margin-top: 5px; grid-template-columns: 1fr 1fr;">
                                    <div class="form-group">
                                        <label>Pre√ßo da Barra/Rolo (R$) <small>(Opcional)</small></label>
                                        <input type="number" id="novaFerragemPrecoBarra" placeholder="90.00" step="0.01" />
                                    </div>
                                    <div class="form-group">
                                        <label>Metragem da Barra/Rolo (m) <small>(Opcional)</small></label>
                                        <input type="number" id="novaFerragemMetragemBarra" placeholder="3" step="0.01" />
                                    </div>
                                </div>
                            </div>
                            <div class="botoes-acao" style="margin-top: 10px; justify-content: flex-start;">
                                <button id="btnSalvarFerragem" class="btn-primary">Adicionar</button>
                                <button id="btnCancelarEdicaoFerragem" class="btn-secondary" style="display: none;">Cancelar</button>
                            </div>
                        </fieldset>

                        <hr style="margin: 25px 0; border-color: var(--cor-borda);" />

                        <h3>Cat√°logo de Pe√ßas Padr√£o</h3>
                        <div id="listaPecasPredefinidas" class="catalogo-gerenciador"></div>
                        <fieldset id="nova-peca-form-wrapper" style="border: 1px solid var(--cor-borda); border-radius: 8px; padding: 15px; margin-top: 20px;">
                            <legend id="peca-form-titulo" style="font-weight: 500; padding: 0 10px;">Nova Pe√ßa Padr√£o</legend>
                            <div class="form-grid">
                                <div class="form-group"><label>Nome</label><input type="text" id="novaPecaNome" placeholder="Ex: Divis√≥ria Vertical" /></div>
                                <div class="form-group"><label>Qtd (ou F√≥rmula)</label><input type="text" id="novaPecaQtd" value="1" /></div>
                                <div class="form-group"><label>F√≥rmula Altura</label><input type="text" id="novaPecaAltura" placeholder="Ex: A - 30" /></div>
                                <div class="form-group"><label>F√≥rmula Largura</label><input type="text" id="novaPecaLargura" placeholder="Ex: MedidaCorredica - 10" /></div>
                                <div class="form-group">
                                    <label>Tipo de Material</label>
                                    <select id="novaPecaTipoMaterial">
                                        <option value="interna">Interno</option>
                                        <option value="externa">Externo</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Tipo de Borda</label>
                                    <select id="novaPecaTipoBorda">
                                        <option value="interna">Interna</option>
                                        <option value="externa">Externa</option>
                                    </select>
                                </div>
                            </div>
                            <div class="botoes-acao" style="margin-top: 10px; justify-content: flex-start;">
                                <button id="btnSalvarPecaCatalogo" class="btn-primary">Adicionar Pe√ßa ao Cat√°logo</button>
                                <button id="btnCancelarEdicaoPeca" class="btn-secondary" style="display: none;">Cancelar Edi√ß√£o</button>
                            </div>
                        </fieldset>
                    </div>
                    <div class="view-footer"><button class="btn-secondary btn-voltar">Voltar</button></div>
                </div>
            </div>

            <!-- TELA: VISUALIZAR CAT√ÅLOGO COMPLETO -->
            <div id="view-visualizar-catalogo" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2>Cat√°logo Completo de Materiais e Pe√ßas</h2>
                    </div>
                    <div class="view-body">
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                            <div>
                                <h3>Cat√°logo de Materiais (MDF)</h3>
                                <div id="lista-completa-mdf"></div>
                            </div>
                            <div>
                                <h3>Cat√°logo de Fitas de Borda</h3>
                                <div id="lista-completa-borda"></div>
                            </div>
                            <div>
                                <h3>Cat√°logo de Perfis de Puxador</h3>
                                <div id="lista-completa-perfis"></div>
                            </div>
                            <div>
                                <h3>Cat√°logo de Ferragens</h3>
                                <div id="lista-completa-ferragens"></div>
                            </div>
                            <div>
                                <h3>Cat√°logo de Pe√ßas Padr√£o</h3>
                                <div id="lista-completa-pecas"></div>
                            </div>
                        </div>
                    </div>
                    <div class="view-footer"><button class="btn-secondary btn-voltar">Voltar</button></div>
                </div>
            </div>

            <!-- TELA: CONFIGURA√á√ïES -->
            <div id="view-configuracoes" class="app-view" style="display: none;">
                <div class="card">
                    <div class="view-header">
                        <h2>Configura√ß√µes Gerais de C√°lculo</h2>
                    </div>
                    <div class="view-body">
                        <p>Ajuste os valores padr√£o para espessuras, descontos e dimens√µes. Alterar as dimens√µes da chapa ir√° recalcular os pre√ßos por m¬≤ de todos os MDFs no seu cat√°logo.</p>
                        <h3>Espessuras (mm)</h3>
                        <div class="form-grid">
                            <div class="form-group"><label>Interna</label><input type="number" id="espInterna" /></div>
                            <div class="form-group"><label>Externa</label><input type="number" id="espExterna" /></div>
                            <div class="form-group"><label>Fundo</label><input type="number" id="espFundo" /></div>
                        </div>
                        <h3>Descontos e Folgas (mm)</h3>
                        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="form-group"><label>Folga Altura Portas</label><input type="number" id="folgaPortaAltura" /></div>
                            <div class="form-group"><label>Folga Largura Portas</label><input type="number" id="folgaPortaLargura" /></div>
                            <div class="form-group"><label>Recuo Fundo do Arm√°rio</label><input type="number" id="descFundoArmario" /></div>
                            <div class="form-group"><label>Folga p/ Corredi√ßas (Lateral)</label><input type="number" id="folgaGaveta" /></div>
                            <div class="form-group"><label>Folga Corredi√ßa (Frente)</label><input type="number" id="folgaCorredicaFrente" /></div>
                            <div class="form-group"><label>Folga Corredi√ßa (Fundo)</label><input type="number" id="folgaCorredicaFundo" /></div>
                            <div class="form-group"><label>Acr√©scimo para Puxador Cava</label><input type="number" id="acrescimoPuxadorCava" /></div>
                            <div class="form-group">
                                <label>Medidas Padr√£o de Corredi√ßas (mm)</label>
                                <input type="text" id="medidasCorredicas" placeholder="250,300,350,400,450..." />
                                <small class="formula-helper">Separadas por v√≠rgula.</small>
                            </div>
                            <div class="form-group">
                                <label>Desconto Altura Base Gav (mm)</label>
                                <input type="number" id="descAlturaBaseGav" value="25" />
                            </div>
                            <div class="form-group">
                                <label>Desconto Altura Lateral Gav (mm)</label>
                                <input type="number" id="descAlturaLateralGav" value="25" />
                            </div>
                            <div class="form-group"><label>Desconto Altura para Perfil</label><input type="number" id="descontoPerfilAltura" /></div>
                            <div class="form-group"><label>Desconto Largura para Perfil</label><input type="number" id="descontoPerfilLargura" /></div>
                        </div>

                        <h3>Margens de Lucro e Custos</h3>
                        <div class="form-grid">
                            <div class="form-group"><label>Margem de Lucro sobre Materiais (%)</label><input type="number" id="margemLucroMaterial" step="1" /></div>
                            <div class="form-group"><label>Custo Fita Borda (R$/m) - Padr√£o</label><input type="number" id="custoBorda" step="0.01" /></div>
                            <div class="form-group"><label>Comprimento da Barra de Perfil (m) - Padr√£o</label><input type="number" id="barraPerfilComprimento" step="0.01" /></div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Puxador Externo Padr√£o (para c√°lculo autom√°tico)</label>
                                <select id="puxadorExternoPadrao"></select>
                                <small class="formula-helper">Selecione um item do seu cat√°logo de ferragens. Ele ser√° adicionado automaticamente com base no n¬∫ de portas/frentes de m√≥dulos com "Puxador Externo".</small>
                            </div>
                        </div>

                        <h3>Dimens√µes da Chapa (mm)</h3>
                        <div class="form-grid">
                            <div class="form-group"><label>Altura da Chapa</label><input type="number" id="chapaAltura" /></div>
                            <div class="form-group"><label>Largura da Chapa</label><input type="number" id="chapaLargura" /></div>
                        </div>

                        <hr style="margin: 30px 0; border-color: var(--cor-borda);" />

                        <h3>üìä Gerenciamento de Dados e Backup</h3>
                        <p style="color: var(--cor-texto-suave);">Baixe seus dados em formato JSON ou importe um backup anterior.</p>
                        
                        <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h4 style="margin-top: 0;">üöÄ Carregar dados.json Automaticamente</h4>
                            <p style="font-size: 0.9rem; margin-bottom: 10px;">Coloque o arquivo <strong>dados.json</strong> na mesma pasta que <strong>index.html</strong>, depois recarregue a p√°gina (F5).</p>
                            <p style="font-size: 0.85rem; color: var(--cor-texto-suave);">Ou teste outro caminho:</p>
                            <div style="display: flex; gap: 10px; align-items: flex-end;">
                                <input type="text" id="caminhoCustomizadoDados" placeholder="Ex: dados.json ou caminho/dados.json" style="flex: 1; padding: 10px; border: 1px solid var(--cor-borda); border-radius: 5px;" />
                                <button type="button" class="btn-primary" onclick="window.carregarDadosCustomizado();">Carregar</button>
                            </div>
                        </div>
                        
                        <div class="botoes-acao">
                            <button id="btnBaixarDadosJSON" class="btn-primary">üì• Baixar dados.json</button>
                            <button id="btnBaixarDadosJS" class="btn-primary">üì• Baixar dados.js</button>
                            <label id="labelImportarDados" class="btn btn-success" style="cursor: pointer;">üìÇ Importar Backup</label>
                            <input type="file" id="importarDadosInput" accept=".json" style="display: none;" />
                            <button id="btnVerDadosJSON" class="btn-secondary">üëÅÔ∏è Ver JSON</button>
                        </div>
                    </div>
                    <div class="view-footer"><button id="btnSalvarConfig" class="btn-success">Salvar e Voltar</button></div>
                </div>
            </div>

            <!-- MODAL PARA VER DADOS JSON -->
            <div id="modal-visualizar-json" class="modal-overlay">
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                    <div class="modal-header">
                        <h2>üìã Dados JSON do Sistema</h2>
                        <button class="modal-close" data-modal-id="modal-visualizar-json">√ó</button>
                    </div>
                    <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                        <textarea id="json-view" style="width: 100%; height: 100%; min-height: 400px; padding: 10px; border: 1px solid var(--cor-borda); border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.85rem;"></textarea>
                    </div>
                    <div style="padding: 15px; border-top: 1px solid var(--cor-borda); display: flex; gap: 10px;">
                        <button type="button" class="btn-secondary" onclick="document.querySelector('[data-modal-id=\"modal-visualizar-json\"]').click();">Fechar</button>
                        <button type="button" class="btn-primary" onclick="window.copiarJsonParaClipboard();">üìã Copiar para Clipboard</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- MODAIS -->

        <!-- MODAL DE SELE√á√ÉO DE M√ìDULO -->
        <div id="modal-selecionar-modulo" class="modal-overlay">
            <div class="modal-content" style="max-width: 90vw; max-height: 90vh;">
                <div class="modal-header">
                    <h2>Selecione para Personalizar</h2>
                    <input type="search" id="filtroSelecaoModulo" class="filtro-modal" placeholder="Busque pelo nome do M√≥dulo/Parte Avulsa..." />
                    <button class="modal-close" data-modal-id="modal-selecionar-modulo">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="grid-selecao-modulos">
                        <!-- A grade ser√° populada via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL GERADOR DE PAINEL RIPADO -->
        <div id="modal-ripado" class="modal-overlay">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Gerador de Painel Ripado</h2>
                    <button class="modal-close" data-modal-id="modal-ripado">√ó</button>
                </div>
                <div class="modal-body">
                    <p>Informe as medidas das ripas para gerar as pe√ßas automaticamente.</p>
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group"><label>Largura de cada Ripa (mm)</label><input type="number" id="ripadoLarguraRipa" value="50" /></div>
                        <div class="form-group"><label>Espa√ßamento entre Ripas (mm)</label><input type="number" id="ripadoEspacamento" value="20" /></div>
                    </div>
                    <div class="form-group" style="margin-top: 20px;">
                        <label style="flex-direction: row; align-items: center; gap: 10px;"><input type="checkbox" id="ripadoIncluirFundo" checked /> Incluir Painel de Fundo?</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary modal-close" data-modal-id="modal-ripado">Cancelar</button>
                    <button id="btnGerarRipado" class="btn-success">Gerar e Adicionar Pe√ßas</button>
                </div>
            </div>
        </div>

        <!-- TEMPLATES -->
        <template id="template-peca">
            <div class="peca-item-wrapper" style="background-color: var(--cor-fundo); border: 1px solid var(--cor-borda); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div class="peca-item">
                    <div class="form-group"><label>Nome da Pe√ßa</label><input type="text" class="peca-nome" placeholder="Ex: Prateleira" /></div>
                    <div class="form-group"><label>Qtd (F√≥rmula)</label><input type="text" class="peca-qtd" value="1" placeholder="Ex: L / 70" /></div>
                    <div class="form-group">
                        <label>F√≥rmula Altura</label><input type="text" class="peca-altura" placeholder="Ex: A - 10" />
                        <small class="formula-helper formula-helper-altura">Vari√°veis: A, L, P, LadoA, LadoB, ProfA, ProfB, MedidaCorredica, EspInterna, EspExterna, DescAlturaBaseGav, DescAlturaLateralGav</small>
                    </div>
                    <div class="form-group">
                        <label>F√≥rmula Largura</label><input type="text" class="peca-largura" placeholder="Ex: L - 20" />
                        <small class="formula-helper formula-helper-largura">
                            Vari√°veis: A, L, P, LadoA, LadoB, ProfA, ProfB, MedidaCorredica, EspInterna, EspExterna, FolgaPorta..., FolgaCorredica..., DescFundoArmario, AjustePuxador..., DescontoPerfil..., DescAlturaBaseGav,
                            DescAlturaLateralGav
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Espessura (mm)</label>
                        <input type="text" class="peca-espessura" placeholder="Padr√£o do material" />
                        <small class="formula-helper">Deixe em branco para usar a espessura padr√£o (Interna/Externa/Fundo).</small>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Material</label>
                        <select class="peca-material-tipo">
                            <option value="interna">Usar Material Interno</option>
                            <option value="externa">Usar Material Externo</option>
                            <option value="fundo">Usar Material de Fundo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Borda</label>
                        <select class="peca-borda-tipo">
                            <option value="interna">Interna</option>
                            <option value="externa">Externa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lados com Borda</label>
                        <div class="checkbox-group" style="display: flex; gap: 8px; align-items: center; justify-content: space-around; padding-top: 5px;">
                            <label>A1<input type="checkbox" class="peca-borda-a1" /></label><label>A2<input type="checkbox" class="peca-borda-a2" /></label><label>L1<input type="checkbox" class="peca-borda-l1" /></label>
                            <label>L2<input type="checkbox" class="peca-borda-l2" /></label>
                        </div>
                    </div>
                    <div class="form-group"><button type="button" class="btn-danger btn-remover-peca">Remover Pe√ßa</button></div>
                </div>
                <div class="ferragens-associadas-section" style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--cor-borda);">
                    <h4 style="margin-top: 0;">Ferragens Associadas a esta Pe√ßa</h4>
                    <div class="botoes-acao" style="margin-top: 5px;">
                        <select class="peca-ferragem-select" style="flex: 2;">
                            <option value="">-- Cat√°logo de Ferragens --</option>
                        </select>
                        <input type="text" class="peca-ferragem-qtd" placeholder="Qtd (ex: 2 ou QTD*2)" style="flex: 1;" />
                        <input type="text" class="peca-ferragem-medida" placeholder="Profundidade (ex: P-50)" style="flex: 1; display: none;" />
                        <button type="button" class="btn-primary btn-sm btn-add-ferragem-assoc">Adicionar</button>
                    </div>
                    <small class="formula-helper" style="margin-top: 5px;">
                        Use 'A' (altura), 'L' (largura), 'QTD' (qtd da pe√ßa), 'P' (profundidade do m√≥dulo), 'LadoA', 'LadoB', 'ProfA', 'ProfB', MedidaCorredica, DescAlturaBaseGav, DescAlturaLateralGav nas f√≥rmulas.
                    </small>
                    <div class="ferragens-associadas-container catalogo-gerenciador" style="max-height: 100px;"></div>
                </div>
            </div>
        </template>

        <template id="template-ferragem-assoc">
            <div class="catalogo-item"><span></span><button class="btn-danger btn-sm">X</button></div>
        </template>

        <template id="template-ferragem-modulo">
            <div class="catalogo-item"><span></span><button class="btn-danger btn-sm">X</button></div>
        </template>

        <template id="template-corredica-modulo">
            <div class="catalogo-item"><span></span><button class="btn-danger btn-sm">X</button></div>
        </template>

        <!-- ... (FIM DOS TEMPLATES) ... -->
        
        <!-- 
            ******************************************************************
            ** COLE O CONTE√öDO DO SEU ARQUIVO 'dados.json' AQUI DENTRO      **
            ...
        -->
        <script type="application/json" id="dados-json">
        
        </script>

        <!-- Carrega arquivo de cat√°logo (gerado automaticamente) -->
        <script src="dados.js"></script>
        <!-- Carrega arquivo de clientes (gerado automaticamente) -->
        <script src="dados-clientes.js"></script>

       
        <!-- SCRIPT PRINCIPAL DA APLICA√á√ÉO -->
        <script>
            async function inicializarApp() {
                // Aguarda mais tempo para garantir que os scripts de dados foram carregados
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // --- ESTADO DA APLICA√á√ÉO ---
                let AppData = {};
                window.AppData = AppData; // Make AppData globally accessible
                let projetoAtual = { modulos: [], ferragensExtras: [] };
                let listaPecasGerada = [];
                let listaFerragensGerada = [];
                let orcamentoFinalData = {};
                let imagemModuloUrl = null;
                let editingHardwareKey = null;
                let editingMaterialKey = null;
                let editingMaterialType = null;
                let editingProfileKey = null;
                let editingPecaKey = null;
                let editingModuleId = null;
                let currentImageUrl = { material: null, hardware: null, profile: null };
                let ultimoNomeCliente = "";
                let ultimoNomeAmbiente = "";

                // --- CHAVE DA API DE IMAGEM ---
                const IMG_API_KEY = "ce8ec3f885a1061c0b6078e34cb34cca";

                // --- FUN√á√ïES UTILIT√ÅRIAS ---
                const getEl = (id) => document.getElementById(id);

                const showToast = (message, type = "success") => {
                    const toast = document.createElement("div");
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    getEl("toast-container").appendChild(toast);
                    setTimeout(() => toast.classList.add("show"), 10);
                    setTimeout(() => {
                        toast.classList.remove("show");
                        toast.addEventListener("transitionend", () => toast.remove());
                    }, 4000);
                };

                const evaluateFormula = (expression) => {
                    try {
                        const formula = String(expression).trim();
                        if (formula === "") return 0;
                        const finalValue = new Function(`return ${formula}`)();
                        if (!isFinite(finalValue) || isNaN(finalValue)) {
                            console.warn(`Resultado inv√°lido: '${finalValue}'. F√≥rmula original: "${expression}"`);
                            return 0;
                        }
                        return finalValue;
                    } catch (e) {
                        console.error(`Erro ao avaliar a f√≥rmula: "${expression}"`, e);
                        return 0;
                    }
                };

                const createKeyFromName = (name) =>
                    name
                        .toLowerCase()
                        .replace(/\s+/g, "-")
                        .replace(/[^\w-]/g, "");

                // --- FUN√á√ÉO DE UPLOAD DE IMAGEM ---
                const uploadImage = async (file) => {
                    const formData = new FormData();
                    formData.append("image", file);
                    showToast("Enviando imagem...", "warning");

                    try {
                        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_API_KEY}`, {
                            method: "POST",
                            body: formData,
                        });
                        const data = await response.json();
                        if (data.success) {
                            showToast("Imagem enviada com sucesso!", "success");
                            return data.data.url;
                        } else {
                            throw new Error(data.error.message || "Erro desconhecido ao enviar.");
                        }
                    } catch (error) {
                        console.error("Erro no Upload da Imagem:", error);
                        showToast(`Erro no upload: ${error.message}`, "error");
                        return null;
                    }
                };

                // --- SELETORES DE ELEMENTOS COMUNS ---
                const pecasContainer = getEl("pecas-container");
                const displayModuloSelecionado = getEl("displayModuloSelecionado");
                const outputSection = getEl("output-section");
                const listaPecasTbody = getEl("lista-pecas").querySelector("tbody");
                const listaFerragensTbody = getEl("lista-ferragens").querySelector("tbody");
                const resumoContainer = getEl("resumo-projeto-container");
                const listaResumo = getEl("lista-resumo-projeto");

                // --- L√ìGICA DE NAVEGA√á√ÉO ENTRE TELAS ---
                const navigateTo = (viewId) => {
                    document.querySelectorAll(".app-view").forEach((view) => {
                        view.style.display = "none";
                    });
                    const targetView = getEl(viewId);
                    if (targetView) {
                        targetView.style.display = "flex";
                        window.scrollTo({ top: 0, behavior: "smooth" });
                    }
                };
                
                // Torna navigateTo acess√≠vel globalmente
                window.navigateTo = navigateTo;

                // --- GERENCIAMENTO DE DADOS ---

                // BANCO DE DADOS DE CLIENTES (localStorage)
                let BancoClientes = {};

                const carregarBancoClientes = () => {
                    console.log("Verificando banco de clientes dispon√≠vel:", {
                        "window.DadosClientes": !!window.DadosClientes,
                        "window.DadosClientes conte√∫do": window.DadosClientes
                    });

                    // Tenta carregar de arquivo externo primeiro
                    if (window.DadosClientes && typeof window.DadosClientes === 'object' && Object.keys(window.DadosClientes).length > 0) {
                        BancoClientes = JSON.parse(JSON.stringify(window.DadosClientes));
                        console.log("‚úÖ Banco de clientes carregado de arquivo externo (dados-clientes.js)");
                        return;
                    }

                    // Depois tenta localStorage
                    const banco = localStorage.getItem("marcenaria_pro_clientes");
                    if (banco) {
                        try {
                            BancoClientes = JSON.parse(banco);
                            console.log("‚úÖ Banco de clientes carregado do localStorage:", BancoClientes);
                        } catch (e) {
                            console.error("Erro ao carregar banco de clientes:", e);
                            BancoClientes = {};
                        }
                    } else {
                        console.log("‚ùå Nenhum banco de clientes encontrado. Iniciando vazio.");
                        BancoClientes = {};
                    }
                };

                const salvarBancoClientes = () => {
                    try {
                        localStorage.setItem("marcenaria_pro_clientes", JSON.stringify(BancoClientes));
                        console.log("Banco de clientes salvo com sucesso.");
                        // Exportar automaticamente para JSON
                        exportarBancoClientesJSON();
                        // Exportar tamb√©m como arquivo JS
                        exportarBancoClientesJS();
                    } catch (e) {
                        console.error("Erro ao salvar banco de clientes:", e);
                    }
                };

                // Fun√ß√£o para exportar todo o banco de clientes em JSON
                const exportarBancoClientesJSON = () => {
                    try {
                        const dadosFormatados = JSON.stringify(BancoClientes, null, 4);
                        const blob = new Blob([dadosFormatados], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.style.display = "none";
                        a.href = url;
                        a.download = `dados-clientes.json`; // Sempre o mesmo nome para sobrescrever
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log("Banco de clientes exportado como JSON!");
                    } catch (e) {
                        console.error("Erro ao exportar banco de clientes em JSON:", e);
                    }
                };

                // Fun√ß√£o para exportar todo o banco de clientes como arquivo JS
                const exportarBancoClientesJS = () => {
                    try {
                        const conteudoJS = `// ‚ö†Ô∏è IMPORTANTE: Este arquivo √© gerado automaticamente pelo sistema\n// N√ÉO edite manualmente - ele ser√° sobrescrito toda vez que voc√™ salvar um projeto\n\nwindow.DadosClientes = ${JSON.stringify(BancoClientes, null, 2)};`;
                        const blob = new Blob([conteudoJS], { type: "application/javascript" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.style.display = "none";
                        a.href = url;
                        a.download = `dados-clientes.js`; // Sempre o mesmo nome para sobrescrever
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log("Banco de clientes exportado como arquivo JS!");
                    } catch (e) {
                        console.error("Erro ao exportar banco de clientes em JS:", e);
                    }
                };

                // Salvar projeto de um cliente
                const salvarProjetoCliente = (nomeCliente, nomeAmbiente, orcamento) => {
                    const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                    const projetoId = `proj-${Date.now()}`;

                    if (!BancoClientes[clienteId]) {
                        BancoClientes[clienteId] = {
                            id: clienteId,
                            nome: nomeCliente,
                            dataCadastro: new Date().toISOString().split('T')[0],
                            projetos: []
                        };
                    }

                    const novoProjeto = {
                        id: projetoId,
                        nome: nomeAmbiente || "Projeto sem nome",
                        nomeCliente: nomeCliente,
                        data: new Date().toISOString(),
                        modulos: projetoAtual.modulos || [],
                        ferragensExtras: projetoAtual.ferragensExtras || [],
                        listaPecas: listaPecasGerada || [],
                        listaFerragens: listaFerragensGerada || [],
                        orcamento: orcamento || orcamentoFinalData,
                        status: "or√ßamento"
                    };

                    BancoClientes[clienteId].projetos.push(novoProjeto);
                    salvarBancoClientes();
                    showToast(`Projeto "${nomeAmbiente}" salvo para ${nomeCliente}!`, "success");
                    return projetoId;
                };

                // Listar projetos de um cliente
                const listarProjetosCliente = (nomeCliente) => {
                    const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                    return BancoClientes[clienteId]?.projetos || [];
                };

                // Carregar projeto espec√≠fico
                const carregarProjetoCliente = (nomeCliente, projetoId) => {
                    const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                    const projeto = BancoClientes[clienteId]?.projetos.find(p => p.id === projetoId);
                    if (projeto) {
                        projetoAtual = {
                            modulos: projeto.modulos || [],
                            ferragensExtras: projeto.ferragensExtras || []
                        };
                        console.log("Projeto carregado:", projeto);
                        showToast(`Projeto "${projeto.nome}" carregado!`, "success");
                        return projeto;
                    }
                    return null;
                };

                // Deletar projeto
                const deletarProjetoCliente = (nomeCliente, projetoId) => {
                    const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                    if (BancoClientes[clienteId]) {
                        BancoClientes[clienteId].projetos = BancoClientes[clienteId].projetos.filter(p => p.id !== projetoId);
                        salvarBancoClientes(); // J√° faz export autom√°tico
                        showToast("Projeto deletado e banco atualizado!", "success");
                    }
                };

                // Exportar todos os projetos de um cliente
                const exportarProjetosCliente = (nomeCliente) => {
                    const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                    const cliente = BancoClientes[clienteId];
                    if (!cliente || cliente.projetos.length === 0) {
                        showToast("Nenhum projeto encontrado para este cliente.", "warning");
                        return;
                    }
                    
                    const dadosFormatados = JSON.stringify(cliente, null, 4);
                    const blob = new Blob([dadosFormatados], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none";
                    a.href = url;
                    a.download = `projetos-${nomeCliente}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("Projetos exportados com sucesso!", "success");
                };

                // Atualizar seletor de clientes
                const atualizarSeletorClientes = () => {
                    const seletor = getEl("seletorClienteProjetos");
                    seletor.innerHTML = '<option value="">-- Escolha um cliente --</option>';
                    
                    Object.keys(BancoClientes).forEach(clienteId => {
                        const cliente = BancoClientes[clienteId];
                        if (cliente.projetos && cliente.projetos.length > 0) {
                            const option = document.createElement("option");
                            option.value = clienteId;
                            option.textContent = `${cliente.nome} (${cliente.projetos.length} projetos)`;
                            seletor.appendChild(option);
                        }
                    });
                    
                    if (Object.keys(BancoClientes).length === 0) {
                        getEl("aviso-nenhum-cliente").style.display = "block";
                        getEl("container-projetos-cliente").style.display = "none";
                    }
                };

                // Carregar projetos de um cliente selecionado
                const carregarProjetosParaExibicao = (clienteId) => {
                    const cliente = BancoClientes[clienteId];
                    if (!cliente) return;
                    
                    getEl("nome-cliente-selecionado").textContent = cliente.nome;
                    const container = getEl("lista-projetos-cliente");
                    container.innerHTML = "";

                    cliente.projetos.forEach(projeto => {
                        const div = document.createElement("div");
                        div.className = "catalogo-item";
                        div.style.flexDirection = "column";
                        div.style.alignItems = "flex-start";
                        
                        const dataProjeto = new Date(projeto.data).toLocaleDateString('pt-BR');
                        const html = `
                            <div style="width: 100%; margin-bottom: 8px;">
                                <strong style="color: var(--cor-principal); font-size: 1.05rem;">${projeto.nome}</strong>
                                <p style="font-size: 0.85rem; color: var(--cor-texto-suave); margin: 4px 0;">üìÖ ${dataProjeto}</p>
                                <p style="font-size: 0.9rem; color: var(--cor-sucesso);">üí∞ Or√ßamento: ${projeto.orcamento}</p>
                            </div>
                            <div style="display: flex; gap: 10px; width: 100%;">
                                <button class="btn btn-primary btn-sm" onclick="window.carregarProjetoCliente('${cliente.nome}', '${projeto.id}');">Abrir</button>
                                <button class="btn btn-secondary btn-sm" onclick="deletarProjetoCliente('${cliente.nome}', '${projeto.id}'); carregarProjetosParaExibicao('${clienteId}');">Deletar</button>
                                <button class="btn btn-warning btn-sm" onclick="exportarProjetosCliente('${cliente.nome}');">Exportar</button>
                            </div>
                        `;
                        div.innerHTML = html;
                        container.appendChild(div);
                    });

                    getEl("aviso-nenhum-cliente").style.display = "none";
                    getEl("container-projetos-cliente").style.display = "block";
                };

                // Event listener para o seletor de clientes
                getEl("seletorClienteProjetos").addEventListener("change", (e) => {
                    if (e.target.value) {
                        carregarProjetosParaExibicao(e.target.value);
                    } else {
                        getEl("container-projetos-cliente").style.display = "none";
                    }
                });

                // FUN√á√ÉO CENTRALIZADA E CORRIGIDA PARA SALVAR O ESTADO DA APLICA√á√ÉO
                const saveAppState = () => {
                    try {
                        // Garante que o objeto AppData √© limpo de refer√™ncias complexas antes de salvar
                        const cleanData = JSON.parse(JSON.stringify(AppData));
                        localStorage.setItem("marcenaria_pro_AppData", JSON.stringify(cleanData));
                        console.log("Estado da aplica√ß√£o salvo no backup do navegador.");
                        // Exportar automaticamente para dados.json
                        exportarDadosJSON();
                        // Exportar automaticamente para dados.js
                        exportarDadosJS();
                    } catch (e) {
                        console.error("Falha ao salvar o estado da aplica√ß√£o:", e);
                        showToast("Erro: Falha ao salvar o progresso no navegador.", "error");
                    }
                };

                // Fun√ß√£o para exportar AppData como JSON
                const exportarDadosJSON = () => {
                    try {
                        const cleanData = JSON.parse(JSON.stringify(AppData));
                        const dadosFormatados = JSON.stringify(cleanData, null, 4);
                        const blob = new Blob([dadosFormatados], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.style.display = "none";
                        a.href = url;
                        a.download = `dados.json`; // Sempre o mesmo nome para sobrescrever
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log("Cat√°logo (dados.json) exportado automaticamente!");
                    } catch (e) {
                        console.error("Erro ao exportar dados.json:", e);
                    }
                };

                // Fun√ß√£o para exportar AppData como arquivo JS
                const exportarDadosJS = () => {
                    try {
                        const cleanData = JSON.parse(JSON.stringify(AppData));
                        const conteudoJS = `// ‚ö†Ô∏è IMPORTANTE: Este arquivo √© gerado automaticamente pelo sistema\n// N√ÉO edite manualmente - ele ser√° sobrescrito toda vez que voc√™ salvar o cat√°logo\n\nwindow.DADOS_DO_SISTEMA = ${JSON.stringify(cleanData, null, 2)};`;
                        const blob = new Blob([conteudoJS], { type: "application/javascript" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.style.display = "none";
                        a.href = url;
                        a.download = `dados.js`; // Sempre o mesmo nome para sobrescrever
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        console.log("Cat√°logo (dados.js) exportado automaticamente!");
                    } catch (e) {
                        console.error("Erro ao exportar dados.js:", e);
                    }
                };

                const salvarDados = () => {
                    // Exporta dados do AppData direto
                    exportarDadosJSON();
                    exportarDadosJS();
                    showToast("‚úÖ Cat√°logo exportado! Arquivos dados.json e dados.js atualizados.", "success");
                    console.log("‚úÖ Arquivos salvos na pasta Downloads!");
                    console.log("üìÅ Copie os arquivos dados.json e dados.js para a mesma pasta que o index.html");
                };

                // Fun√ß√£o para testar se os dados est√£o carregando
                const testarCarregamentoDados = () => {
                    const resultado = {
                        "window.DADOS_DO_SISTEMA existe": !!window.DADOS_DO_SISTEMA,
                        "N√∫mero de m√≥dulos": AppData.catalogoModulos?.length || 0,
                        "Cores MDF": Object.keys(AppData.coresMDF || {}).length,
                        "Cores Borda": Object.keys(AppData.coresBorda || {}).length,
                        "Ferragens": Object.keys(AppData.catalogoFerragens || {}).length,
                        "LocalStorage AppData": !!localStorage.getItem("marcenaria_pro_AppData"),
                    };
                    console.table(resultado);
                    return resultado;
                };


                const carregarDados = async () => {
                    const defaults = {
                        catalogoModulos: [],
                        coresMDF: {},
                        coresBorda: {},
                        catalogoFerragens: {},
                        catalogoPerfis: {},
                        pecasPredefinidas: {},
                        configCalculo: {},
                    };

                    let dadosCarregados = null;

                    // Aguarda mais tempo para garantir que os scripts foram carregados
                    await new Promise(resolve => setTimeout(resolve, 500));

                    console.log("Verificando dados dispon√≠veis:", {
                        "window.DADOS_DO_SISTEMA": !!window.DADOS_DO_SISTEMA,
                        "window.DADOS_DO_SISTEMA conte√∫do": window.DADOS_DO_SISTEMA
                    });

                    // 1. TENTATIVA: Carregar do arquivo externo dados.js
                    if (window.DADOS_DO_SISTEMA && Object.keys(window.DADOS_DO_SISTEMA).length > 0) {
                        console.log("‚úÖ Dados carregados via arquivo externo (dados.js)");
                        dadosCarregados = JSON.parse(JSON.stringify(window.DADOS_DO_SISTEMA));
                    }

                    // 2. TENTATIVA: Tentar carregar dados.json automaticamente da pasta
                    if (!dadosCarregados) {
                        try {
                            console.log("üîç Tentando carregar dados.json da pasta...");
                            
                            // Tenta com fetch - melhor suporte
                            try {
                                const resposta = await fetch("dados.json", { 
                                    method: "GET", 
                                    cache: "no-store",
                                    headers: { "Accept": "application/json" }
                                });
                                
                                if (resposta.ok) {
                                    dadosCarregados = await resposta.json();
                                    console.log("‚úÖ Dados carregados automaticamente de dados.json (via fetch)");
                                } else {
                                    console.log("‚ÑπÔ∏è Erro ao carregar dados.json (HTTP " + resposta.status + ")");
                                }
                            } catch (fetchErr) {
                                // Se fetch falhar, tenta com XMLHttpRequest (mais compat√≠vel)
                                console.log("‚ÑπÔ∏è Fetch falhou, tentando com XMLHttpRequest...");
                                
                                return new Promise((resolve) => {
                                    const xhr = new XMLHttpRequest();
                                    xhr.open("GET", "dados.json", true);
                                    xhr.onload = function() {
                                        if (xhr.status === 200) {
                                            try {
                                                dadosCarregados = JSON.parse(xhr.responseText);
                                                console.log("‚úÖ Dados carregados automaticamente de dados.json (via XMLHttpRequest)");
                                            } catch (parseErr) {
                                                console.error("Erro ao parsear JSON:", parseErr);
                                            }
                                        } else {
                                            console.log("‚ÑπÔ∏è Erro HTTP " + xhr.status + " ao carregar dados.json");
                                        }
                                        resolve();
                                    };
                                    xhr.onerror = function() {
                                        console.log("‚ÑπÔ∏è Arquivo dados.json n√£o encontrado na pasta");
                                        resolve();
                                    };
                                    xhr.send();
                                });
                            }
                        } catch (e) {
                            console.log("‚ÑπÔ∏è Erro ao tentar carregar dados.json: " + e.message);
                        }
                    }

                    // 3. TENTATIVA: Carregar do JSON embutido (backup)
                    if (!dadosCarregados) {
                        const dadosEmbutidosEl = document.getElementById("dados-json");
                        if (dadosEmbutidosEl) {
                            try {
                                const dadosTexto = dadosEmbutidosEl.textContent.trim();
                                if (dadosTexto) {
                                    dadosCarregados = JSON.parse(dadosTexto);
                                    console.log("‚úÖ Dados carregados do JSON embutido no HTML.");
                                }
                            } catch (e) {
                                console.error("Erro ao ler JSON embutido.", e);
                            }
                        }
                    }

                    // 4. TENTATIVA: Carregar do LocalStorage (Backup do navegador)
                    if (!dadosCarregados) {
                        const dadosLocalStorage = localStorage.getItem("marcenaria_pro_AppData");
                        if (dadosLocalStorage) {
                            try {
                                dadosCarregados = JSON.parse(dadosLocalStorage);
                                console.log("‚úÖ Dados carregados do backup do navegador (LocalStorage).");
                                showToast("Dados carregados da mem√≥ria do navegador.", "warning");
                            } catch (e) {
                                console.error("Backup do LocalStorage corrompido.", e);
                            }
                        }
                    }

                    // Se n√£o achou nada, usa os padr√µes vazios
                    if (!dadosCarregados) {
                         console.log("‚ùå Nenhum dado encontrado. Iniciando com banco de dados vazio.");
                         console.log("Verifique se os arquivos 'dados.json' est√£o na mesma pasta que index.html");
                    }

                    AppData = { ...defaults, ...dadosCarregados };
                    window.AppData = AppData; // Update global reference
                    
                    // Salva no localStorage para garantir persist√™ncia futura
                    saveAppState(); 

                    if (AppData.catalogoModulos && Array.isArray(AppData.catalogoModulos)) {
                        AppData.catalogoModulos.forEach((mod) => {
                            if (!mod.pecas) mod.pecas = [];
                        });
                    }

                    recalculateAllMdfPrices();
                };

                const recalculateAllMdfPrices = () => {
                    if (!AppData.configCalculo || !AppData.coresMDF) return;
                    const { chapaAltura, chapaLargura } = AppData.configCalculo;
                    const areaChapa = (chapaAltura / 1000) * (chapaLargura / 1000);
                    if (areaChapa > 0) {
                        Object.keys(AppData.coresMDF).forEach((key) => {
                            const material = AppData.coresMDF[key];
                            if (material && material.precoChapa !== undefined) {
                                material.preco = material.precoChapa / areaChapa;
                            }
                        });
                    }
                };

                const gerenciarCatalogoObjetos = (tipo, obj, containerId) => {
                    const container = getEl(containerId);
                    if (!container) return;
                    container.innerHTML = "";

                    if (!obj) {
                        console.error(`Objeto de dados para '${tipo}' √© nulo ou indefinido.`);
                        return;
                    }

                    Object.keys(obj)
                        .sort((a, b) => obj[a].nome.localeCompare(obj[b].nome))
                        .forEach((key) => {
                            const item = obj[key];
                            const div = document.createElement("div");
                            div.className = "catalogo-item catalogo-item-com-imagem";
                            div.dataset.filterName = `${item.nome}`.toLowerCase();
                            const placeholderImg = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

                            let displayInfo = item.nome;
                            if (item.preco !== undefined) {
                                let unit = "UN";
                                if (tipo === "coresMDF") unit = "m¬≤";
                                else if (tipo === "coresBorda") unit = "m";
                                else if (tipo === "catalogoPerfis") unit = "m";
                                else if (item.unidade) unit = item.unidade;

                                displayInfo += ` (R$ ${item.preco.toFixed(2)} / ${unit})`;
                            } else if (tipo === "pecasPredefinidas") {
                                displayInfo += ` (Qtd: ${item.qtd || "1"}, A: ${item.altura || "0"}, L: ${item.largura || "0"})`;
                            }

                            let buttonsHtml = `<div class="botoes-acao" style="margin-top:0; margin-left: auto; flex-wrap:nowrap;">`;
                            if (tipo === "catalogoFerragens") {
                                buttonsHtml += `<button class="btn-warning btn-sm btn-edit-ferragem" data-key="${key}" data-type="${tipo}">Editar</button>`;
                            } else if (tipo === "coresMDF" || tipo === "coresBorda") {
                                buttonsHtml += `<button class="btn-warning btn-sm btn-edit-material" data-key="${key}" data-type="${tipo}">Editar</button>`;
                            } else if (tipo === "catalogoPerfis") {
                                buttonsHtml += `<button class="btn-warning btn-sm btn-edit-perfil" data-key="${key}" data-type="${tipo}">Editar</button>`;
                            } else if (tipo === "pecasPredefinidas") {
                                buttonsHtml += `<button class="btn-warning btn-sm btn-edit-peca" data-key="${key}" data-type="${tipo}">Editar</button>`;
                            }
                            buttonsHtml += `<button class="btn-danger btn-sm btn-delete" data-key="${key}" data-type="${tipo}">X</button></div>`;

                            div.innerHTML = `<img src="${item.imagem || placeholderImg}"><span>${displayInfo}</span>${buttonsHtml}`;
                            container.appendChild(div);
                        });
                };

                const popularSeletorObjetos = (seletorId, obj, placeholder, useKeyAsValue = true) => {
                    const select = typeof seletorId === "string" ? getEl(seletorId) : seletorId;
                    if (!select) {
                        console.warn(`Select com ID '${seletorId}' n√£o encontrado no DOM`);
                        return;
                    }
                    select.innerHTML = `<option value="">-- ${placeholder} --</option>`;
                    if (!obj || Object.keys(obj).length === 0) {
                        console.warn(`Objeto de dados para o seletor '${seletorId}' est√° vazio. Isso significa que os dados n√£o foram carregados corretamente.`);
                        select.innerHTML += `<option value="" disabled style="color: red;">‚ö†Ô∏è Nenhum item dispon√≠vel - Importe seus dados</option>`;
                        return;
                    }
                    Object.keys(obj)
                        .sort((a, b) => obj[a].nome.localeCompare(obj[b].nome))
                        .forEach((key) => {
                            const value = useKeyAsValue ? key : obj[key].nome;
                            select.innerHTML += `<option value="${value}">${obj[key].nome}</option>`;
                        });
                };

                const atualizarListaCategorias = () => {
                    const select = getEl("categoriaModuloSelect");
                    if (!select || !AppData.catalogoModulos) return;
                    const categorias = [...new Set(AppData.catalogoModulos.map((m) => m.categoria).filter((c) => c))].sort();
                    select.innerHTML = `<option value="">Sem Categoria</option>`;
                    categorias.forEach((cat) => {
                        select.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                    select.innerHTML += `<option value="_add_new_">-- Adicionar Nova Categoria --</option>`;
                };

                const popularModalCatalogoCompleto = () => {
                    const popularLista = (containerId, catalogo, unidade) => {
                        const container = getEl(containerId);
                        if (!container) return;
                        container.innerHTML = "";
                        const ul = document.createElement("ul");
                        ul.className = "lista-catalogo-completo";

                        if (!catalogo || Object.keys(catalogo).length === 0) {
                            ul.innerHTML = "<li>Nenhum item cadastrado.</li>";
                        } else {
                            Object.keys(catalogo)
                                .sort((a, b) => catalogo[a].nome.localeCompare(catalogo[b].nome))
                                .forEach((key) => {
                                    const item = catalogo[key];
                                    const li = document.createElement("li");
                                    let displayInfo = item.nome;
                                    let preco = "";

                                    if (item.preco !== undefined) {
                                        preco = `<span class="preco">R$ ${item.preco.toFixed(2)} / ${item.unidade || unidade}</span>`;
                                    } else if (item.qtd) {
                                        preco = `<span class="preco">Qtd: ${item.qtd}, A:${item.altura}, L:${item.largura}</span>`;
                                    }
                                    li.innerHTML = `<span>${displayInfo}</span>${preco}`;
                                    ul.appendChild(li);
                                });
                        }
                        container.appendChild(ul);
                    };

                    popularLista("lista-completa-mdf", AppData.coresMDF, "m¬≤");
                    popularLista("lista-completa-borda", AppData.coresBorda, "m");
                    popularLista("lista-completa-perfis", AppData.catalogoPerfis, "m");
                    popularLista("lista-completa-ferragens", AppData.catalogoFerragens, "");
                    popularLista("lista-completa-pecas", AppData.pecasPredefinidas, "");
                };

                const popularTodosSeletores = () => {
                    // Verificar se os dados est√£o vazios
                    const dadosVazios = !AppData.catalogoModulos || AppData.catalogoModulos.length === 0;
                    
                    if (dadosVazios) {
                        console.warn("‚ö†Ô∏è ATEN√á√ÉO: Os dados do cat√°logo est√£o vazios!");
                        console.warn("Por favor, importe seus dados em Configura√ß√µes ‚Üí Importar Backup");
                        showToast("‚ö†Ô∏è Nenhum dado de cat√°logo encontrado. V√° em Configura√ß√µes e importe seus dados.", "warning");
                    }
                    
                    gerenciarCatalogoObjetos("coresMDF", AppData.coresMDF, "listaCoresMDF");
                    gerenciarCatalogoObjetos("coresBorda", AppData.coresBorda, "listaCoresBorda");
                    gerenciarCatalogoObjetos("catalogoFerragens", AppData.catalogoFerragens, "listaFerragensCatalogo");
                    gerenciarCatalogoObjetos("pecasPredefinidas", AppData.pecasPredefinidas, "listaPecasPredefinidas");
                    gerenciarCatalogoObjetos("catalogoPerfis", AppData.catalogoPerfis, "listaPerfisPuxador");

                    popularSeletorObjetos("projCorInterna", AppData.coresMDF, "Selecione uma Cor");
                    popularSeletorObjetos("projCorExterna", AppData.coresMDF, "Selecione uma Cor");
                    popularSeletorObjetos("moduloCorBordaInterna", AppData.coresBorda, "Selecione uma Cor de Borda");
                    popularSeletorObjetos("moduloCorBordaExterna", AppData.coresBorda, "Selecione uma Cor de Borda");
                    popularSeletorObjetos("projCorBordaInterna", AppData.coresBorda, "-- Usar Padr√£o do M√≥dulo --");
                    popularSeletorObjetos("projCorBordaExterna", AppData.coresBorda, "-- Usar Padr√£o do M√≥dulo --");
                    popularSeletorObjetos("projPerfilAluminio", AppData.catalogoPerfis, "Selecione um Perfil");

                    const ferragensUnidade = AppData.catalogoFerragens
                        ? Object.keys(AppData.catalogoFerragens).reduce((acc, key) => {
                              if (AppData.catalogoFerragens[key].unidade === "UN" || AppData.catalogoFerragens[key].unidade === "PAR") {
                                  acc[key] = AppData.catalogoFerragens[key];
                              }
                              return acc;
                          }, {})
                        : {};
                    popularSeletorObjetos("puxadorExternoPadrao", ferragensUnidade, "Nenhum (Desativado)");

                    const corredicasCatalogo = AppData.catalogoFerragens
                        ? Object.keys(AppData.catalogoFerragens).reduce((acc, key) => {
                              if (AppData.catalogoFerragens[key].tipo === "corredica") {
                                  acc[key] = AppData.catalogoFerragens[key];
                              }
                              return acc;
                          }, {})
                        : {};
                    popularSeletorObjetos("moduloCorredicaSelect", corredicasCatalogo, "Escolha uma corredi√ßa");
                    popularSeletorObjetos("moduloFerragemSelect", AppData.catalogoFerragens, "Escolha uma ferragem");
                    popularSeletorObjetos("ferragensExtrasSelect", AppData.catalogoFerragens, "Escolha do cat√°logo");
                    popularSeletorObjetos("pecas-predefinidas", AppData.pecasPredefinidas, "Ou adicione uma pe√ßa pr√©-definida");

                    atualizarListaCategorias();
                };

                const adicionarNovaPeca = (peca = {}) => {
                    const clone = getEl("template-peca").content.cloneNode(true);
                    const wrapper = clone.querySelector(".peca-item-wrapper");
                    const item = wrapper.querySelector(".peca-item");
                    const ferragemSelect = wrapper.querySelector(".peca-ferragem-select");
                    const qtdInput = wrapper.querySelector(".peca-ferragem-qtd");
                    const medidaInput = wrapper.querySelector(".peca-ferragem-medida");
                    const addFerragemBtn = wrapper.querySelector(".btn-add-ferragem-assoc");
                    const ferragensContainer = wrapper.querySelector(".ferragens-associadas-container");

                    item.querySelector(".peca-nome").value = peca.nome || "";
                    item.querySelector(".peca-qtd").value = peca.qtd || "1";
                    item.querySelector(".peca-altura").value = peca.altura || "";
                    item.querySelector(".peca-largura").value = peca.largura || "";
                    item.querySelector(".peca-espessura").value = peca.espessura || "";
                    item.querySelector(".peca-material-tipo").value = peca.tipoMaterial || "interna";
                    item.querySelector(".peca-borda-tipo").value = peca.tipoBorda || "interna";
                    item.querySelector(".peca-borda-a1").checked = peca.bordaA1 || false;
                    item.querySelector(".peca-borda-a2").checked = peca.bordaA2 || false;
                    item.querySelector(".peca-borda-l1").checked = peca.bordaL1 || false;
                    item.querySelector(".peca-borda-l2").checked = peca.bordaL2 || false;
                    item.querySelector(".btn-remover-peca").addEventListener("click", () => wrapper.remove());

                    popularSeletorObjetos(ferragemSelect, AppData.catalogoFerragens, "Cat√°logo de Ferragens");

                    ferragemSelect.addEventListener("change", () => {
                        const selectedKey = ferragemSelect.value;
                        const ferragem = AppData.catalogoFerragens[selectedKey];
                        if (ferragem && ferragem.tipo === "corredica") {
                            medidaInput.style.display = "block";
                        } else {
                            medidaInput.style.display = "none";
                        }
                    });

                    const adicionarFerragemAssocUI = (ferragemAssoc) => {
                        const ferragemData = AppData.catalogoFerragens[ferragemAssoc.key];
                        if (!ferragemData) return;
                        const div = getEl("template-ferragem-assoc").content.cloneNode(true).querySelector(".catalogo-item");
                        div.dataset.key = ferragemAssoc.key;
                        div.dataset.qtdFormula = ferragemAssoc.qtdFormula;
                        div.dataset.medidaFormula = ferragemAssoc.medidaFormula || "";

                        let displayText = `${ferragemData.nome} (Qtd: ${ferragemAssoc.qtdFormula}`;
                        if (ferragemAssoc.medidaFormula) {
                            displayText += `, Medida: ${ferragemAssoc.medidaFormula}`;
                        }
                        displayText += ")";

                        div.querySelector("span").textContent = displayText;
                        div.querySelector("button").onclick = () => div.remove();
                        ferragensContainer.appendChild(div);
                    };

                    addFerragemBtn.addEventListener("click", () => {
                        const key = ferragemSelect.value;
                        const qtdFormula = qtdInput.value.trim();
                        const medidaFormula = medidaInput.value.trim();
                        const ferragem = AppData.catalogoFerragens[key];

                        if (!key || !qtdFormula) return showToast("Selecione uma ferragem e digite a quantidade/f√≥rmula.", "error");
                        if (ferragem && ferragem.tipo === "corredica" && !medidaFormula) return showToast("Para corredi√ßas, a f√≥rmula de medida √© obrigat√≥ria.", "error");

                        adicionarFerragemAssocUI({ key, qtdFormula, medidaFormula });
                        ferragemSelect.value = "";
                        qtdInput.value = "";
                        medidaInput.value = "";
                        medidaInput.style.display = "none";
                    });

                    if (peca.ferragensAssociadas) {
                        peca.ferragensAssociadas.forEach(adicionarFerragemAssocUI);
                    }

                    pecasContainer.appendChild(clone);
                    atualizarTodosOsHelpersNoModal(getEl("moduloTipo").value);
                };

                const atualizarResumoProjeto = () => {
                    if (projetoAtual.modulos.length === 0 && projetoAtual.ferragensExtras.length === 0) {
                        resumoContainer.style.display = "none";
                        return;
                    }
                    const placeholderImg = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    resumoContainer.style.display = "block";
                    listaResumo.innerHTML = "";

                    // --- NOVA L√ìGICA: AGRUPAMENTO DE M√ìDULOS ---
                    const gruposModulos = {};
                    
                    projetoAtual.modulos.forEach((modulo) => {
                        // Cria uma chave √∫nica baseada nas caracter√≠sticas visuais e dimensionais
                        const propsParaChave = [
                            modulo.id, modulo.nome, modulo.tipoModulo,
                            modulo.altura, modulo.largura, modulo.profundidade,
                            modulo.ladoA, modulo.ladoB, modulo.profA, modulo.profB,
                            modulo.corMaterialInterna, modulo.corMaterialExterna,
                            modulo.corBordaInterna, modulo.corBordaExterna,
                            modulo.tipoPuxador, modulo.isPecaAvulsa, modulo.espessura
                        ];
                        const chave = JSON.stringify(propsParaChave);

                        if (!gruposModulos[chave]) {
                            gruposModulos[chave] = { ...modulo, qtdAgrupada: 0, ids: [] };
                        }
                        gruposModulos[chave].qtdAgrupada++;
                        gruposModulos[chave].ids.push(modulo.instanceId);
                    });

                    // Renderiza a lista baseada nos GRUPOS
                    Object.values(gruposModulos).forEach((grupo) => {
                        const li = document.createElement("li");
                        const corInternaNome = AppData.coresMDF[grupo.corMaterialInterna]?.nome || "N/A";
                        const corExternaNome = AppData.coresMDF[grupo.corMaterialExterna]?.nome || "N/A";
                        const bordaInternaDisplay = AppData.coresBorda[grupo.corBordaInterna]?.nome || "Padr√£o";
                        const bordaExternaDisplay = AppData.coresBorda[grupo.corBordaExterna]?.nome || "Padr√£o";
                        
                        let tipoPuxadorTexto = "Puxador: Externo";
                        if (grupo.tipoPuxador === "cava_horizontal") tipoPuxadorTexto = "Puxador: Cava Horizontal";
                        if (grupo.tipoPuxador === "cava_vertical") tipoPuxadorTexto = "Puxador: Cava Vertical";
                        if (grupo.tipoPuxador === "perfil_horizontal") tipoPuxadorTexto = "Puxador: Perfil Horizontal";
                        if (grupo.tipoPuxador === "perfil_vertical") tipoPuxadorTexto = "Puxador: Perfil Vertical";

                        const detalhesCores = `
                                    <div class="resumo-detalhes-cores">
                                        Material: <b>${corInternaNome}</b> (Int) / <b>${corExternaNome}</b> (Ext)<br>
                                        Bordas: <b>${bordaInternaDisplay}</b> (Int) / <b>${bordaExternaDisplay}</b> (Ext)<br>
                                        <b>${tipoPuxadorTexto}</b>
                                    </div>`;

                        let dimensoesTexto = "";
                        if (grupo.isPecaAvulsa) {
                            dimensoesTexto = `(A:${grupo.altura} L:${grupo.largura} E:${grupo.espessura})`;
                        } else if (grupo.tipoModulo === "reto") {
                            dimensoesTexto = `(A:${grupo.altura} L:${grupo.largura} P:${grupo.profundidade})`;
                        } else {
                            dimensoesTexto = `(A:${grupo.altura} LadoA:${grupo.ladoA}...)`;
                        }
                        
                        const img = grupo.imagem || placeholderImg;
                        
                        // HTML Atualizado com a "Bolinha" da quantidade
                        li.innerHTML = `
                                    <div class="item-info">
                                         <div style="position: relative; margin-right: 12px;">
                                            <img src="${img}" alt="${grupo.nome}" style="margin-right: 0;">
                                            <span style="
                                                position: absolute; 
                                                top: -8px; left: -8px; 
                                                background: var(--cor-principal); 
                                                color: white; 
                                                font-weight: 800; 
                                                min-width: 24px; height: 24px;
                                                border-radius: 50%; 
                                                display: flex; align-items: center; justify-content: center;
                                                font-size: 0.75rem; 
                                                border: 2px solid white;
                                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                            ">${grupo.qtdAgrupada}</span>
                                         </div>
                                        <div>
                                            <span style="font-weight: 600;">
                                                <span style="color: var(--cor-principal); font-weight: 800;">${grupo.qtdAgrupada}x</span> 
                                                ${grupo.nome} <span class="dimensoes">${dimensoesTexto}</span>
                                            </span>
                                            ${detalhesCores}
                                        </div>
                                    </div>
                                    <!-- Bot√£o remove todos os IDs desse grupo -->
                                    <button class="btn-danger btn-sm btn-remover-grupo" data-ids="${grupo.ids.join(',')}">Remover Todos</button>`;
                        listaResumo.appendChild(li);
                    });

                    projetoAtual.ferragensExtras.forEach((ferragem) => {
                        const li = document.createElement("li");
                        const img = ferragem.imagem || placeholderImg;
                        li.innerHTML = `
                                    <div class="item-info">
                                        <img src="${img}" alt="${ferragem.nome}">
                                        <span>${ferragem.valor}${ferragem.unidade} de ${ferragem.nome} (Extra)</span>
                                    </div>
                                    <button class="btn-danger btn-sm" data-instance-id="${ferragem.instanceId}">Remover</button>`;
                        listaResumo.appendChild(li);
                    });
                };

                const adicionarFerragemAoModuloUI = (ferragemItem) => {
                    const key = ferragemItem.key,
                        valor = ferragemItem.valor;
                    const ferragem = AppData.catalogoFerragens[key];
                    if (!ferragem) return;
                    const container = getEl("ferragens-modulo-container");
                    const div = getEl("template-ferragem-modulo").content.cloneNode(true).querySelector(".catalogo-item");
                    div.dataset.key = key;
                    div.dataset.valor = valor;
                    div.querySelector("span").textContent = `${valor} ${ferragem.unidade} de ${ferragem.nome}`;
                    div.querySelector("button").onclick = () => div.remove();
                    container.appendChild(div);
                };

                const adicionarCorredicaAoModuloUI = (corredicaItem) => {
                    const key = corredicaItem.key;
                    const corredicaData = AppData.catalogoFerragens[key];
                    if (!corredicaData) return;
                    const container = getEl("corredicas-modulo-container");
                    const div = getEl("template-corredica-modulo").content.cloneNode(true).querySelector(".catalogo-item");
                    div.dataset.key = key;
                    div.dataset.qtdFormula = corredicaItem.qtdFormula;
                    div.dataset.medidaFormula = corredicaItem.medidaFormula;

                    let displayText = `${corredicaData.nome} (Qtd: ${corredicaItem.qtdFormula}, Medida: ${corredicaItem.medidaFormula})`;

                    div.querySelector("span").textContent = displayText;
                    div.querySelector("button").onclick = () => div.remove();
                    container.appendChild(div);
                };

                const resetModuleCreatorForm = () => {
                    getEl("categoriaModuloSelect").value = "";
                    getEl("novaCategoriaInput").value = "";
                    getEl("novaCategoriaInput").style.display = "none";
                    getEl("nomeModulo").value = "";
                    getEl("moduloTipo").value = "reto";
                    pecasContainer.innerHTML = "";
                    getEl("ferragens-modulo-container").innerHTML = "";
                    getEl("corredicas-modulo-container").innerHTML = "";
                    getEl("moduloCorredicaSelect").value = "";
                    getEl("moduloCorredicaQtd").value = "";
                    getEl("moduloCorredicaMedida").value = "";

                    getEl("imagemModuloPreview").src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    getEl("imagemModuloPreview").nextElementSibling.value = "";
                    imagemModuloUrl = null;
                    editingModuleId = null;
                    getEl("modal-modulo-titulo").textContent = "Criar Novo M√≥dulo";
                    getEl("modal-modulo-descricao").textContent = "Crie ou edite modelos completos, definindo suas pe√ßas, f√≥rmulas e as ferragens necess√°rias.";
                    getEl("btnSalvarModulo").textContent = "Salvar M√≥dulo";
                    atualizarTodosOsHelpersNoModal("reto");
                };

                const carregarModuloParaEdicao = (moduloId) => {
                    const modulo = AppData.catalogoModulos.find((m) => m.id === moduloId);
                    if (!modulo) return;
                    resetModuleCreatorForm();
                    editingModuleId = moduloId;
                    getEl("modal-modulo-titulo").textContent = "Editar M√≥dulo";
                    getEl("btnSalvarModulo").textContent = "Salvar Altera√ß√µes";
                    getEl("categoriaModuloSelect").value = modulo.categoria || "";
                    getEl("nomeModulo").value = modulo.nome;
                    getEl("moduloTipo").value = modulo.tipo || "reto";
                    getEl("moduloCorBordaInterna").value = modulo.corBordaInterna;
                    getEl("moduloCorBordaExterna").value = modulo.corBordaExterna;
                    if (modulo.imagem) {
                        getEl("imagemModuloPreview").src = modulo.imagem;
                        imagemModuloUrl = modulo.imagem;
                    }
                    (modulo.pecas || []).forEach(adicionarNovaPeca);
                    (modulo.ferragens || []).forEach(adicionarFerragemAoModuloUI);
                    (modulo.corredicas || []).forEach((addCorredica) => adicionarCorredicaAoModuloUI(addCorredica));

                    navigateTo("view-editor-modulo");
                    atualizarTodosOsHelpersNoModal(getEl("moduloTipo").value);
                };

                const getModuleDataFromForm = () => {
                    const view = getEl("view-editor-modulo");
                    const nome = view.querySelector("#nomeModulo").value.trim();
                    if (!nome) {
                        showToast("D√™ um nome ao m√≥dulo.", "error");
                        return null;
                    }

                    let categoria = getEl("categoriaModuloSelect").value;
                    const novaCategoria = getEl("novaCategoriaInput").value.trim();
                    if (categoria === "_add_new_") {
                        categoria = novaCategoria || "";
                    }

                    const pecas = Array.from(view.querySelectorAll("#pecas-container .peca-item-wrapper")).map((wrapper) => {
                        const item = wrapper.querySelector(".peca-item");
                        const ferragensAssociadas = Array.from(wrapper.querySelectorAll(".ferragens-associadas-container .catalogo-item")).map((ferragemEl) => ({
                            key: ferragemEl.dataset.key,
                            qtdFormula: ferragemEl.dataset.qtdFormula,
                            medidaFormula: ferragemEl.dataset.medidaFormula,
                        }));
                        return {
                            nome: item.querySelector(".peca-nome").value,
                            qtd: item.querySelector(".peca-qtd").value,
                            altura: item.querySelector(".peca-altura").value,
                            largura: item.querySelector(".peca-largura").value,
                            espessura: item.querySelector(".peca-espessura").value,
                            tipoMaterial: item.querySelector(".peca-material-tipo").value,
                            tipoBorda: item.querySelector(".peca-borda-tipo").value,
                            bordaA1: item.querySelector(".peca-borda-a1").checked,
                            bordaA2: item.querySelector(".peca-borda-a2").checked,
                            bordaL1: item.querySelector(".peca-borda-l1").checked,
                            bordaL2: item.querySelector(".peca-borda-l2").checked,
                            ferragensAssociadas,
                        };
                    });

                    const ferragensGerais = Array.from(view.querySelectorAll("#ferragens-modulo-container .catalogo-item")).map((item) => ({
                        key: item.dataset.key,
                        valor: parseFloat(item.dataset.valor),
                    }));

                    const corredicasModulo = Array.from(view.querySelectorAll("#corredicas-modulo-container .catalogo-item")).map((item) => ({
                        key: item.dataset.key,
                        qtdFormula: item.dataset.qtdFormula,
                        medidaFormula: item.dataset.medidaFormula,
                    }));

                    if (pecas.length === 0) {
                        showToast("Adicione pelo menos uma pe√ßa ao m√≥dulo.", "error");
                        return null;
                    }
                    return {
                        categoria,
                        nome,
                        imagem: imagemModuloUrl,
                        pecas,
                        ferragens: ferragensGerais,
                        corredicas: corredicasModulo,
                        corBordaInterna: view.querySelector("#moduloCorBordaInterna").value,
                        corBordaExterna: view.querySelector("#moduloCorBordaExterna").value,
                        tipo: getEl("moduloTipo").value,
                    };
                };

                const salvarModulo = () => {
                    const moduloData = getModuleDataFromForm();
                    if (!moduloData) return;

                    if (editingModuleId) {
                        const index = AppData.catalogoModulos.findIndex((m) => m.id === editingModuleId);
                        AppData.catalogoModulos[index] = { id: editingModuleId, ...moduloData };
                        showToast(`M√≥dulo "${moduloData.nome}" atualizado!`);
                    } else {
                        AppData.catalogoModulos.push({ id: Date.now(), ...moduloData });
                        showToast(`M√≥dulo "${moduloData.nome}" salvo!`);
                    }

                    saveAppState();
                    atualizarListaCategorias();
                    navigateTo("view-gerenciar-modulos");
                    atualizarListaGerenciarModulos();
                };

                const popularGridSelecaoModulo = () => {
                    const gridContainer = getEl("grid-selecao-modulos");
                    gridContainer.innerHTML = "";
                    const placeholderImg = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

                    const createCard = (value, text, imgSrc, filterName) => {
                        const card = document.createElement("div");
                        card.className = "modulo-selecao-card";
                        card.dataset.value = value;
                        card.dataset.imgSrc = imgSrc || placeholderImg;
                        card.dataset.filterName = filterName.toLowerCase();
                        card.innerHTML = `<img src="${imgSrc || placeholderImg}" alt="${text}"><p>${text}</p>`;
                        return card;
                    };

                    const createHeader = (text) => {
                        const header = document.createElement("h3");
                        header.className = "grid-category-header";
                        header.textContent = text;
                        return header;
                    };

                    gridContainer.appendChild(createHeader("A√ß√µes"));
                    gridContainer.appendChild(createCard("_peca_avulsa_", "[Adicionar Pe√ßa Avulsa]", "", "pe√ßa avulsa"));

                    const modulosAgrupados = (AppData.catalogoModulos || []).reduce((acc, mod) => {
                        const categoria = mod.categoria || "Sem Categoria";
                        if (!acc[categoria]) {
                            acc[categoria] = [];
                        }
                        acc[categoria].push(mod);
                        return acc;
                    }, {});

                    gridContainer.appendChild(createHeader("M√≥dulos Completos"));
                    Object.keys(modulosAgrupados)
                        .sort()
                        .forEach((categoria) => {
                            if (categoria !== "Sem Categoria") {
                                gridContainer.appendChild(createHeader(categoria));
                            }
                            modulosAgrupados[categoria].forEach((m) => {
                                gridContainer.appendChild(createCard(m.id, m.nome, m.imagem, `${m.nome} ${m.categoria}`));
                            });
                        });
                };

                getEl("grid-selecao-modulos").addEventListener("click", (e) => {
                    const card = e.target.closest(".modulo-selecao-card");
                    if (!card) return;

                    const value = card.dataset.value;
                    const text = card.querySelector("p").textContent;
                    const imgSrc = card.dataset.imgSrc;

                    displayModuloSelecionado.dataset.value = value;
                    displayModuloSelecionado.textContent = text;
                    displayModuloSelecionado.style.color = "var(--cor-texto)";
                    getEl("imagemModuloPreviewProjeto").src = imgSrc;

                    const isPecaAvulsa = value === "_peca_avulsa_";
                    getEl("labelProjAltura").textContent = isPecaAvulsa ? "Altura da Pe√ßa (mm)" : "Altura Final (A) em mm";
                    getEl("labelProjLargura").textContent = isPecaAvulsa ? "Largura da Pe√ßa (mm)" : "Largura Final (L) em mm";
                    getEl("labelProjProfundidade").textContent = isPecaAvulsa ? "Espessura da Pe√ßa (mm)" : "Profundidade Final (P) em mm";
                    getEl("tipoModuloProjeto").style.display = isPecaAvulsa ? "none" : "block";
                    getEl("labelTipoModuloProjeto").style.display = isPecaAvulsa ? "none" : "block";

                    fecharModal("modal-selecionar-modulo");
                });

                const adicionarModuloAoProjeto = () => {
                    const selectedValue = displayModuloSelecionado.dataset.value;
                    const corMaterialInternaKey = getEl("projCorInterna").value;
                    const corMaterialExternaKey = getEl("projCorExterna").value;
                    const tipoPuxador = getEl("moduloTipoPuxador").value;
                    const tipoModulo = getEl("tipoModuloProjeto").value;
                    const quantidade = parseInt(getEl("quantidadeModuloProjeto").value, 10) || 1;

                    if (!selectedValue) return showToast("Selecione um m√≥dulo ou pe√ßa.", "error");
                    if (!corMaterialInternaKey || !corMaterialExternaKey) return showToast("Selecione as cores de material interna e externa.", "error");

                    if (tipoPuxador.startsWith("perfil") && !getEl("projPerfilAluminio").value) {
                        return showToast("Selecione um Perfil de Alum√≠nio Padr√£o para o projeto.", "error");
                    }

                    let moduloBase;
                    let dimensions = {};

                    if (selectedValue === "_peca_avulsa_") {
                        const A = parseFloat(getEl("projAltura").value) || 0;
                        const L = parseFloat(getEl("projLargura").value) || 0;
                        const E = parseFloat(getEl("projProfundidade").value) || 0;
                        if (!A || !L || !E) return showToast("Preencha Altura, Largura e Espessura da pe√ßa avulsa.", "error");

                        moduloBase = {
                            nome: `Pe√ßa Avulsa`,
                            isPecaAvulsa: true,
                            pecas: [{ nome: "Pe√ßa", qtd: "1", altura: String(A), largura: String(L), tipoMaterial: "externa", tipoBorda: "externa" }],
                            ferragens: [],
                            corredicas: [],
                        };
                        dimensions = { altura: A, largura: L, profundidade: 0, espessura: E };
                    } else {
                        moduloBase = AppData.catalogoModulos.find((m) => m.id == parseInt(selectedValue));
                        if (tipoModulo === "reto") {
                            const A = parseFloat(getEl("projAltura").value) || 0;
                            const L = parseFloat(getEl("projLargura").value) || 0;
                            const P = parseFloat(getEl("projProfundidade").value) || 0;
                            if (!A || !L || !P) return showToast("Preencha as dimens√µes do m√≥dulo reto (A, L, P).", "error");
                            dimensions = { altura: A, largura: L, profundidade: P };
                        } else {
                            const A = parseFloat(getEl("projAlturaCanto").value) || 0,
                                LadoA = parseFloat(getEl("projLadoA").value) || 0,
                                LadoB = parseFloat(getEl("projLadoB").value) || 0,
                                ProfA = parseFloat(getEl("projProfA").value) || 0,
                                ProfB = parseFloat(getEl("projProfB").value) || 0;
                            if (!A || !LadoA || !LadoB || !ProfA || !ProfB) return showToast("Preencha todas as dimens√µes do m√≥dulo de canto.", "error");
                            dimensions = { altura: A, ladoA: LadoA, ladoB: LadoB, profA: ProfA, profB: ProfB };
                        }
                    }

                    if (moduloBase) {
                        const config = AppData.configCalculo;
                        for (let i = 0; i < quantidade; i++) {
                            const moduloNoProjeto = {
                                ...moduloBase,
                                ...dimensions,
                                instanceId: "inst_mod_" + Date.now() + "_" + i,
                                corMaterialInterna: corMaterialInternaKey,
                                corMaterialExterna: corMaterialExternaKey,
                                corBordaInterna: getEl("projCorBordaInterna").value,
                                corBordaExterna: getEl("projCorBordaExterna").value,
                                tipoPuxador: tipoPuxador,
                                tipoModulo: tipoModulo,
                                descAlturaBaseGav: config.descAlturaBaseGav,
                                descAlturaLateralGav: config.descAlturaLateralGav,
                                folgaCorredicaFrente: config.folgaCorredicaFrente,
                                folgaCorredicaFundo: config.folgaCorredicaFundo,
                                folgaGaveta: config.folgaGaveta,
                            };
                            projetoAtual.modulos.push(moduloNoProjeto);
                        }

                        showToast(`${quantidade} x "${moduloBase.nome}" adicionado(s) ao projeto.`);
                        atualizarResumoProjeto();

                        displayModuloSelecionado.dataset.value = "";
                        displayModuloSelecionado.textContent = "-- Selecione um item --";
                        displayModuloSelecionado.style.color = "var(--cor-texto-claro)";
                        getEl("imagemModuloPreviewProjeto").src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                        getEl("moduloTipoPuxador").value = "externo";
                        getEl("quantidadeModuloProjeto").value = "1";
                    }
                };

                const adicionarFerragemExtra = () => {
                    const select = getEl("ferragensExtrasSelect"),
                        valorInput = getEl("ferragemExtraValor");
                    const key = select.value,
                        valor = parseFloat(valorInput.value);
                    if (!key || !valor || valor <= 0) return showToast("Selecione uma ferragem e um valor v√°lido.", "error");
                    const ferragemData = AppData.catalogoFerragens[key];
                    projetoAtual.ferragensExtras.push({ ...ferragemData, valor, instanceId: "inst_fer_" + Date.now() });
                    showToast(`Ferragem "${ferragemData.nome}" adicionada.`);
                    select.value = "";
                    valorInput.value = "";
                    atualizarResumoProjeto();
                };

                const removerItemDoProjeto = (instanceId) => {
                    projetoAtual.modulos = projetoAtual.modulos.filter((m) => m.instanceId !== instanceId);
                    projetoAtual.ferragensExtras = projetoAtual.ferragensExtras.filter((f) => f.instanceId !== instanceId);
                    showToast("Item removido do projeto.");
                    atualizarResumoProjeto();
                };

                const carregarConfiguracoesParaInputs = () => {
                    if (!AppData.configCalculo) return;
                    Object.keys(AppData.configCalculo).forEach((key) => {
                        const el = getEl(key);
                        if (el) el.value = AppData.configCalculo[key];
                    });
                };

                const salvarConfiguracoesDosInputs = () => {
                    if (!AppData.configCalculo) return;
                    Object.keys(AppData.configCalculo).forEach((key) => {
                        const el = getEl(key);
                        if (el) {
                            if (el.type === "number") {
                                AppData.configCalculo[key] = parseFloat(el.value) || 0;
                            } else {
                                AppData.configCalculo[key] = el.value;
                            }
                        }
                    });
                    recalculateAllMdfPrices();
                    saveAppState();
                    showToast("Configura√ß√µes salvas! Lembre-se de salvar os dados para tornar permanente.", "success");
                };

                const formatarNumero = (num) => (num % 1 === 0 ? num : num.toFixed(1));

                const gerarListagem = () => {
                    if (projetoAtual.modulos.length === 0 && projetoAtual.ferragensExtras.length === 0) return showToast("Adicione ao menos um item ao projeto.", "error");
                    ultimoNomeCliente = getEl("nomeCliente").value;
                    ultimoNomeAmbiente = getEl("nomeAmbiente").value;
                    const config = AppData.configCalculo;
                    listaPecasGerada = [];
                    listaFerragensGerada = [];
                    const perfilPadraoKey = getEl("projPerfilAluminio").value;
                    let totalPuxadoresExternos = 0;

                    const medidasCorredicasPadrao = (config.medidasCorredicas || "")
                        .split(",")
                        .map((m) => parseInt(m.trim()))
                        .filter((m) => !isNaN(m))
                        .sort((a, b) => a - b);

                    const findCorredicaIdeal = (tamanho) => {
                        if (medidasCorredicasPadrao.length === 0) return null;
                        const idealSize = medidasCorredicasPadrao
                            .slice()
                            .reverse()
                            .find((s) => s <= tamanho);
                        return idealSize || medidasCorredicasPadrao[0];
                    };

                    projetoAtual.modulos.forEach((modulo) => {
                        let ajustePuxadorAltura = 0,
                            ajustePuxadorLargura = 0,
                            descontoPerfilAltura = 0,
                            descontoPerfilLargura = 0;

                        if (modulo.tipoPuxador === "cava_horizontal") ajustePuxadorAltura = config.acrescimoPuxadorCava;
                        else if (modulo.tipoPuxador === "cava_vertical") ajustePuxadorLargura = config.acrescimoPuxadorCava;
                        else if (modulo.tipoPuxador === "perfil_horizontal") descontoPerfilAltura = config.descontoPerfilAltura;
                        else if (modulo.tipoPuxador === "perfil_vertical") descontoPerfilLargura = config.descontoPerfilLargura;

                        const { altura: modA = 0, largura: modL = 0, profundidade: modP = 0, ladoA: modLadoA = 0, ladoB: modLadoB = 0, profA: modProfA = 0, profB: modProfB = 0 } = modulo;
                        const pecasDoModulo = [];
                        let numFrentesGaveta = 0;
                        let medidaCorredicaParaModulo = 0;

                        if (modulo.corredicas && modulo.corredicas.length > 0) {
                            const corredicaBase = modulo.corredicas[0];

                            (modulo.pecas || []).forEach((peca) => {
                                const formulaQtd = String(peca.qtd || "1");
                                if (peca.nome.toLowerCase().includes("frente de gaveta")) {
                                    numFrentesGaveta += Math.ceil(evaluateFormula(formulaQtd.replace(/\bA\b/g, modA).replace(/\bL\b/g, modL).replace(/\bP\b/g, modP)));
                                }
                            });

                            const corredicaFormulaReplacerParaMedida = (f) =>
                                f
                                    ? String(f)
                                          .replace(/\bA\b/g, modA)
                                          .replace(/\bL\b/g, modL)
                                          .replace(/\bP\b/g, modP)
                                          .replace(/\bNumGavetas\b/g, numFrentesGaveta)
                                          .replace(/\bEspInterna\b/g, config.espInterna)
                                          .replace(/\bEspExterna\b/g, config.espExterna)
                                          .replace(/\bDescFundoArmario\b/g, config.descFundoArmario)
                                          .replace(/\bFolgaCorredicaFrente\b/g, modulo.folgaCorredicaFrente)
                                          .replace(/\bFolgaCorredicaFundo\b/g, modulo.folgaCorredicaFundo)
                                    : "0";

                            const medidaAlvo = evaluateFormula(corredicaFormulaReplacerParaMedida(corredicaBase.medidaFormula));
                            medidaCorredicaParaModulo = findCorredicaIdeal(medidaAlvo);
                        }

                        (modulo.pecas || []).forEach((peca) => {
                            const formulaReplacer = (f) =>
                                f
                                    ? String(f)
                                          .replace(/\bA\b/g, modA)
                                          .replace(/\bL\b/g, modL)
                                          .replace(/\bP\b/g, modP)
                                          .replace(/\bLadoA\b/g, modLadoA)
                                          .replace(/\bLadoB\b/g, modLadoB)
                                          .replace(/\bProfA\b/g, modProfA)
                                          .replace(/\bProfB\b/g, modProfB)
                                          .replace(/\bMedidaCorredica\b/g, medidaCorredicaParaModulo)
                                          .replace(/\bEspInterna\b/g, config.espInterna)
                                          .replace(/\bEspExterna\b/g, config.espExterna)
                                          .replace(/\bDescFundoArmario\b/g, config.descFundoArmario)
                                          .replace(/\bFolgaPortaAltura\b/g, config.folgaPortaAltura)
                                          .replace(/\bFolgaPortaLargura\b/g, config.folgaPortaLargura)
                                          .replace(/\bFolgaGaveta\b/g, config.folgaGaveta)
                                          .replace(/\bFolgaCorredicaFrente\b/g, modulo.folgaCorredicaFrente)
                                          .replace(/\bFolgaCorredicaFundo\b/g, modulo.folgaCorredicaFundo)
                                          .replace(/\bAjustePuxadorAltura\b/g, ajustePuxadorAltura)
                                          .replace(/\bAjustePuxadorLargura\b/g, ajustePuxadorLargura)
                                          .replace(/\bDescontoPerfilAltura\b/g, descontoPerfilAltura)
                                          .replace(/\bDescontoPerfilLargura\b/g, descontoPerfilLargura)
                                          .replace(/\bDescAlturaBaseGav\b/g, modulo.descAlturaBaseGav)
                                          .replace(/\bDescAlturaLateralGav\b/g, modulo.descAlturaLateralGav)
                                    : "0";

                            try {
                                const alturaFinal = evaluateFormula(formulaReplacer(peca.altura));
                                const larguraFinal = evaluateFormula(formulaReplacer(peca.largura));
                                const qtdFinal = Math.ceil(evaluateFormula(formulaReplacer(peca.qtd)));

                                let espessuraFinal, corMaterialKey;
                                const espessuraCustomFormula = peca.espessura || "";
                                if (espessuraCustomFormula) {
                                    espessuraFinal = evaluateFormula(formulaReplacer(espessuraCustomFormula));
                                }
                                if (!espessuraFinal || espessuraFinal <= 0) {
                                    if (modulo.isPecaAvulsa) {
                                        espessuraFinal = modulo.espessura;
                                    } else if (peca.tipoMaterial === "externa") {
                                        espessuraFinal = config.espExterna;
                                    } else if (peca.tipoMaterial === "fundo") {
                                        espessuraFinal = config.espFundo;
                                    } else {
                                        espessuraFinal = config.espInterna;
                                    }
                                }

                                if (modulo.isPecaAvulsa) {
                                    corMaterialKey = modulo.corMaterialExterna;
                                } else if (peca.tipoMaterial === "externa") {
                                    corMaterialKey = modulo.corMaterialExterna;
                                } else if (peca.tipoMaterial === "fundo") {
                                    corMaterialKey = modulo.corMaterialInterna;
                                } else {
                                    corMaterialKey = modulo.corMaterialInterna;
                                }

                                const corBordaPrioridade = peca.tipoBorda === "externa" ? modulo.corBordaExterna : modulo.corBordaInterna;
                                const corBordaModulo = peca.tipoBorda === "externa" ? modulo.corBordaExternaModulo : modulo.corBordaInternaModulo;
                                const corMaterialComoBorda = peca.tipoBorda === "externa" ? modulo.corMaterialExterna : modulo.corMaterialInterna;
                                const corBordaKey = corBordaPrioridade || corBordaModulo || corMaterialComoBorda;

                                pecasDoModulo.push({
                                    ...peca,
                                    qtd: qtdFinal,
                                    alturaFinal,
                                    larguraFinal,
                                    espessura: espessuraFinal,
                                    id: `peca_${Date.now()}_${Math.random()}`,
                                    corMaterial: corMaterialKey,
                                    corBorda: corBordaKey,
                                    moduloInstanceId: modulo.instanceId,
                                });
                                const isDoorOrFront = peca.nome.toLowerCase().includes("porta") || peca.nome.toLowerCase().includes("frente");

                                if (modulo.tipoPuxador.startsWith("perfil") && perfilPadraoKey && isDoorOrFront) {
                                    const perfilData = AppData.catalogoPerfis[perfilPadraoKey];
                                    if (perfilData) {
                                        const valor = modulo.tipoPuxador === "perfil_horizontal" ? larguraFinal / 1000 : alturaFinal / 1000;
                                        listaFerragensGerada.push({
                                            ...perfilData,
                                            nome: perfilData.nome,
                                            valor: valor * qtdFinal,
                                            unidade: "M",
                                            id: `perfil_auto_${Date.now()}_${Math.random()}`,
                                            moduloInstanceId: modulo.instanceId,
                                            source: "automatica",
                                        });
                                    }
                                } else if (modulo.tipoPuxador === "externo" && isDoorOrFront) {
                                    totalPuxadoresExternos += qtdFinal;
                                }

                                (peca.ferragensAssociadas || []).forEach((ferragemAssoc) => {
                                    const ferragemData = AppData.catalogoFerragens[ferragemAssoc.key];
                                    if (!ferragemData) return;
                                    const pecaFormulaReplacer = (f) =>
                                        f
                                            ? String(f)
                                                  .replace(/\bA\b/g, alturaFinal)
                                                  .replace(/\bL\b/g, larguraFinal)
                                                  .replace(/\bQTD\b/g, qtdFinal)
                                                  .replace(/\bP\b/g, modP)
                                                  .replace(/\bMedidaCorredica\b/g, medidaCorredicaParaModulo)
                                                  .replace(/\bFolgaCorredicaFrente\b/g, modulo.folgaCorredicaFrente)
                                                  .replace(/\bFolgaCorredicaFundo\b/g, modulo.folgaCorredicaFundo)
                                                  .replace(/\bDescAlturaBaseGav\b/g, modulo.descAlturaBaseGav)
                                                  .replace(/\bDescAlturaLateralGav\b/g, modulo.descAlturaLateralGav)
                                            : "0";
                                    const qtdFerragemFinal = evaluateFormula(pecaFormulaReplacer(ferragemAssoc.qtdFormula));

                                    if (qtdFerragemFinal > 0) {
                                        if (ferragemData.tipo === "corredica" && ferragemAssoc.medidaFormula) {
                                            const medidaAlvo = evaluateFormula(pecaFormulaReplacer(ferragemAssoc.medidaFormula));
                                            const medidaIdeal = findCorredicaIdeal(medidaAlvo);
                                            if (medidaIdeal) {
                                                const keyCorredicaIdeal = Object.keys(AppData.catalogoFerragens).find(
                                                    (k) => AppData.catalogoFerragens[k].tipo === "corredica" && AppData.catalogoFerragens[k].nome.includes(String(medidaIdeal))
                                                );
                                                listaFerragensGerada.push({
                                                    ...(keyCorredicaIdeal ? AppData.catalogoFerragens[keyCorredicaIdeal] : { ...ferragemData, nome: `${ferragemData.nome} (${medidaIdeal}mm)` }),
                                                    valor: qtdFerragemFinal,
                                                    id: `fer_assoc_${Date.now()}_${Math.random()}`,
                                                    moduloInstanceId: modulo.instanceId,
                                                    source: "associada_peca",
                                                });
                                            }
                                        } else {
                                            listaFerragensGerada.push({ ...ferragemData, valor: qtdFerragemFinal, id: `fer_assoc_${Date.now()}_${Math.random()}`, moduloInstanceId: modulo.instanceId, source: "associada_peca" });
                                        }
                                    }
                                });
                            } catch (e) {
                                console.error(`Erro na pe√ßa '${peca.nome}':`, e);
                            }
                        });
                        listaPecasGerada.push({
                            tipo: "header",
                            nome: modulo.nome,
                            A: modulo.altura,
                            L: modulo.largura,
                            P: modulo.profundidade,
                            LadoA: modulo.ladoA,
                            LadoB: modulo.ladoB,
                            ProfA: modulo.profA,
                            ProfB: modulo.profB,
                            tipoModulo: modulo.tipoModulo,
                            imagem: modulo.imagem,
                            instanceId: modulo.instanceId,
                            isPecaAvulsa: modulo.isPecaAvulsa,
                            espessura: modulo.espessura,
                        });
                        listaPecasGerada.push(...pecasDoModulo);

                        (modulo.ferragens || []).forEach((f) => {
                            if (AppData.catalogoFerragens[f.key])
                                listaFerragensGerada.push({ ...AppData.catalogoFerragens[f.key], valor: f.valor, id: `fer_mod_${Date.now()}_${Math.random()}`, moduloInstanceId: modulo.instanceId, source: "geral_modulo" });
                        });

                        if (modulo.corredicas && modulo.corredicas.length > 0 && medidaCorredicaParaModulo > 0) {
                            const corredicaBase = modulo.corredicas[0];
                            const keyCorredicaIdeal = Object.keys(AppData.catalogoFerragens).find((k) => AppData.catalogoFerragens[k].tipo === "corredica" && AppData.catalogoFerragens[k].nome.includes(String(medidaCorredicaParaModulo)));

                            if (keyCorredicaIdeal) {
                                listaFerragensGerada.push({
                                    ...AppData.catalogoFerragens[keyCorredicaIdeal],
                                    valor:
                                        numFrentesGaveta *
                                        (corredicaBase.qtdFormula.toLowerCase().includes("numgavetas")
                                            ? 1
                                            : evaluateFormula(
                                                  String(corredicaBase.qtdFormula)
                                                      .replace(/\bA\b/g, modA)
                                                      .replace(/\bL\b/g, modL)
                                                      .replace(/\bP\b/g, modP)
                                                      .replace(/\bNumGavetas\b/g, 1)
                                              )),
                                    id: `corredica_mod_${Date.now()}_${Math.random()}`,
                                    moduloInstanceId: modulo.instanceId,
                                    source: "modulo_corredica",
                                });
                            } else {
                                listaFerragensGerada.push({
                                    ...AppData.catalogoFerragens[corredicaBase.key],
                                    nome: `${AppData.catalogoFerragens[corredicaBase.key].nome} (${medidaCorredicaParaModulo}mm)`,
                                    valor:
                                        numFrentesGaveta *
                                        (corredicaBase.qtdFormula.toLowerCase().includes("numgavetas")
                                            ? 1
                                            : evaluateFormula(
                                                  String(corredicaBase.qtdFormula)
                                                      .replace(/\bA\b/g, modA)
                                                      .replace(/\bL\b/g, modL)
                                                      .replace(/\bP\b/g, modP)
                                                      .replace(/\bNumGavetas\b/g, 1)
                                              )),
                                    id: `corredica_mod_${Date.now()}_${Math.random()}`,
                                    moduloInstanceId: modulo.instanceId,
                                    source: "modulo_corredica_fallback",
                                });
                            }
                        }
                    });

                    if (config.puxadorExternoPadrao && AppData.catalogoFerragens[config.puxadorExternoPadrao] && totalPuxadoresExternos > 0) {
                        listaFerragensGerada.push({ ...AppData.catalogoFerragens[config.puxadorExternoPadrao], valor: totalPuxadoresExternos, id: `puxador_auto_${Date.now()}`, source: "automatica" });
                    }

                    projetoAtual.ferragensExtras.forEach((f) => listaFerragensGerada.push({ ...f, id: f.instanceId, source: "extra" }));
                    renderizarTabelasEOrcamento();
                    outputSection.style.display = "block";
                    outputSection.scrollIntoView({ behavior: "smooth" });
                    getEl("nomeCliente").value = ultimoNomeCliente;
                    getEl("nomeAmbiente").value = ultimoNomeAmbiente;
                };

                const recalcularOrcamentoTotal = () => {
                    const config = AppData.configCalculo;

                    const custoMaterial = orcamentoFinalData.custoTotalMaterial || 0;
                    const lucroMaterialValor = custoMaterial * (config.margemLucroMaterial / 100);
                    const totalFinal = custoMaterial + lucroMaterialValor;

                    getEl("orcamento-custo-total-material").textContent = `R$ ${custoMaterial.toFixed(2)}`;
                    getEl("orcamento-lucro-material").textContent = `R$ ${lucroMaterialValor.toFixed(2)}`;
                    getEl("orcamento-total").textContent = `TOTAL GERAL: R$ ${totalFinal.toFixed(2)}`;
                };

                const getShoppingListData = () => {
                    const config = AppData.configCalculo;
                    const areaChapa = (config.chapaAltura / 1000) * (config.chapaLargura / 1000);
                    const metragemPorMaterial = {};
                    const metragemPorBorda = {};

                    listaPecasGerada.forEach((item) => {
                        if (item.tipo !== "header") {
                            const { qtd, alturaFinal, larguraFinal, espessura, corMaterial, corBorda, bordaA1, bordaA2, bordaL1, bordaL2 } = item;
                            const quantity = parseInt(qtd || 1);
                            const corMaterialData = AppData.coresMDF[corMaterial];
                            const corBordaData = AppData.coresBorda[corBorda];

                            const corMaterialNome = corMaterialData ? corMaterialData.nome : "Material Desconhecido";
                            const corBordaNome = corBordaData ? corBordaData.nome : "Borda Desconhecida";

                            const areaPecaM2 = (alturaFinal / 1000) * (larguraFinal / 1000) * quantity;
                            if (areaPecaM2 > 0) {
                                const materialKey = `${corMaterialNome} ${espessura}mm`;
                                metragemPorMaterial[materialKey] = (metragemPorMaterial[materialKey] || 0) + areaPecaM2;
                            }

                            let comprimentoBordaMM = [bordaA1, bordaA2, bordaL1, bordaL2].filter(Boolean).length * alturaFinal + [bordaL1, bordaL2].filter(Boolean).length * larguraFinal;
                            const metragemPecaBordaM = (comprimentoBordaMM / 1000) * quantity;
                            if (metragemPecaBordaM > 0) {
                                metragemPorBorda[corBordaNome] = (metragemPorBorda[corBordaNome] || 0) + metragemPecaBordaM;
                            }
                        }
                    });

                    const ferragensAgrupadas = {};
                    listaFerragensGerada.forEach((f) => {
                        if (f && f.nome && f.unidade) {
                            const key = `${f.nome}_${f.unidade}_${f.tipo}`;
                            if (!ferragensAgrupadas[key]) {
                                ferragensAgrupadas[key] = { nome: f.nome, unidade: f.unidade, preco: f.preco || 0, tipo: f.tipo || "geral", valor: 0 };
                            }
                            ferragensAgrupadas[key].valor += f.valor;
                        }
                    });

                    const groups = [];

                    const mdfItems = Object.keys(metragemPorMaterial).map((key) => {
                        const m2 = metragemPorMaterial[key];
                        let textoChapas = "";
                        if (areaChapa > 0) {
                            const numChapas = Math.ceil(m2 / areaChapa);
                            textoChapas = ` (${numChapas} chapa${numChapas > 1 ? "s" : ""})`;
                        }
                        return { name: `Chapa ${key}`, quantity: `${m2.toFixed(2)} m¬≤${textoChapas}` };
                    });
                    if (mdfItems.length > 0) groups.push({ title: "== CHAPAS DE MDF ==", items: mdfItems });

                    const bordaItems = Object.keys(metragemPorBorda).map((cor) => ({ name: `Fita de Borda ${cor}`, quantity: `${Math.ceil(metragemPorBorda[cor])} metros` }));
                    if (bordaItems.length > 0) groups.push({ title: "== FITAS DE BORDA ==", items: bordaItems });

                    const ferragemItems = [];
                    const perfilItems = [];
                    Object.values(ferragensAgrupadas).forEach((fAggregated) => {
                        if (fAggregated.valor > 0) {
                            let itemDisplayName = fAggregated.nome;
                            let itemDisplayQuantity = `${Math.ceil(fAggregated.valor)} ${fAggregated.unidade}`;

                            if (fAggregated.tipo === "corredica") {
                                const match = fAggregated.nome.match(/(\d+)mm/);
                                if (match && match[1]) {
                                    itemDisplayName = fAggregated.nome.replace(/\s?\d+mm$/, "").trim() + ` ${parseInt(match[1]) / 10}cm`;
                                }
                            }

                            if (fAggregated.unidade === "M" && (itemDisplayName.toLowerCase().includes("puxador") || itemDisplayName.toLowerCase().includes("perfil"))) {
                                const totalM = fAggregated.valor;
                                const numBarras = Math.ceil(totalM / config.barraPerfilComprimento);
                                const textoBarras = `(${numBarras} barra${numBarras > 1 ? "s" : ""} de ${config.barraPerfilComprimento.toFixed(2)}m)`;
                                perfilItems.push({ name: itemDisplayName, quantity: `${totalM.toFixed(2)} metros ${textoBarras}` });
                            } else {
                                ferragemItems.push({ name: itemDisplayName, quantity: itemDisplayQuantity });
                            }
                        }
                    });

                    if (perfilItems.length > 0) groups.push({ title: "== PERFIS ==", items: perfilItems });
                    if (ferragemItems.length > 0) groups.push({ title: "== FERRAGENS ==", items: ferragemItems });

                    return groups;
                };

                const renderizarTabelasEOrcamento = () => {
                    const config = AppData.configCalculo;
                    const itensOrcamento = {};

                    // 1. C√°lculos de Custos (Mant√©m a l√≥gica original para garantir precis√£o no or√ßamento)
                    projetoAtual.modulos.forEach((mod) => {
                        itensOrcamento[mod.instanceId] = {
                            nome: mod.nome,
                            dimensoes: mod.isPecaAvulsa
                                ? `(A:${mod.altura} L:${mod.largura} E:${mod.espessura})`
                                : mod.tipoModulo === "reto"
                                ? `(A:${mod.altura} x L:${mod.largura} x P:${mod.profundidade})`
                                : `(A:${mod.altura} LadoA:${mod.ladoA} LadoB:${mod.ladoB} ProfA:${mod.profA} ProfB:${mod.profB})`,
                            custoMDF: 0,
                            custoBorda: 0,
                            custoFerragens: 0,
                        };
                    });
                    projetoAtual.ferragensExtras.forEach((f) => {
                        itensOrcamento[f.instanceId] = { nome: `${f.valor}${f.unidade} de ${f.nome} (Extra)`, dimensoes: "", custoMDF: 0, custoBorda: 0, custoFerragens: f.valor * (f.preco || 0) };
                    });

                    listaFerragensGerada.forEach((f) => {
                        if (f.moduloInstanceId && itensOrcamento[f.moduloInstanceId]) itensOrcamento[f.moduloInstanceId].custoFerragens += f.valor * (f.preco || 0);
                    });
                    
                    listaPecasGerada.forEach((item) => {
                        if (item.tipo === "header" || !item.moduloInstanceId || !itensOrcamento[item.moduloInstanceId]) return;
                        const { qtd, alturaFinal, larguraFinal, corMaterial, corBorda, bordaA1, bordaA2, bordaL1, bordaL2 } = item;
                        const corMaterialData = AppData.coresMDF[corMaterial] || { preco: 0 };
                        const corBordaData = AppData.coresBorda[corBorda] || { preco: config.custoBorda };
                        const quantity = parseInt(qtd || 1);
                        itensOrcamento[item.moduloInstanceId].custoMDF += (alturaFinal / 1000) * (larguraFinal / 1000) * quantity * (corMaterialData.preco || 0);
                        let comprimentoBordaMM = [bordaA1, bordaA2].filter(Boolean).length * alturaFinal + [bordaL1, bordaL2].filter(Boolean).length * larguraFinal;
                        itensOrcamento[item.moduloInstanceId].custoBorda += (comprimentoBordaMM / 1000) * quantity * (corBordaData.preco || 0);
                    });

                    Object.values(itensOrcamento).forEach((item) => {
                        item.custoTotalMaterial = item.custoMDF + item.custoBorda + item.custoFerragens;
                        item.valorVendaMaterial = item.custoTotalMaterial * (1 + config.margemLucroMaterial / 100);
                    });

                    orcamentoFinalData.itensOrcamento = itensOrcamento;
                    orcamentoFinalData.custoTotalMaterial = Object.values(itensOrcamento).reduce((total, item) => total + item.custoTotalMaterial, 0);

                    // 2. Renderiza√ß√£o da Tabela de Pe√ßas (AGORA COM AGRUPAMENTO)
                    listaPecasTbody.innerHTML = "";
                    
                    // Estrutura para agrupar visualmente
                    const gruposTabela = {};
                    let currentGroupKey = null;

                    listaPecasGerada.forEach((item) => {
                        if (item.tipo === "header") {
                            // Cria uma chave baseada nas caracter√≠sticas do m√≥dulo (sem o ID da inst√¢ncia)
                            const dimStr = item.isPecaAvulsa 
                                ? `${item.A}-${item.L}-${item.espessura}` 
                                : `${item.A}-${item.L}-${item.P}-${item.LadoA}-${item.LadoB}`;
                            
                            const key = `GRP_${item.nome}_${dimStr}_${item.tipoModulo}`;
                            currentGroupKey = key;

                            if (!gruposTabela[key]) {
                                gruposTabela[key] = {
                                    header: item,
                                    qtdModulos: 0,
                                    pecasAgrupadas: {}, // Agrupa pe√ßas id√™nticas dentro deste m√≥dulo
                                    valorTotalVenda: 0,
                                    instanceIds: []
                                };
                            }
                            gruposTabela[key].qtdModulos++;
                            gruposTabela[key].instanceIds.push(item.instanceId);
                            
                            // Soma o valor deste m√≥dulo ao total do grupo
                            if(itensOrcamento[item.instanceId]) {
                                gruposTabela[key].valorTotalVenda += itensOrcamento[item.instanceId].valorVendaMaterial;
                            }

                        } else {
                            // √â uma pe√ßa, adiciona ao grupo atual
                            if (currentGroupKey && gruposTabela[currentGroupKey]) {
                                const grupo = gruposTabela[currentGroupKey];
                                
                                // Chave √∫nica da pe√ßa (Nome + Dimens√µes + Materiais + Bordas)
                                const bordasStr = [item.bordaA1, item.bordaA2, item.bordaL1, item.bordaL2].join('-');
                                const pecaKey = `${item.nome}_${item.alturaFinal}_${item.larguraFinal}_${item.espessura}_${item.corMaterial}_${item.corBorda}_${bordasStr}`;
                                
                                if (!grupo.pecasAgrupadas[pecaKey]) {
                                    grupo.pecasAgrupadas[pecaKey] = { ...item, qtdTotal: 0 };
                                }
                                grupo.pecasAgrupadas[pecaKey].qtdTotal += parseFloat(item.qtd);
                            }
                        }
                    });

                    // Desenha a tabela baseada nos grupos
                    Object.values(gruposTabela).forEach(grupo => {
                        const itemHeader = grupo.header;
                        
                                               
                        // Linha de Cabe√ßalho do Grupo
                        const rowHeader = listaPecasTbody.insertRow();
                        rowHeader.className = "group-header";
                        const cellHeader = rowHeader.insertCell();
                        cellHeader.colSpan = 9;
                        
                        let dimensoesTexto = itemHeader.isPecaAvulsa
                            ? `(A:${itemHeader.A} L:${itemHeader.L} E:${itemHeader.espessura})`
                            : itemHeader.tipoModulo === "reto"
                            ? `(A:${itemHeader.A} x L:${itemHeader.L} x P:${itemHeader.P})`
                            : `(A:${itemHeader.A} LadoA:${itemHeader.LadoA}...)`;

                        const textoQtd = grupo.qtdModulos > 1 ? `<span style="background:var(--cor-principal); color:#fff; padding:2px 8px; border-radius:12px; font-size:0.9em;">${grupo.qtdModulos} unidades</span>` : "";

                        cellHeader.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                                <span>
                                    <strong>${itemHeader.isPecaAvulsa ? "Pe√ßa:" : "M√≥dulo:"} ${itemHeader.nome}</strong> 
                                    ${dimensoesTexto} ${textoQtd}
                                </span>
                                <span style="font-size: 1.1em;">
                                    <strong>Total: R$ ${grupo.valorTotalVenda.toFixed(2)}</strong>
                                </span>
                            </div>`;

                        // Linhas das Pe√ßas Agrupadas
                        Object.values(grupo.pecasAgrupadas).forEach(peca => {
                            const corMaterialNome = (AppData.coresMDF[peca.corMaterial] || { nome: "(Exclu√≠do)" }).nome;
                            const corBordaNome = (AppData.coresBorda[peca.corBorda] || { nome: "(Exclu√≠do)" }).nome;
                            let bordasStr = [peca.bordaA1 && "A1", peca.bordaA2 && "A2", peca.bordaL1 && "L1", peca.bordaL2 && "L2"].filter(Boolean).join(" ");
                            
                            const row = listaPecasTbody.insertRow();
                            // Nota: Removemos o data-id e as a√ß√µes de edi√ß√£o individual aqui pois s√£o pe√ßas agrupadas
                            row.innerHTML = `
                                    <td>${peca.nome}</td>
                                    <td style="font-weight:bold; color:var(--cor-principal); text-align:center;">${peca.qtdTotal}</td>
                                    <td>${formatarNumero(peca.alturaFinal)}</td>
                                    <td>${formatarNumero(peca.larguraFinal)}</td>
                                    <td>${peca.espessura}</td>
                                    <td>${corMaterialNome}</td>
                                    <td>${bordasStr.trim()}</td>
                                    <td>${corBordaNome}</td>
                                    <td class="acoes" style="color:#ccc; font-size:0.8em; text-align:center;">
                                        (Agrupado)
                                    </td>`;
                        });
                    });

                    // 3. Renderiza√ß√£o da Tabela de Ferragens (Mant√©m l√≥gica agrupada)
                    listaFerragensTbody.innerHTML = "";
                    const ferragensAgrupadas = {};
                    listaFerragensGerada.forEach((f) => {
                        if (f && f.nome) {
                            const key = `${f.nome}_${f.unidade}_${f.tipo}`;
                            if (!ferragensAgrupadas[key]) ferragensAgrupadas[key] = { ...f, valor: 0, ids: [] };
                            ferragensAgrupadas[key].valor += f.valor;
                            if (ferragensAgrupadas[key].ids && Array.isArray(ferragensAgrupadas[key].ids)) {
                                ferragensAgrupadas[key].ids.push(f.id);
                            }
                        }
                    });
                    Object.values(ferragensAgrupadas).forEach((f) => {
                        const custoItemTotal = f.valor * f.preco;
                        let displayName = f.nome;
                        if (f.tipo === "corredica") {
                            const match = f.nome.match(/(\d+)mm/);
                            if (match && match[1]) displayName = f.nome.replace(/\s?\d+mm$/, "").trim() + ` ${parseInt(match[1]) / 10}cm`;
                        }
                        const row = listaFerragensTbody.insertRow();
                        row.innerHTML = `<td>${displayName}</td><td>${f.valor.toFixed(f.unidade === "UN" || f.unidade === "PAR" ? 0 : 2)} ${f.unidade}</td><td>R$ ${f.preco.toFixed(2)}</td><td>R$ ${custoItemTotal.toFixed(
                            2
                        )}</td><td><button class="btn-danger btn-sm btn-remover-ferragem-final" data-ids="${f.ids.join(",")}">X</button></td>`;
                    });

                    // 4. Lista de Compras (Shopping List)
                    const shoppingListHTML = getShoppingListData()
                        .map((group) => {
                            let groupRows = `<tr class="group-header-shopping"><td colspan="2">${group.title}</td></tr>`;
                            group.items.forEach((item) => {
                                groupRows += `<tr><td>${item.name}</td><td>${item.quantity}</td></tr>`;
                            });
                            return groupRows;
                        })
                        .join("");
                    getEl("lista-materiais-compra").querySelector("tbody").innerHTML = shoppingListHTML;

                    recalcularOrcamentoTotal();
                };

                const exportarPDFProducao = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const cliente = getEl("nomeCliente").value || "N√£o informado";
                    const ambiente = getEl("nomeAmbiente").value || "N√£o especificado";

                    doc.setFontSize(18);
                    doc.text("Lista de Produ√ß√£o", 14, 22);
                    doc.setFontSize(11);
                    doc.setFont(undefined, "normal");
                    doc.text(`Projeto: ${cliente} - ${ambiente}`, 14, 28);
                    let lastY = 36;

                    const pecasAgrupadas = listaPecasGerada.reduce((acc, item) => {
                        if (item.tipo === "header") acc.push({ ...item, pecas: [] });
                        else if (acc.length > 0) acc[acc.length - 1].pecas.push(item);
                        return acc;
                    }, []);

                    pecasAgrupadas.forEach((grupo) => {
                        if (lastY > 260) {
                            doc.addPage();
                            lastY = 30;
                        }
                        doc.setFontSize(12);
                        doc.setFont(undefined, "bold");
                        let dimensoesTexto = grupo.isPecaAvulsa
                            ? `(A:${grupo.A} L:${grupo.L} E:${grupo.espessura})`
                            : grupo.tipoModulo === "reto"
                            ? `(A:${grupo.A} x L:${grupo.L} x P:${grupo.P})`
                            : `(A:${grupo.A} LadoA:${grupo.LadoA}...)`;
                        doc.text(`${grupo.isPecaAvulsa ? "Pe√ßa:" : "M√≥dulo:"} ${grupo.nome} ${dimensoesTexto}`, 14, lastY);
                        let tableStartY = lastY + 7;

                        if (grupo.imagem) {
                            try {
                                const imgWidth = 30,
                                    imgHeight = 30;
                                const imgX = doc.internal.pageSize.getWidth() - 14 - imgWidth,
                                    imgY = lastY - 7;
                                doc.addImage(grupo.imagem, "JPEG", imgX, imgY, imgWidth, imgHeight);
                                tableStartY = Math.max(tableStartY, imgY + imgHeight + 2);
                            } catch (e) {
                                console.error("Erro ao adicionar imagem ao PDF:", e);
                            }
                        }

                        const body = grupo.pecas.map((peca) => {
                            let bordasStr = [peca.bordaA1 && "A1", peca.bordaA2 && "A2", peca.bordaL1 && "L1", peca.bordaL2 && "L2"].filter(Boolean).join(" ");
                            return [
                                peca.nome,
                                peca.qtd,
                                formatarNumero(peca.alturaFinal),
                                formatarNumero(peca.larguraFinal),
                                peca.espessura,
                                AppData.coresMDF[peca.corMaterial]?.nome || "N/A",
                                bordasStr.trim(),
                                AppData.coresBorda[peca.corBorda]?.nome || "N/A",
                            ];
                        });
                        doc.autoTable({ head: [["Nome Pe√ßa", "Qtd", "Altura", "Largura", "Esp.", "Material", "Bordas", "Cor Borda"]], body, startY: tableStartY, headStyles: { fillColor: [31, 41, 55] } });
                        lastY = doc.lastAutoTable.finalY + 10;
                    });

                    if (lastY > 260) {
                        doc.addPage();
                        lastY = 30;
                    }
                    doc.setFontSize(14);
                    doc.text("Lista de Compras (Ferragens)", 14, lastY);
                    const ferragensAgrupadasPDF = {};
                    listaFerragensGerada.forEach((f) => {
                        if (f && f.nome) {
                            const key = `${f.nome}_${f.unidade}_${f.tipo}`;
                            if (!ferragensAgrupadasPDF[key]) ferragensAgrupadasPDF[key] = { ...f, valor: 0 };
                            ferragensAgrupadasPDF[key].valor += f.valor;
                        }
                    });
                    const ferragensBody = Object.values(ferragensAgrupadasPDF).map((f) => {
                        let displayName = f.nome;
                        if (f.tipo === "corredica") {
                            const match = f.nome.match(/(\d+)mm/);
                            if (match && match[1]) displayName = f.nome.replace(/\s?\d+mm$/, "").trim() + ` ${parseInt(match[1]) / 10}cm`;
                        }
                        return [displayName, `${f.valor.toFixed(f.unidade === "UN" || f.unidade === "PAR" ? 0 : 2)} ${f.unidade}`];
                    });
                    doc.autoTable({ head: [["Nome Ferragem", "Qtd/Medida"]], body: ferragensBody, startY: lastY + 7, headStyles: { fillColor: [31, 41, 55] } });
                    const nomeArquivo = `lista-producao-${(cliente + "_" + ambiente).replace(/\s/g, "_") || "geral"}.pdf`;
                    doc.save(nomeArquivo);
                };

                const exportarPDFCliente = () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const cliente = getEl("nomeCliente").value || "N√£o informado";
                    const ambiente = getEl("nomeAmbiente").value || "N√£o especificado";
                    const corExternaNome = AppData.coresMDF[getEl("projCorExterna").value]?.nome || "N/A";
                    const corInternaNome = AppData.coresMDF[getEl("projCorInterna").value]?.nome || "N/A";
                    const cores = `Cor Externa: ${corExternaNome} | Cor Interna: ${corInternaNome}`;

                    doc.setFontSize(18);
                    doc.setFont(undefined, "bold");
                    doc.text("Proposta de Or√ßamento", 14, 22);
                    doc.setFontSize(11);
                    doc.setFont(undefined, "normal");
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Cliente: ${cliente}`, 14, 30);
                    doc.text(`Ambiente: ${ambiente}`, 14, 36);
                    doc.text(cores, 14, 42);

                    const bodyData = [];
                    let totalFinal = 0;
                    if (orcamentoFinalData.itensOrcamento) {
                        Object.values(orcamentoFinalData.itensOrcamento).forEach((item) => {
                            bodyData.push([`${item.nome} ${item.dimensoes}`, `R$ ${item.valorVendaMaterial.toFixed(2)}`]);
                            totalFinal += item.valorVendaMaterial;
                        });
                    }
                    doc.autoTable({ head: [["Descri√ß√£o do Item", "Valor"]], body: bodyData, startY: 50, theme: "striped", headStyles: { fillColor: [45, 55, 72] }, styles: { fontSize: 10 }, columnStyles: { 1: { halign: "right" } } });
                    let finalY = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(16);
                    doc.setFont(undefined, "bold");
                    doc.setTextColor(45, 55, 72);
                    doc.text("VALOR TOTAL DO PROJETO:", 14, finalY);
                    doc.text(`R$ ${totalFinal.toFixed(2)}`, 200, finalY, { align: "right" });
                    finalY += 20;
                    const termos = `Termos e Condi√ß√µes:\n1. O presente or√ßamento tem validade de 15 dias.\n2. Condi√ß√µes de pagamento: 50% de sinal e 50% na entrega.\n3. Prazo de entrega: 30 dias √∫teis ap√≥s a confirma√ß√£o do sinal.`;
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    doc.text(termos, 14, finalY, { maxWidth: 180 });
                    const nomeArquivo = `orcamento-${(cliente + "_" + ambiente).replace(/\s/g, "_") || "geral"}.pdf`;
                    doc.save(nomeArquivo);
                };

                // --- ATUALIZADO: Agrupamento da Planilha Excel ---
                const exportarExcel = () => {
                    const wb = XLSX.utils.book_new();
                    
                    // 1. Lista de Compras (J√° agrupada)
                    const shoppingData = getShoppingListData();
                    const shoppingListData = [];
                    shoppingData.forEach((group) => {
                        shoppingListData.push([group.title, ""]);
                        group.items.forEach((item) => {
                            shoppingListData.push([item.name, item.quantity]);
                        });
                        shoppingListData.push([]);
                    });
                    const wsShopping = XLSX.utils.aoa_to_sheet(shoppingListData);
                    wsShopping["!cols"] = [{ wch: 40 }, { wch: 30 }];
                    XLSX.utils.book_append_sheet(wb, wsShopping, "Lista de Compras");

                    // 2. Plano de Corte (AGORA COM AGRUPAMENTO NA EXPORTA√á√ÉO)
                    const pecasData = [["Nome Pe√ßa", "Qtd Total", "Altura", "Largura", "Espessura", "Material", "Bordas", "Cor Borda"]];
                    
                    // Recria o agrupamento para o Excel (pois listaPecasGerada √© bruta)
                    const gruposExcel = {};
                    let currentGroupKey = null;

                    listaPecasGerada.forEach((item) => {
                        if (item.tipo === "header") {
                            const dimStr = item.isPecaAvulsa 
                                ? `${item.A}-${item.L}-${item.espessura}` 
                                : `${item.A}-${item.L}-${item.P}-${item.LadoA}-${item.LadoB}`;
                            const key = `GRP_EXCEL_${item.nome}_${dimStr}_${item.tipoModulo}`;
                            currentGroupKey = key;

                            if (!gruposExcel[key]) {
                                gruposExcel[key] = { header: item, qtdModulos: 0, pecasAgrupadas: {} };
                            }
                            gruposExcel[key].qtdModulos++;
                        } else {
                            if (currentGroupKey && gruposExcel[currentGroupKey]) {
                                const grupo = gruposExcel[currentGroupKey];
                                const bordasStr = [item.bordaA1, item.bordaA2, item.bordaL1, item.bordaL2].join('-');
                                const pecaKey = `${item.nome}_${item.alturaFinal}_${item.larguraFinal}_${item.espessura}_${item.corMaterial}_${item.corBorda}_${bordasStr}`;
                                
                                if (!grupo.pecasAgrupadas[pecaKey]) {
                                    grupo.pecasAgrupadas[pecaKey] = { ...item, qtdTotal: 0 };
                                }
                                grupo.pecasAgrupadas[pecaKey].qtdTotal += parseFloat(item.qtd);
                            }
                        }
                    });

                    // Preenche os dados da planilha
                    Object.values(gruposExcel).forEach(grupo => {
                        const itemHeader = grupo.header;
                        const textoQtd = grupo.qtdModulos > 1 ? ` (${grupo.qtdModulos} unidades)` : "";
                        pecasData.push([`M√≥dulo: ${itemHeader.nome}${textoQtd}`]); // Cabe√ßalho do m√≥dulo

                        Object.values(grupo.pecasAgrupadas).forEach(peca => {
                            let bordasStr = [peca.bordaA1 && "A1", peca.bordaA2 && "A2", peca.bordaL1 && "L1", peca.bordaL2 && "L2"].filter(Boolean).join(" ");
                            pecasData.push([
                                peca.nome,
                                peca.qtdTotal, // Qtd somada
                                formatarNumero(peca.alturaFinal),
                                formatarNumero(peca.larguraFinal),
                                peca.espessura,
                                AppData.coresMDF[peca.corMaterial]?.nome || "N/A",
                                bordasStr.trim(),
                                AppData.coresBorda[peca.corBorda]?.nome || "N/A",
                            ]);
                        });
                    });

                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pecasData), "Plano de Corte");

                    // 3. Lista de Ferragens (Mant√©m igual)
                    const ferragensData = [["Nome Ferragem", "Qtd/Medida", "Unidade", "Pre√ßo Unit/M", "Pre√ßo Total"]];
                    const excelFerragensAgrupadas = {};
                    listaFerragensGerada.forEach((f) => {
                        if (f && f.nome) {
                            const key = `${f.nome}_${f.unidade}_${f.tipo}`;
                            if (!excelFerragensAgrupadas[key]) excelFerragensAgrupadas[key] = { ...f, valor: 0 };
                            excelFerragensAgrupadas[key].valor += f.valor;
                        }
                    });
                    Object.values(excelFerragensAgrupadas).forEach((f) => {
                        let displayName = f.nome;
                        if (f.tipo === "corredica") {
                            const match = f.nome.match(/(\d+)mm/);
                            if (match && match[1]) displayName = f.nome.replace(/\s?\d+mm$/, "").trim() + ` ${parseInt(match[1]) / 10}cm`;
                        }
                        ferragensData.push([displayName, f.valor.toFixed(f.unidade === "UN" || f.unidade === "PAR" ? 0 : 2), f.unidade, `R$ ${f.preco.toFixed(2)}`, `R$ ${(f.valor * f.preco).toFixed(2)}`]);
                    });
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ferragensData), "Lista de Ferragens");
                    
                    const cliente = getEl("nomeCliente").value.replace(/\s/g, "_") || "geral";
                    const ambiente = getEl("nomeAmbiente").value.replace(/\s/g, "_");
                    const nomeArquivo = `listagem-completa-${cliente}${ambiente ? "-" + ambiente : ""}.xlsx`;
                    XLSX.writeFile(wb, nomeArquivo);
                };

                const exportarParaCortcloud = () => {
                    if (listaPecasGerada.length === 0) return showToast("Primeiro, gere a listagem de pe√ßas.", "error");
                    let fileContent = "";
                    const espessuraFitaBorda = "0.4";
                    const cliente = getEl("nomeCliente").value.replace(/\s/g, "_") || "Projeto_Geral";
                    const ambiente = getEl("nomeAmbiente").value.replace(/\s/g, "_");
                    const infoCliente = `${cliente}${ambiente ? "_" + ambiente : ""}`;

                    listaPecasGerada.forEach((item) => {
                        if (item.tipo === "header") return;
                        const corMaterialNome = AppData.coresMDF[item.corMaterial]?.nome || item.corMaterial;
                        const linha = [
                            `1.0000.${item.espessura}.${corMaterialNome.replace(/\s/g, "")}.MDF`,
                            item.nome,
                            formatarNumero(item.alturaFinal),
                            formatarNumero(item.larguraFinal),
                            item.qtd,
                            infoCliente,
                            item.bordaA1 ? espessuraFitaBorda : "0",
                            item.bordaA2 ? espessuraFitaBorda : "0",
                            item.bordaL1 ? espessuraFitaBorda : "0",
                            item.bordaL2 ? espessuraFitaBorda : "0",
                            `MDF-${item.espessura}-${corMaterialNome.replace(/\s/g, "_")}`,
                            "",
                        ].join(";");
                        fileContent += linha + "\n";
                    });
                    const blob = new Blob([fileContent], { type: "text/plain;charset=utf-8" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `cortcloud_${infoCliente}_${new Date().getTime()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(url);
                    a.remove();
                    showToast("Arquivo para Cortcloud gerado!", "success");
                };

                const toggleHardwarePriceFields = () => {
                    const unidade = getEl("novaFerragemUnidade").value;
                    const show = unidade === "M";
                    getEl("campos-preco-barra-ferragem").style.display = show ? "grid" : "none";
                    getEl("labelPrecoFinalFerragem").textContent = show ? "Pre√ßo Final por Metro (R$/m)" : "Pre√ßo (R$)";
                };

                const calcularPrecoMetroFerragem = () => {
                    const precoBarra = parseFloat(getEl("novaFerragemPrecoBarra").value),
                        metragemBarra = parseFloat(getEl("novaFerragemMetragemBarra").value),
                        campoFinal = getEl("novaFerragemPreco");
                    if (!isNaN(precoBarra) && !isNaN(metragemBarra) && metragemBarra > 0) campoFinal.value = (precoBarra / metragemBarra).toFixed(2);
                    else campoFinal.value = "";
                };

                const resetHardwareForm = () => {
                    editingHardwareKey = null;
                    getEl("ferragem-form-titulo").textContent = "Adicionar Nova Ferragem";
                    getEl("novaFerragemNome").value = "";
                    getEl("novaFerragemNome").readOnly = false;
                    getEl("novaFerragemUnidade").value = "UN";
                    getEl("novaFerragemTipo").value = "geral";
                    getEl("novaFerragemUnidade").disabled = false;
                    getEl("novaFerragemPreco").value = "";
                    getEl("novaFerragemPrecoBarra").value = "";
                    getEl("novaFerragemMetragemBarra").value = "";
                    getEl("btnSalvarFerragem").textContent = "Adicionar";
                    getEl("btnSalvarFerragem").classList.replace("btn-success", "btn-primary");
                    getEl("btnCancelarEdicaoFerragem").style.display = "none";
                    getEl("novaFerragemPreview").src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    currentImageUrl.hardware = null;
                    toggleHardwarePriceFields();
                };

                const resetMaterialForm = () => {
                    editingMaterialKey = null;
                    editingMaterialType = null;
                    getEl("material-form-titulo").textContent = "Adicionar Novo Material";
                    getEl("novoMaterialTipo").disabled = false;
                    getEl("novoMaterialNome").readOnly = false;
                    getEl("novoMaterialNome").value = "";
                    getEl("novoMaterialPrecoChapa").value = "";
                    getEl("novoMaterialPrecoCalculado").value = "";
                    getEl("novoMaterialPrecoRoloBorda").value = "";
                    getEl("novoMaterialMetragemRoloBorda").value = "";
                    getEl("novoMaterialPrecoFinalBorda").value = "";
                    getEl("btnAddMaterial").textContent = "Adicionar ao Cat√°logo";
                    getEl("btnAddMaterial").classList.replace("btn-success", "btn-primary");
                    getEl("btnCancelarEdicaoMaterial").style.display = "none";
                };

                const carregarMaterialParaEdicao = (key, type) => {
                    const item = AppData[type][key];
                    if (!item) return;
                    resetMaterialForm();
                    editingMaterialKey = key;
                    editingMaterialType = type;
                    getEl("novoMaterialTipo").value = type === "coresMDF" ? "mdf" : "borda";
                    getEl("novoMaterialTipo").disabled = true;
                    toggleMaterialPriceFields();
                    getEl("novoMaterialNome").value = item.nome;
                    getEl("novoMaterialNome").readOnly = true;
                    getEl("novoMaterialPreview").src = item.imagem || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    currentImageUrl.material = item.imagem;
                    if (type === "coresMDF") {
                        getEl("novoMaterialPrecoChapa").value = item.precoChapa ? item.precoChapa.toFixed(2) : "";
                        getEl("novoMaterialPrecoCalculado").value = item.preco ? item.preco.toFixed(2) : "";
                    } else {
                        getEl("novoMaterialPrecoFinalBorda").value = item.preco.toFixed(2);
                    }
                    getEl("material-form-titulo").textContent = `Editando: ${item.nome}`;
                    getEl("btnAddMaterial").textContent = "Salvar Altera√ß√µes";
                    getEl("btnAddMaterial").classList.replace("btn-primary", "btn-success");
                    getEl("btnCancelarEdicaoMaterial").style.display = "inline-flex";
                };

                const carregarFerragemParaEdicao = (key) => {
                    const ferragem = AppData.catalogoFerragens[key];
                    if (!ferragem) return;
                    resetHardwareForm();
                    editingHardwareKey = key;
                    getEl("ferragem-form-titulo").textContent = `Editando: ${ferragem.nome}`;
                    getEl("novaFerragemNome").value = ferragem.nome;
                    getEl("novaFerragemNome").readOnly = false;
                    getEl("novaFerragemTipo").value = ferragem.tipo || "geral";
                    getEl("novaFerragemUnidade").value = ferragem.unidade;
                    getEl("novaFerragemUnidade").disabled = false;
                    getEl("novaFerragemPreco").value = ferragem.preco;
                    getEl("novaFerragemPreview").src = ferragem.imagem || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    currentImageUrl.hardware = ferragem.imagem;
                    getEl("btnSalvarFerragem").textContent = "Salvar Altera√ß√µes";
                    getEl("btnSalvarFerragem").classList.replace("btn-primary", "btn-success");
                    getEl("btnCancelarEdicaoFerragem").style.display = "inline-flex";
                    toggleHardwarePriceFields();
                };

                const calcularPrecoMetroPerfil = () => {
                    const precoBarra = parseFloat(getEl("novoPerfilPrecoBarra").value),
                        metragemBarra = parseFloat(getEl("novoPerfilMetragemBarra").value),
                        campoFinal = getEl("novoPerfilPrecoMetro");
                    if (!isNaN(precoBarra) && !isNaN(metragemBarra) && metragemBarra > 0) campoFinal.value = (precoBarra / metragemBarra).toFixed(2);
                    else campoFinal.value = "";
                };

                const resetProfileForm = () => {
                    editingProfileKey = null;
                    getEl("perfil-form-titulo").textContent = "Adicionar Novo Perfil";
                    getEl("novoPerfilNome").value = "";
                    getEl("novoPerfilNome").readOnly = false;
                    getEl("novoPerfilPrecoBarra").value = "";
                    getEl("novoPerfilMetragemBarra").value = "";
                    getEl("novoPerfilPrecoMetro").value = "";
                    getEl("novoPerfilPreview").src = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    currentImageUrl.profile = null;
                    getEl("btnSalvarPerfil").textContent = "Adicionar";
                    getEl("btnSalvarPerfil").classList.replace("btn-success", "btn-primary");
                    getEl("btnCancelarEdicaoPerfil").style.display = "none";
                };

                const carregarPerfilParaEdicao = (key) => {
                    const perfil = AppData.catalogoPerfis[key];
                    if (!perfil) return;
                    resetProfileForm();
                    editingProfileKey = key;
                    getEl("perfil-form-titulo").textContent = `Editando: ${perfil.nome}`;
                    getEl("novoPerfilNome").value = perfil.nome;
                    getEl("novoPerfilNome").readOnly = true;
                    getEl("novoPerfilPrecoBarra").value = perfil.precoBarra;
                    getEl("novoPerfilMetragemBarra").value = perfil.metragemBarra;
                    getEl("novoPerfilPrecoMetro").value = perfil.preco.toFixed(2);
                    getEl("novoPerfilPreview").src = perfil.imagem || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
                    currentImageUrl.profile = perfil.imagem;
                    getEl("btnSalvarPerfil").textContent = "Salvar Altera√ß√µes";
                    getEl("btnSalvarPerfil").classList.replace("btn-primary", "btn-success");
                    getEl("btnCancelarEdicaoPerfil").style.display = "inline-flex";
                };

                const resetPecaPredefinidaForm = () => {
                    editingPecaKey = null;
                    getEl("peca-form-titulo").textContent = "Nova Pe√ßa Padr√£o";
                    getEl("novaPecaNome").value = "";
                    getEl("novaPecaQtd").value = "1";
                    getEl("novaPecaAltura").value = "";
                    getEl("novaPecaLargura").value = "";
                    getEl("novaPecaTipoMaterial").value = "interna";
                    getEl("novaPecaTipoBorda").value = "interna";
                    const btnSalvarPeca = getEl("btnSalvarPecaCatalogo");
                    btnSalvarPeca.textContent = "Adicionar Pe√ßa ao Cat√°logo";
                    btnSalvarPeca.classList.replace("btn-success", "btn-primary");
                    getEl("btnCancelarEdicaoPeca").style.display = "none";
                };

                const carregarPecaPredefinidaParaEdicao = (key) => {
                    const peca = AppData.pecasPredefinidas[key];
                    if (!peca) return;
                    resetPecaPredefinidaForm();
                    editingPecaKey = key;
                    getEl("peca-form-titulo").textContent = `Editando: ${peca.nome}`;
                    getEl("novaPecaNome").value = peca.nome;
                    getEl("novaPecaQtd").value = peca.qtd;
                    getEl("novaPecaAltura").value = peca.altura;
                    getEl("novaPecaLargura").value = peca.largura;
                    getEl("novaPecaTipoMaterial").value = peca.tipoMaterial;
                    getEl("novaPecaTipoBorda").value = peca.tipoBorda;
                    getEl("btnSalvarPecaCatalogo").textContent = "Salvar Altera√ß√µes";
                    getEl("btnSalvarPecaCatalogo").classList.replace("btn-primary", "btn-success");
                    getEl("btnCancelarEdicaoPeca").style.display = "inline-flex";
                };

                const toggleMaterialPriceFields = () => {
                    const tipo = getEl("novoMaterialTipo").value;
                    getEl("campos-preco-mdf").style.display = tipo === "mdf" ? "grid" : "none";
                    getEl("campos-preco-borda").style.display = tipo === "borda" ? "grid" : "none";
                };

                const atualizarTodosOsHelpersNoModal = (tipoModulo) => {
                    const isReto = tipoModulo === "reto";
                    const baseVars = isReto ? "A, L, P" : "A, LadoA, LadoB, ProfA, ProfB";
                    const otherVars = `MedidaCorredica, EspInterna, EspExterna, DescFundoArmario, FolgaPortaAltura, FolgaPortaLargura, FolgaGaveta, FolgaCorredicaFrente, FolgaCorredicaFundo, AjustePuxadorAltura, AjustePuxadorLargura, DescontoPerfilAltura, DescontoPerfilLargura, DescAlturaBaseGav, DescAlturaLateralGav`;

                    document.querySelectorAll(".formula-helper-altura").forEach((el) => (el.textContent = `Vari√°veis: ${baseVars}, ${otherVars}`));
                    document.querySelectorAll(".formula-helper-largura").forEach((el) => (el.textContent = `Vari√°veis: ${baseVars}, ${otherVars}`));

                    const corredicasHelper = document.querySelector("#view-editor-modulo small.formula-helper");
                    if (corredicasHelper) {
                        corredicasHelper.textContent = `Use 'A' (altura), 'L' (largura), 'P' (profundidade), 'NumGavetas' (qtd de frentes de gaveta no m√≥dulo), 'LadoA', 'LadoB', 'ProfA', 'ProfB' e vari√°veis de folga nas f√≥rmulas, como MedidaCorredica, DescAlturaBaseGav, DescAlturaLateralGav.`;
                    }
                };

                // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---
                const abrirModal = (modalId) => getEl(modalId).classList.add("active");
                const fecharModal = (modalId) => getEl(modalId).classList.remove("active");

                getEl("btnAbrirSelecaoModulo").addEventListener("click", () => {
                    popularGridSelecaoModulo();
                    abrirModal("modal-selecionar-modulo");
                });

                getEl("btnNavProjeto").addEventListener("click", () => navigateTo("view-projeto"));
                getEl("btnNavDados").addEventListener("click", () => navigateTo("view-dados"));
                getEl("btnNavProjetosClientes").addEventListener("click", () => {
                    atualizarSeletorClientes();
                    navigateTo("view-projetos-clientes");
                });
                getEl("btnNavConfig").addEventListener("click", () => navigateTo("view-configuracoes"));
                getEl("btnNavVisualizarCatalogo").addEventListener("click", () => {
                    popularModalCatalogoCompleto();
                    navigateTo("view-visualizar-catalogo");
                });
                getEl("btnNavGerenciarCatalogos").addEventListener("click", () => {
                    resetHardwareForm();
                    resetMaterialForm();
                    resetProfileForm();
                    resetPecaPredefinidaForm();
                    navigateTo("view-gerenciar-catalogos");
                });
                getEl("btnSalvarDadosJson").addEventListener("click", salvarDados);

                // Bot√£o para salvar projeto do cliente
                getEl("btnSalvarProjeto").addEventListener("click", () => {
                    const nomeCliente = ultimoNomeCliente || prompt("Digite o nome do cliente:");
                    const nomeAmbiente = ultimoNomeAmbiente || prompt("Digite o nome do ambiente/projeto:");
                    
                    if (nomeCliente && nomeAmbiente) {
                        const orcamentoTotal = document.getElementById("orcamento-total").textContent || "N√£o calculado";
                        salvarProjetoCliente(nomeCliente, nomeAmbiente, orcamentoTotal);
                        showToast(`‚úÖ Projeto salvo e banco de clientes exportado para JSON!`, "success");
                        console.log("BancoClientes atual:", BancoClientes);
                    } else {
                        showToast("‚ö†Ô∏è Opera√ß√£o cancelada", "warning");
                    }
                });

                // Fun√ß√£o para carregar dados.json via seletor de arquivo
                const carregarDadosDoArquivo = () => {
                    const inputFile = getEl("importarDadosInputDados");
                    const arquivo = inputFile.files[0];
                    
                    if (!arquivo) return;
                    
                    const leitor = new FileReader();
                    leitor.onload = (evento) => {
                        try {
                            const dadosNovos = JSON.parse(evento.target.result);
                            AppData = { ...AppData, ...dadosNovos };
                            window.AppData = AppData; // Update global reference
                            saveAppState();
                            showToast("Dados carregados com sucesso do arquivo!", "success");
                            console.log("Dados carregados do arquivo:", dadosNovos);
                            // Recarrega a p√°gina para aplicar os novos dados
                            setTimeout(() => location.reload(), 500);
                        } catch (e) {
                            console.error("Erro ao ler o arquivo JSON:", e);
                            showToast("Erro: Arquivo JSON inv√°lido!", "error");
                        }
                    };
                    leitor.readAsText(arquivo);
                    inputFile.value = ""; // Limpa o input
                };
                
                getEl("importarDadosInputDados").addEventListener("change", carregarDadosDoArquivo);

                // Fun√ß√£o para limpar localStorage (√∫til para come√ßar do zero)
                const limparLocalStorage = () => {
                    if (confirm("Tem certeza que deseja limpar todos os dados salvos?")) {
                        localStorage.removeItem("marcenaria_pro_AppData");
                        showToast("localStorage limpo. Recarregando p√°gina...", "warning");
                        setTimeout(() => location.reload(), 1500);
                    }
                };

                const atualizarListaGerenciarModulos = () => {
                    const container = getEl("lista-modulos-salvos");
                    container.innerHTML = "";
                    if (AppData.catalogoModulos) {
                        AppData.catalogoModulos.forEach((modulo) => {
                            const div = document.createElement("div");
                            div.className = "catalogo-item catalogo-item-com-imagem";
                            div.dataset.filterName = `${modulo.nome} ${modulo.categoria}`.toLowerCase();
                            div.innerHTML = `<img src="${modulo.imagem || "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="}" alt="Miniatura do m√≥dulo"><span>${modulo.categoria ? `[${modulo.categoria}] ` : ""}${
                                modulo.nome
                            }</span><div class="botoes-acao" style="margin-top:0; flex-wrap: nowrap;"><button class="btn-warning btn-sm btn-edit-modulo" data-id="${
                                modulo.id
                            }">Editar</button><button class="btn-danger btn-sm btn-delete-modulo" data-id="${modulo.id}">Excluir</button></div>`;
                            container.appendChild(div);
                        });
                    }
                };

                getEl("btnNavGerenciarModulos").addEventListener("click", () => {
                    atualizarListaGerenciarModulos();
                    navigateTo("view-gerenciar-modulos");
                });
                getEl("btnAbrirEditorModulo").addEventListener("click", () => {
                    resetModuleCreatorForm();
                    navigateTo("view-editor-modulo");
                });

                document.querySelectorAll(".btn-voltar").forEach((btn) => {
                    btn.addEventListener("click", () => navigateTo("view-projeto"));
                });

                getEl("btnAbrirModalRipado").addEventListener("click", () => abrirModal("modal-ripado"));
                document.querySelectorAll(".modal-close").forEach((btn) => btn.addEventListener("click", () => fecharModal(btn.dataset.modalId)));

                getEl("lista-modulos-salvos").addEventListener("click", (e) => {
                    const target = e.target.closest("button");
                    if (!target) return;
                    const moduloId = parseInt(target.dataset.id);
                    if (target.matches(".btn-edit-modulo")) carregarModuloParaEdicao(moduloId);
                    if (target.matches(".btn-delete-modulo") && confirm("Tem certeza que deseja excluir este m√≥dulo?")) {
                        AppData.catalogoModulos = AppData.catalogoModulos.filter((m) => m.id !== moduloId);
                        saveAppState();
                        target.closest(".catalogo-item").remove();
                        showToast("M√≥dulo exclu√≠do. Salve os dados para tornar a exclus√£o permanente.", "warning");
                    }
                });
                pecasContainer.addEventListener("click", (e) => {
                    const removeBtn = e.target.closest(".btn-remover-peca");
                    if (removeBtn) removeBtn.closest(".peca-item-wrapper").remove();
                });

                const handleCatalogClick = (e) => {
                    const target = e.target.closest("button");
                    if (!target) return;
                    const key = target.dataset.key,
                        type = target.dataset.type;
                    if (target.matches(".btn-delete") && confirm("Tem certeza?")) {
                        if (AppData[type] && AppData[type][key]) {
                            delete AppData[type][key];
                            saveAppState();
                            popularTodosSeletores();
                            resetMaterialForm();
                            resetHardwareForm();
                            resetProfileForm();
                            resetPecaPredefinidaForm();
                            showToast("Item exclu√≠do. Salve os dados para tornar a exclus√£o permanente.", "warning");
                        }
                    } else if (target.matches(".btn-edit-material")) carregarMaterialParaEdicao(key, type);
                    else if (target.matches(".btn-edit-ferragem")) carregarFerragemParaEdicao(key);
                    else if (target.matches(".btn-edit-perfil")) carregarPerfilParaEdicao(key);
                    else if (target.matches(".btn-edit-peca")) carregarPecaPredefinidaParaEdicao(key);
                };
                ["listaCoresMDF", "listaCoresBorda", "listaFerragensCatalogo", "listaPecasPredefinidas", "listaPerfisPuxador"].forEach((id) => getEl(id).addEventListener("click", handleCatalogClick));
                getEl("novoMaterialTipo").addEventListener("change", toggleMaterialPriceFields);
                const calcularPrecoMetroBorda = () => {
                    const precoRolo = parseFloat(getEl("novoMaterialPrecoRoloBorda").value),
                        metragemRolo = parseFloat(getEl("novoMaterialMetragemRoloBorda").value),
                        campoFinal = getEl("novoMaterialPrecoFinalBorda");
                    if (!isNaN(precoRolo) && !isNaN(metragemRolo) && metragemRolo > 0) campoFinal.value = (precoRolo / metragemRolo).toFixed(2);
                };
                getEl("novoMaterialPrecoRoloBorda").addEventListener("input", calcularPrecoMetroBorda);
                getEl("novoMaterialMetragemRoloBorda").addEventListener("input", calcularPrecoMetroBorda);
                getEl("novoMaterialPrecoFinalBorda").addEventListener("input", () => {
                    getEl("novoMaterialPrecoRoloBorda").value = "";
                    getEl("novoMaterialMetragemRoloBorda").value = "";
                });
                getEl("novoMaterialPrecoChapa").addEventListener("input", () => {
                    const precoChapa = parseFloat(getEl("novoMaterialPrecoChapa").value),
                        { chapaAltura, chapaLargura } = AppData.configCalculo,
                        campoCalculado = getEl("novoMaterialPrecoCalculado");
                    if (isNaN(precoChapa) || !chapaAltura || !chapaLargura) {
                        campoCalculado.value = "";
                        return;
                    }
                    const areaChapa = (chapaAltura / 1000) * (chapaLargura / 1000);
                    if (areaChapa > 0) campoCalculado.value = (precoChapa / areaChapa).toFixed(2);
                    else campoCalculado.value = "";
                });
                getEl("btnCancelarEdicaoMaterial").addEventListener("click", resetMaterialForm);
                getEl("btnAddMaterial").addEventListener("click", () => {
                    if (editingMaterialKey && editingMaterialType) {
                        const item = AppData[editingMaterialType][editingMaterialKey];
                        if (editingMaterialType === "coresMDF") {
                            const precoChapa = parseFloat(getEl("novoMaterialPrecoChapa").value);
                            if (isNaN(precoChapa)) return showToast("Pre√ßo inv√°lido.", "error");
                            item.precoChapa = precoChapa;
                        } else {
                            const preco = parseFloat(getEl("novoMaterialPrecoFinalBorda").value);
                            if (isNaN(preco)) return showToast("Pre√ßo inv√°lido.", "error");
                            item.preco = preco;
                        }
                        item.imagem = currentImageUrl.material;
                        recalculateAllMdfPrices();
                        saveAppState();
                        popularTodosSeletores();
                        showToast(`Material "${item.nome}" atualizado! Salve os dados.`, "success");
                        resetMaterialForm();
                    } else {
                        const tipo = getEl("novoMaterialTipo").value,
                            nome = getEl("novoMaterialNome").value.trim();
                        if (!nome) return showToast("Nome √© obrigat√≥rio.", "error");
                        const key = createKeyFromName(nome),
                            catalogo = tipo === "mdf" ? AppData.coresMDF : AppData.coresBorda;
                        if (catalogo[key]) return showToast("Material j√° existe.", "error");
                        if (tipo === "mdf") {
                            const precoChapa = parseFloat(getEl("novoMaterialPrecoChapa").value);
                            if (isNaN(precoChapa)) return showToast("Pre√ßo inv√°lido.", "error");
                            catalogo[key] = { nome, precoChapa, imagem: currentImageUrl.material };
                        } else {
                            const preco = parseFloat(getEl("novoMaterialPrecoFinalBorda").value);
                            if (isNaN(preco)) return showToast("Pre√ßo inv√°lido.", "error");
                            catalogo[key] = { nome, preco, imagem: currentImageUrl.material };
                        }
                        recalculateAllMdfPrices();
                        saveAppState();
                        popularTodosSeletores();
                        showToast(`"${nome}" adicionado! Salve os dados.`, "success");
                        resetMaterialForm();
                    }
                });
                getEl("btnSalvarFerragem").addEventListener("click", () => {
                    const nome = getEl("novaFerragemNome").value.trim(),
                        preco = parseFloat(getEl("novaFerragemPreco").value),
                        unidade = getEl("novaFerragemUnidade").value,
                        tipo = getEl("novaFerragemTipo").value;
                    if (!nome || isNaN(preco) || preco < 0) return showToast("Preencha nome e pre√ßo v√°lido.", "error");
                    const ferragemData = { nome, preco, unidade, tipo, imagem: currentImageUrl.hardware };
                    if (editingHardwareKey) {
                        const f = AppData.catalogoFerragens[editingHardwareKey];
                        f.nome = nome;
                        f.preco = preco;
                        f.unidade = unidade;
                        f.tipo = tipo;
                        f.imagem = currentImageUrl.hardware;
                        showToast(`"${nome}" atualizada! Salve os dados.`);
                    } else {
                        const newKey = createKeyFromName(nome);
                        if (AppData.catalogoFerragens[newKey]) return showToast("Ferragem j√° existe.", "error");
                        AppData.catalogoFerragens[newKey] = ferragemData;
                        showToast(`"${nome}" adicionada! Salve os dados.`);
                    }
                    saveAppState();
                    popularTodosSeletores();
                    resetHardwareForm();
                });
                getEl("btnSalvarPerfil").addEventListener("click", () => {
                    const nome = getEl("novoPerfilNome").value.trim(),
                        precoBarra = parseFloat(getEl("novoPerfilPrecoBarra").value),
                        metragemBarra = parseFloat(getEl("novoPerfilMetragemBarra").value),
                        preco = parseFloat(getEl("novoPerfilPrecoMetro").value);
                    if (!nome || isNaN(precoBarra) || isNaN(metragemBarra) || isNaN(preco)) return showToast("Preencha todos os campos.", "error");
                    const perfilData = { nome, precoBarra, metragemBarra, preco, imagem: currentImageUrl.profile };
                    if (editingProfileKey) {
                        const p = AppData.catalogoPerfis[editingProfileKey];
                        p.nome = nome;
                        p.precoBarra = precoBarra;
                        p.metragemBarra = metragemBarra;
                        p.preco = preco;
                        p.imagem = currentImageUrl.profile;
                        showToast(`Perfil "${nome}" atualizado! Salve os dados.`);
                    } else {
                        const newKey = createKeyFromName(nome);
                        if (AppData.catalogoPerfis[newKey]) return showToast("Perfil j√° existe.", "error");
                        AppData.catalogoPerfis[newKey] = perfilData;
                        showToast(`Perfil "${nome}" adicionada! Salve os dados.`);
                    }
                    saveAppState();
                    popularTodosSeletores();
                    resetProfileForm();
                });
                getEl("btnAdicionarPeca").addEventListener("click", () => adicionarNovaPeca());
                getEl("btnAdicionarFerragemModulo").addEventListener("click", () => {
                    const select = getEl("moduloFerragemSelect"),
                        valorInput = getEl("moduloFerragemValor"),
                        key = select.value,
                        valor = parseFloat(valorInput.value);
                    if (!key || !valor || valor <= 0) return showToast("Selecione uma ferragem e um valor v√°lido.", "error");
                    adicionarFerragemAoModuloUI({ key, valor });
                    select.value = "";
                    valorInput.value = "";
                });
                getEl("btnAdicionarCorredicaModulo").addEventListener("click", () => {
                    const select = getEl("moduloCorredicaSelect"),
                        qtdInput = getEl("moduloCorredicaQtd"),
                        medidaInput = getEl("moduloCorredicaMedida"),
                        key = select.value,
                        qtdFormula = qtdInput.value.trim(),
                        medidaFormula = medidaInput.value.trim();
                    if (!key || !qtdFormula || !medidaFormula) return showToast("Preencha todos os campos da corredi√ßa.", "error");
                    adicionarCorredicaAoModuloUI({ key, qtdFormula, medidaFormula });
                    select.value = "";
                    qtdInput.value = "";
                    medidaInput.value = "";
                });
                getEl("pecas-predefinidas").addEventListener("change", (e) => {
                    if (e.target.value) {
                        adicionarNovaPeca(AppData.pecasPredefinidas[e.target.value]);
                        e.target.value = "";
                    }
                });
                getEl("btnSalvarPecaCatalogo").addEventListener("click", () => {
                    const novaPeca = {
                        nome: getEl("novaPecaNome").value.trim(),
                        qtd: getEl("novaPecaQtd").value,
                        altura: getEl("novaPecaAltura").value.trim(),
                        largura: getEl("novaPecaLargura").value.trim(),
                        tipoMaterial: getEl("novaPecaTipoMaterial").value,
                        tipoBorda: getEl("novaPecaTipoBorda").value,
                    };
                    if (!novaPeca.nome) return showToast("O nome √© obrigat√≥rio.", "error");
                    if (editingPecaKey) {
                        AppData.pecasPredefinidas[editingPecaKey] = { ...AppData.pecasPredefinidas[editingPecaKey], ...novaPeca };
                        showToast(`Pe√ßa "${novaPeca.nome}" atualizada! Salve os dados.`);
                    } else {
                        const key = createKeyFromName(novaPeca.nome);
                        if (AppData.pecasPredefinidas[key]) return showToast("Pe√ßa j√° existe.", "error");
                        AppData.pecasPredefinidas[key] = novaPeca;
                        showToast("Pe√ßa adicionada! Salve os dados.", "success");
                    }
                    saveAppState();
                    popularTodosSeletores();
                    resetPecaPredefinidaForm();
                });
                getEl("btnCancelarEdicaoPeca").addEventListener("click", resetPecaPredefinidaForm);
                getEl("btnGerarRipado").addEventListener("click", () => {
                    const larguraRipa = parseFloat(getEl("ripadoLarguraRipa").value),
                        espacamento = parseFloat(getEl("ripadoEspacamento").value);
                    if (isNaN(larguraRipa) || isNaN(espacamento) || larguraRipa <= 0 || espacamento < 0) return showToast("Valores inv√°lidos.", "error");
                    if (getEl("ripadoIncluirFundo").checked) adicionarNovaPeca({ nome: "Fundo do Painel", qtd: "1", altura: "A", largura: "L", tipoMaterial: "externa", tipoBorda: "externa" });
                    adicionarNovaPeca({ nome: "Ripa", qtd: `L / (${larguraRipa} + ${espacamento})`, altura: "A", largura: String(larguraRipa), tipoMaterial: "externa", tipoBorda: "externa", bordaA1: true, bordaA2: true });
                    fecharModal("modal-ripado");
                    showToast("Pe√ßas do painel ripado adicionadas!", "success");
                });
                getEl("btnSalvarModulo").addEventListener("click", salvarModulo);
                getEl("btnAdicionarModulo").addEventListener("click", adicionarModuloAoProjeto);
                getEl("btnAdicionarFerragemExtra").addEventListener("click", adicionarFerragemExtra);
                
                // --- ATUALIZADO: Evento de remo√ß√£o de grupo (substitui a l√≥gica anterior) ---
                listaResumo.addEventListener("click", (e) => {
                    const target = e.target;
                    
                    // Remover item √∫nico (Ferragem ou legado)
                    if (target.matches(".btn-danger") && target.hasAttribute("data-instance-id")) {
                        removerItemDoProjeto(target.dataset.instanceId);
                    }
                    
                    // Remover GRUPO de m√≥dulos
                    if (target.matches(".btn-remover-grupo")) {
                        const idsString = target.dataset.ids;
                        if (idsString) {
                            const ids = idsString.split(',');
                            const confirmacao = confirm(`Deseja remover todos os ${ids.length} itens deste grupo do projeto?`);
                            
                            if (confirmacao) {
                                ids.forEach(id => removerItemDoProjeto(id));
                            }
                        }
                    }
                });

                getEl("btnGerarListagem").addEventListener("click", gerarListagem);

                // --- NOVA L√ìGICA PARA EDITAR PE√áAS ---
                listaPecasTbody.addEventListener("click", (e) => {
                    const target = e.target.closest("button");
                    if (!target) return;
                    const id = target.dataset.id;
                    const row = target.closest("tr");

                    // A√ß√£o de Remover (j√° existente, mas agora parte deste listener)
                    if (target.matches(".btn-remover-peca-final")) {
                        listaPecasGerada = listaPecasGerada.filter((p) => p.id !== id);
                        renderizarTabelasEOrcamento();
                        showToast("Pe√ßa removida.", "success");
                        return;
                    }

                    // A√ß√£o de Editar
                    if (target.matches(".btn-editar-peca-final")) {
                        const qtdCell = row.querySelector(".editable-qtd");
                        const alturaCell = row.querySelector(".editable-altura");
                        const larguraCell = row.querySelector(".editable-largura");
                        const acoesCell = row.querySelector(".acoes .botoes-acao");

                        // Salva os valores originais em caso de cancelamento
                        row.dataset.originalQtd = qtdCell.textContent;
                        row.dataset.originalAltura = alturaCell.textContent;
                        row.dataset.originalLargura = larguraCell.textContent;

                        qtdCell.innerHTML = `<input type="number" class="editable-input" value="${qtdCell.textContent}" />`;
                        alturaCell.innerHTML = `<input type="number" class="editable-input" value="${alturaCell.textContent}" />`;
                        larguraCell.innerHTML = `<input type="number" class="editable-input" value="${larguraCell.textContent}" />`;

                        acoesCell.innerHTML = `
                            <button class="btn-success btn-sm btn-salvar-peca-final" data-id="${id}">Salvar</button>
                            <button class="btn-secondary btn-sm btn-cancelar-edicao-peca" data-id="${id}">Cancelar</button>
                        `;
                        return;
                    }

                    // A√ß√£o de Salvar
                    if (target.matches(".btn-salvar-peca-final")) {
                        const peca = listaPecasGerada.find((p) => p.id === id);
                        if (!peca) return;

                        const novaQtd = parseFloat(row.querySelector(".editable-qtd input").value);
                        const novaAltura = parseFloat(row.querySelector(".editable-altura input").value);
                        const novaLargura = parseFloat(row.querySelector(".editable-largura input").value);

                        if (isNaN(novaQtd) || isNaN(novaAltura) || isNaN(novaLargura) || novaQtd <= 0 || novaAltura <= 0 || novaLargura <= 0) {
                            showToast("Valores inv√°lidos. Verifique os n√∫meros digitados.", "error");
                            return;
                        }

                        peca.qtd = novaQtd;
                        peca.alturaFinal = novaAltura;
                        peca.larguraFinal = novaLargura;

                        renderizarTabelasEOrcamento(); // Recalcula tudo e redesenha a tabela
                        showToast("Pe√ßa atualizada e or√ßamento recalculado!", "success");
                        return;
                    }

                    // A√ß√£o de Cancelar
                    if (target.matches(".btn-cancelar-edicao-peca")) {
                        // Apenas redesenha a tabela com os dados originais do array
                        renderizarTabelasEOrcamento();
                        return;
                    }
                });

                listaFerragensTbody.addEventListener("click", (e) => {
                    if (e.target.matches(".btn-remover-ferragem-final")) {
                        const ids = e.target.dataset.ids.split(",");
                        listaFerragensGerada = listaFerragensGerada.filter((f) => !ids.includes(f.id));
                        renderizarTabelasEOrcamento();
                        showToast("Ferragem removida.", "success");
                    }
                });
                document.addEventListener("click", (e) => {
                    if (e.target.matches(".item-preview")) e.target.nextElementSibling.click();
                });

                document.querySelectorAll(".imagem-input").forEach((input) =>
                    input.addEventListener("change", async (event) => {
                        const file = event.target.files[0];
                        const preview = event.target.previousElementSibling;
                        const form = event.target.closest(".card") || event.target.closest(".view-body") || event.target.closest(".modal-body");
                        if (!file || !form) return;

                        const originalSrc = preview.src;
                        preview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' stroke='%23ccc' stroke-width='10' fill='none'/%3E%3Ccircle cx='50' cy='50' r='40' stroke='%234a3f35' stroke-width='10' fill='none' stroke-dasharray='251.2' stroke-dashoffset='188.4' %3E%3CanimateTransform attributeName='transform' type='rotate' from='0 50 50' to='360 50 50' dur='1s' repeatCount='indefinite'/%3E%3C/circle%3E%3C/svg%3E";

                        const imageUrl = await uploadImage(file);

                        if (imageUrl) {
                            preview.src = imageUrl;
                            if (form.querySelector("#nomeModulo")) imagemModuloUrl = imageUrl;
                            if (form.querySelector("#novoMaterialNome")) currentImageUrl.material = imageUrl;
                            if (form.querySelector("#novaFerragemNome")) currentImageUrl.hardware = imageUrl;
                            if (form.querySelector("#novoPerfilNome")) currentImageUrl.profile = imageUrl;
                        } else {
                            preview.src = originalSrc;
                        }

                        event.target.value = "";
                    })
                );

                getEl("btnExportarProducao").addEventListener("click", exportarPDFProducao);
                getEl("btnGerarPreContrato").addEventListener("click", exportarPDFCliente);
                getEl("btnExportarExcel").addEventListener("click", exportarExcel);
                getEl("btnExportarCortcloud").addEventListener("click", exportarParaCortcloud);

                const importarDadosHandler = (event) => {
                    const fileInput = event.target;
                    const file = fileInput.files[0];
                    if (!file) return;
                    if (!confirm("Tem certeza que deseja importar este arquivo? Todos os dados atuais (n√£o salvos) ser√£o perdidos. Ap√≥s a importa√ß√£o, voc√™ precisar√° colar o conte√∫do do arquivo no HTML para salvar.")) {
                        fileInput.value = "";
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.catalogoModulos || importedData.coresMDF || importedData.catalogoFerragens) {
                                AppData = importedData;
                                window.AppData = AppData; // Update global reference
                                saveAppState();
                                showToast("Dados importados! A p√°gina ser√° recarregada.", "success");
                                setTimeout(() => window.location.reload(), 1500);
                            } else showToast("Arquivo de backup inv√°lido.", "error");
                        } catch (err) {
                            showToast("Erro ao ler o arquivo.", "error");
                            console.error("Erro no JSON:", err);
                        } finally {
                            fileInput.value = "";
                        }
                    };
                    reader.readAsText(file);
                };
                getEl("importarDadosInput").addEventListener("change", importarDadosHandler);
                getEl("labelImportarDados").addEventListener("click", () => getEl("importarDadosInput").click());

                getEl("btnSalvarConfig").addEventListener("click", () => {
                    salvarConfiguracoesDosInputs();
                    navigateTo("view-projeto");
                });

                // Bot√µes de gerenciamento de dados
                getEl("btnBaixarDadosJSON").addEventListener("click", () => {
                    exportarDadosJSON();
                    showToast("‚úÖ Arquivo dados.json baixado! Verifique a pasta Downloads.", "success");
                });

                getEl("btnBaixarDadosJS").addEventListener("click", () => {
                    exportarDadosJS();
                    showToast("‚úÖ Arquivo dados.js baixado! Verifique a pasta Downloads.", "success");
                });

                getEl("btnVerDadosJSON").addEventListener("click", () => {
                    const jsonText = JSON.stringify(AppData, null, 2);
                    getEl("json-view").value = jsonText;
                    document.getElementById("modal-visualizar-json").style.display = "flex";
                });

                window.copiarJsonParaClipboard = function() {
                    const textarea = getEl("json-view");
                    textarea.select();
                    document.execCommand("copy");
                    showToast("‚úÖ JSON copiado para clipboard!", "success");
                };

                getEl("categoriaModuloSelect").addEventListener("change", (e) => (getEl("novaCategoriaInput").style.display = e.target.value === "_add_new_" ? "block" : "none"));
                getEl("tipoModuloProjeto").addEventListener("change", (e) => {
                    const isReto = e.target.value === "reto";
                    getEl("dimensoes-container-reto").style.display = isReto ? "block" : "none";
                    getEl("dimensoes-container-canto").style.display = isReto ? "none" : "block";
                });
                getEl("moduloTipo").addEventListener("change", (e) => atualizarTodosOsHelpersNoModal(e.target.value));
                ["filtroModulos", "filtroCatalogo", "filtroSelecaoModulo"].forEach((filtroId) => {
                    const filtroInput = getEl(filtroId);
                    if (!filtroInput) return;

                    filtroInput.addEventListener("input", (e) => {
                        const termo = e.target.value.toLowerCase();
                        let container, items;

                        if (filtroId === "filtroModulos") {
                            container = getEl("lista-modulos-salvos");
                            items = container.querySelectorAll(".catalogo-item");
                        } else if (filtroId === "filtroCatalogo") {
                            container = getEl("view-gerenciar-catalogos");
                            items = container.querySelectorAll(".catalogo-item");
                        } else if (filtroId === "filtroSelecaoModulo") {
                            container = getEl("grid-selecao-modulos");
                            items = container.querySelectorAll(".modulo-selecao-card");
                        }

                        items.forEach((item) => {
                            const filterName = item.dataset.filterName || item.textContent.toLowerCase();
                            item.style.display = filterName.includes(termo) ? "" : "none";
                        });
                    });
                });

                await carregarDados();
                carregarBancoClientes(); // Carregar banco de clientes
                carregarConfiguracoesParaInputs();
                popularTodosSeletores();
                navigateTo("view-projeto");
            }

            document.addEventListener("DOMContentLoaded", inicializarApp);

            // Fun√ß√µes globais para acessar dados de projetos (definidas fora de inicializarApp)
            window.carregarProjetoCliente = function(nomeCliente, projetoId) {
                const BancoClientes = JSON.parse(localStorage.getItem("marcenaria_pro_clientes") || "{}");
                const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                let projeto = BancoClientes[clienteId]?.projetos.find(p => p.id === projetoId);
                
                if (projeto) {
                    // Adiciona o nome do cliente ao projeto se n√£o tiver
                    if (!projeto.nomeCliente) {
                        projeto = { ...projeto, nomeCliente: nomeCliente };
                    }
                    
                    console.log("Projeto carregado:", projeto);
                    
                    // Armazena o projeto em sessionStorage para acesso na renderiza√ß√£o
                    sessionStorage.setItem("projetoCarregado", JSON.stringify(projeto));
                    
                    // Aguarda um pouco para a tela renderizar, depois renderiza os dados
                    setTimeout(() => {
                        window.renderizarProjetoCarregado();
                    }, 500);
                    
                    return projeto;
                } else {
                    alert("Projeto n√£o encontrado!");
                }
                return null;
            };

            // Fun√ß√£o para renderizar projeto carregado
            window.renderizarProjetoCarregado = function() {
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                
                // Log detalhado no console
                console.log("=== PROJETO CARREGADO ===");
                console.log("Cliente:", projeto.nomeCliente);
                console.log("Projeto:", projeto.nome);
                console.log("Pe√ßas:", projeto.listaPecas);
                console.log("Ferragens Extras:", projeto.listaFerragens);
                console.log("Or√ßamento:", projeto.orcamento);
                console.log("Data:", projeto.data);
                
                // Atualiza a UI com os dados do projeto
                document.getElementById("editar-cliente-nome").value = projeto.nomeCliente || "Cliente";
                document.getElementById("editar-projeto-nome").value = projeto.nome || "Projeto";
                document.getElementById("editar-projeto-data").value = projeto.data || "Sem data";
                
                // Renderiza a tabela de PE√áAS GERADAS (listaPecasGerada - com f√≥rmulas)
                const pecasGeradasTable = document.getElementById("editar-pecas-geradas-tbody");
                if (pecasGeradasTable) {
                    pecasGeradasTable.innerHTML = "";
                    if (projeto.listaPecas && projeto.listaPecas.length > 0) {
                        let pecasExibidas = 0;
                        projeto.listaPecas.forEach((peca) => {
                            // Filtra apenas pe√ßas que N√ÉO cont√™m f√≥rmulas (valores j√° calculados)
                            const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/') || peca.altura.includes('-') || peca.altura.includes('?'))) ||
                                              (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/') || peca.largura.includes('-') || peca.largura.includes('?')));
                            
                            // Tamb√©m verifica se altura e largura s√£o valores v√°lidos (n√∫meros ou "-")
                            const alturaValida = peca.altura && (peca.altura === "-" || !isNaN(parseFloat(peca.altura)));
                            const larguraValida = peca.largura && (peca.largura === "-" || !isNaN(parseFloat(peca.largura)));
                            
                            // Mostra apenas pe√ßas simples, sem f√≥rmulas e com valores v√°lidos
                            if (peca.nome && !temF√≥rmula && alturaValida && larguraValida) {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${peca.nome || ""}</strong></td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.qtd || "1"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.altura || "-"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.largura || "-"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.espessura || "-"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.material || "-"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.bordas || "-"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.corBorda || "-"}</td>
                                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; color: var(--cor-principal); font-weight: 600;">(Agrupado)</td>
                                `;
                                pecasGeradasTable.appendChild(row);
                                pecasExibidas++;
                            }
                        });
                        
                        // Se nenhuma pe√ßa gerada foi encontrada
                        if (pecasExibidas === 0) {
                            pecasGeradasTable.innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">‚ö†Ô∏è Nenhuma pe√ßa com valores calculados. Use a calculadora do projeto para gerar os valores.</td></tr>';
                        }
                    } else {
                        pecasGeradasTable.innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa gerada</td></tr>';
                    }
                }
                
                // Renderiza as tabelas com os dados do projeto (PE√áAS SIMPLES ADICIONAIS)
                const pecasTable = document.getElementById("editar-pecas-tbody");
                if (pecasTable) {
                    pecasTable.innerHTML = "";
                    if (projeto.listaPecas && projeto.listaPecas.length > 0) {
                        projeto.listaPecas.forEach((peca, idx) => {
                            // Ignora pe√ßas que parecem ser geradas por f√≥rmula (com caracteres especiais nas dimens√µes)
                            const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/'))) ||
                                              (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/')));
                            
                            if (temF√≥rmula) {
                                // Pula pe√ßas com f√≥rmulas
                                return;
                            }
                            
                            const precoUnit = parseFloat(peca.preco || 0);
                            const qtd = parseFloat(peca.qtd || 1);
                            const total = precoUnit * qtd;
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${peca.nome || ""}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;"><input type="number" value="${qtd}" onchange="window.atualizarOrcamentoProjeto();" style="width: 60px; padding: 5px;" /></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.altura || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.largura || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">
                                    <input type="number" value="${precoUnit.toFixed(2)}" onchange="window.atualizarOrcamentoProjeto();" step="0.01" style="width: 80px; padding: 5px;" />
                                </td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><strong>R$ ${total.toFixed(2)}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                    <button type="button" class="btn-danger btn-sm" onclick="window.removerPecaDeProjeto(${idx});">üóëÔ∏è</button>
                                </td>
                            `;
                            pecasTable.appendChild(row);
                        });
                        
                        // Se nenhuma pe√ßa simples foi encontrada
                        if (pecasTable.innerHTML === '') {
                            pecasTable.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa adicional adicionada</td></tr>';
                        }
                    } else {
                        pecasTable.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa adicionada ainda</td></tr>';
                    }
                }
                
                const ferragensTable = document.getElementById("editar-ferragens-tbody");
                if (ferragensTable) {
                    ferragensTable.innerHTML = "";
                    if (projeto.listaFerragens && projeto.listaFerragens.length > 0) {
                        projeto.listaFerragens.forEach((ferragem, idx) => {
                            const precoUnit = parseFloat(ferragem.preco || 0);
                            const qtd = ferragem.valor || "1";
                            const total = precoUnit * (parseFloat(qtd) || 1);
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${ferragem.nome || ""}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                    <input type="text" value="${qtd}" onchange="window.atualizarOrcamentoProjeto();" style="width: 80px; padding: 5px;" />
                                </td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">
                                    <input type="number" value="${precoUnit.toFixed(2)}" onchange="window.atualizarOrcamentoProjeto();" step="0.01" style="width: 80px; padding: 5px;" />
                                </td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><strong>R$ ${total.toFixed(2)}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                                    <button type="button" class="btn-danger btn-sm" onclick="window.removerFerragemDeProjeto(${idx});">üóëÔ∏è</button>
                                </td>
                            `;
                            ferragensTable.appendChild(row);
                        });
                    } else {
                        ferragensTable.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem adicionada ainda</td></tr>';
                    }
                }
                
                // Renderiza a tabela de FERRAGENS GERADAS
                const ferragensGeradasTable = document.getElementById("editar-ferragens-geradas-tbody");
                if (ferragensGeradasTable) {
                    ferragensGeradasTable.innerHTML = "";
                    if (projeto.listaFerragens && projeto.listaFerragens.length > 0) {
                        projeto.listaFerragens.forEach((ferragem) => {
                            const precoUnit = parseFloat(ferragem.preco || 0);
                            const qtd = ferragem.valor || "1";
                            const total = precoUnit * (parseFloat(qtd) || 1);
                            const source = ferragem.source || "geral";
                            
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${ferragem.nome || ""}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${qtd}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">R$ ${precoUnit.toFixed(2)}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><strong>R$ ${total.toFixed(2)}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: left;">
                                    <span style="background: ${source === 'extra' ? '#f87171' : source === 'automatica' ? '#34d399' : '#60a5fa'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                                        ${source === 'extra' ? 'Extra' : source === 'automatica' ? 'Autom√°tica' : source === 'geral_modulo' ? 'Geral M√≥dulo' : source === 'associada_peca' ? 'Associada Pe√ßa' : 'Geral'}
                                    </span>
                                </td>
                            `;
                            ferragensGeradasTable.appendChild(row);
                        });
                        
                        if (ferragensGeradasTable.innerHTML === '') {
                            ferragensGeradasTable.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem gerada</td></tr>';
                        }
                    } else {
                        ferragensGeradasTable.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem gerada</td></tr>';
                    }
                }
                
                // Renderiza a LISTA DE COMPRAS (agrupado por material)
                const listaComprasTable = document.getElementById("editar-lista-compras-tbody");
                if (listaComprasTable) {
                    listaComprasTable.innerHTML = "";
                    
                    // Cria um agrupamento de materiais a partir das pe√ßas
                    const materiaisPorTipo = {};
                    if (projeto.listaPecas && projeto.listaPecas.length > 0) {
                        projeto.listaPecas.forEach((peca) => {
                            const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/'))) ||
                                              (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/')));
                            
                            if (!temF√≥rmula) return; // Usa apenas pe√ßas com f√≥rmulas (as geradas)
                            
                            const material = peca.material || "Sem Material";
                            const quantidade = peca.qtd || 1;
                            
                            // Tenta avaliar altura e largura com prote√ß√£o contra vari√°veis indefinidas
                            let altura = peca.altura;
                            let largura = peca.largura;
                            
                            try {
                                if (typeof peca.altura === 'string') {
                                    altura = eval(peca.altura.replace(/P/g, '').replace(/A/g, ''));
                                }
                            } catch (e) {
                                altura = peca.altura; // Mant√©m a f√≥rmula como texto se n√£o conseguir avaliar
                            }
                            
                            try {
                                if (typeof peca.largura === 'string') {
                                    largura = eval(peca.largura.replace(/P/g, '').replace(/A/g, ''));
                                }
                            } catch (e) {
                                largura = peca.largura; // Mant√©m a f√≥rmula como texto se n√£o conseguir avaliar
                            }
                            
                            const chapa = `${material} - ${altura}x${largura}`;
                            
                            if (!materiaisPorTipo[chapa]) {
                                materiaisPorTipo[chapa] = {
                                    nome: chapa,
                                    qtd: 0,
                                    preco: parseFloat(peca.preco || 0)
                                };
                            }
                            materiaisPorTipo[chapa].qtd += quantidade;
                        });
                        
                        // Renderiza cada material
                        Object.values(materiaisPorTipo).forEach((item) => {
                            const subtotal = item.qtd * item.preco;
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${item.nome}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${item.qtd}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">R$ ${item.preco.toFixed(2)}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><strong>R$ ${subtotal.toFixed(2)}</strong></td>
                            `;
                            listaComprasTable.appendChild(row);
                        });
                        
                        if (listaComprasTable.innerHTML === '') {
                            listaComprasTable.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhum material para comprar</td></tr>';
                        }
                    } else {
                        listaComprasTable.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhum material para comprar</td></tr>';
                    }
                }
                
                // Calcula e mostra o or√ßamento
                window.atualizarOrcamentoProjeto();
                
                // Navega para a tela de edi√ß√£o
                window.navigateTo('view-editar-projeto');
                
                // Alerta detalhado
                alert(`‚úÖ Projeto "${projeto.nome}" carregado!\n\nCliente: ${projeto.nomeCliente}\nPe√ßas: ${projeto.listaPecas?.length || 0}\nFerragens: ${projeto.listaFerragens?.length || 0}\nOr√ßamento: R$ ${parseFloat(projeto.orcamento || 0).toFixed(2)}`);
            };

            window.deletarProjetoCliente = function(nomeCliente, projetoId) {
                const BancoClientes = JSON.parse(localStorage.getItem("marcenaria_pro_clientes") || "{}");
                const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                if (BancoClientes[clienteId]) {
                    BancoClientes[clienteId].projetos = BancoClientes[clienteId].projetos.filter(p => p.id !== projetoId);
                    localStorage.setItem("marcenaria_pro_clientes", JSON.stringify(BancoClientes));
                    alert("Projeto deletado com sucesso!");
                    location.reload();
                }
            };

            window.exportarProjetosCliente = function(nomeCliente) {
                const BancoClientes = JSON.parse(localStorage.getItem("marcenaria_pro_clientes") || "{}");
                const clienteId = nomeCliente.toLowerCase().replace(/\s+/g, '-');
                const cliente = BancoClientes[clienteId];
                if (!cliente || cliente.projetos.length === 0) {
                    alert("Nenhum projeto encontrado para este cliente.");
                    return;
                }
                
                const dadosFormatados = JSON.stringify(cliente, null, 4);
                const blob = new Blob([dadosFormatados], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.style.display = "none";
                a.href = url;
                a.download = `projetos-${nomeCliente}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert("Projetos exportados com sucesso!");
            };

            window.carregarProjetosParaExibicao = function(clienteId) {
                const BancoClientes = JSON.parse(localStorage.getItem("marcenaria_pro_clientes") || "{}");
                const cliente = BancoClientes[clienteId];
                if (!cliente) return;
                
                document.getElementById("nome-cliente-selecionado").textContent = cliente.nome;
                const container = document.getElementById("lista-projetos-cliente");
                container.innerHTML = "";

                cliente.projetos.forEach(projeto => {
                    const div = document.createElement("div");
                    div.className = "catalogo-item";
                    div.style.flexDirection = "column";
                    div.style.alignItems = "flex-start";
                    
                    const dataProjeto = new Date(projeto.data).toLocaleDateString('pt-BR');
                    const html = `
                        <div style="width: 100%; margin-bottom: 8px;">
                            <strong style="color: var(--cor-principal); font-size: 1.05rem;">${projeto.nome}</strong>
                            <p style="font-size: 0.85rem; color: var(--cor-texto-suave); margin: 4px 0;">üìÖ ${dataProjeto}</p>
                            <p style="font-size: 0.9rem; color: var(--cor-sucesso);">üí∞ Or√ßamento: ${projeto.orcamento}</p>
                        </div>
                        <div style="display: flex; gap: 10px; width: 100%;">
                            <button class="btn btn-primary btn-sm" onclick="window.carregarProjetoCliente('${cliente.nome}', '${projeto.id}')">Abrir</button>
                            <button class="btn btn-secondary btn-sm" onclick="window.deletarProjetoCliente('${cliente.nome}', '${projeto.id}')">Deletar</button>
                            <button class="btn btn-warning btn-sm" onclick="window.exportarProjetosCliente('${cliente.nome}')">Exportar</button>
                        </div>
                    `;
                    div.innerHTML = html;
                    container.appendChild(div);
                });

                document.getElementById("aviso-nenhum-cliente").style.display = "none";
                document.getElementById("container-projetos-cliente").style.display = "block";
            };

            // Fun√ß√µes para edi√ß√£o de projeto carregado
            window.atualizarOrcamentoProjeto = function() {
                const pecasTable = document.getElementById("editar-pecas-tbody");
                const ferragensTable = document.getElementById("editar-ferragens-tbody");
                
                let total = 0;
                
                // Soma pe√ßas
                const pecasRows = pecasTable.querySelectorAll("tr");
                pecasRows.forEach(row => {
                    const inputs = row.querySelectorAll("input[type='number']");
                    if (inputs.length >= 2) {
                        const qtd = parseFloat(inputs[0].value) || 0;
                        const preco = parseFloat(inputs[1].value) || 0;
                        total += qtd * preco;
                    }
                });
                
                // Soma ferragens
                const ferragensRows = ferragensTable.querySelectorAll("tr");
                ferragensRows.forEach(row => {
                    const inputs = row.querySelectorAll("input");
                    if (inputs.length >= 2) {
                        const qtd = parseFloat(inputs[0].value) || 1;
                        const preco = parseFloat(inputs[1].value) || 0;
                        total += qtd * preco;
                    }
                });
                
                document.getElementById("editar-orcamento-total").textContent = `R$ ${total.toFixed(2)}`;
            };

            window.removerPecaDeProjeto = function(idx) {
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                if (confirm(`Remover a pe√ßa "${projeto.listaPecas[idx].nome}"?`)) {
                    projeto.listaPecas.splice(idx, 1);
                    sessionStorage.setItem("projetoCarregado", JSON.stringify(projeto));
                    window.renderizarProjetoCarregado();
                }
            };

            window.removerFerragemDeProjeto = function(idx) {
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                if (confirm(`Remover a ferragem "${projeto.listaFerragens[idx].nome}"?`)) {
                    projeto.listaFerragens.splice(idx, 1);
                    sessionStorage.setItem("projetoCarregado", JSON.stringify(projeto));
                    window.renderizarProjetoCarregado();
                }
            };

            window.adicionarPecaEmProjeto = function() {
                const nome = prompt("Nome da pe√ßa:");
                if (!nome) return;
                
                const qtd = parseFloat(prompt("Quantidade:") || "1");
                const altura = prompt("Altura:");
                const largura = prompt("Largura:");
                const preco = parseFloat(prompt("Pre√ßo unit√°rio:") || "0");
                
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                projeto.listaPecas.push({
                    nome, qtd, altura, largura, preco
                });
                
                sessionStorage.setItem("projetoCarregado", JSON.stringify(projeto));
                window.renderizarProjetoCarregado();
            };

            window.adicionarFerragemEmProjeto = function() {
                const nome = prompt("Nome da ferragem:");
                if (!nome) return;
                
                const valor = prompt("Quantidade/Medida:");
                const preco = parseFloat(prompt("Pre√ßo unit√°rio:") || "0");
                
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                projeto.listaFerragens.push({
                    nome, valor, preco
                });
                
                sessionStorage.setItem("projetoCarregado", JSON.stringify(projeto));
                window.renderizarProjetoCarregado();
            };

            window.gerarRelatorioProjeto = function() {
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                
                // Preencher cabe√ßalho
                document.getElementById("rel-cliente").textContent = projeto.nomeCliente || "N/A";
                document.getElementById("rel-projeto").textContent = projeto.nome || "N/A";
                document.getElementById("rel-data").textContent = projeto.data || "N/A";
                
                // Pe√ßas geradas (com f√≥rmulas)
                const pecasGeradasTable = document.getElementById("rel-pecas-geradas");
                pecasGeradasTable.innerHTML = "";
                if (projeto.listaPecas && projeto.listaPecas.length > 0) {
                    projeto.listaPecas.forEach(peca => {
                        const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/'))) ||
                                          (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/')));
                        
                        if (temF√≥rmula) {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${peca.nome || ""}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.qtd || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.85rem; color: #666;">${peca.altura || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.85rem; color: #666;">${peca.largura || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; color: #666;">${peca.espessura || "-"}</td>
                            `;
                            pecasGeradasTable.appendChild(row);
                        }
                    });
                    
                    if (pecasGeradasTable.innerHTML === '') {
                        pecasGeradasTable.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa gerada</td></tr>';
                    }
                } else {
                    pecasGeradasTable.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa</td></tr>';
                }
                
                // Pe√ßas manuais (sem f√≥rmulas)
                const pecasManuaisTable = document.getElementById("rel-pecas-manuais");
                pecasManuaisTable.innerHTML = "";
                let totalPecas = 0;
                if (projeto.listaPecas && projeto.listaPecas.length > 0) {
                    projeto.listaPecas.forEach(peca => {
                        const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/'))) ||
                                          (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/')));
                        
                        if (!temF√≥rmula && (peca.preco && peca.preco > 0)) {
                            const precoUnit = parseFloat(peca.preco || 0);
                            const qtd = parseFloat(peca.qtd || 1);
                            const total = precoUnit * qtd;
                            totalPecas += total;
                            
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${peca.nome || ""}</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${qtd}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.altura || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${peca.largura || "-"}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">R$ ${precoUnit.toFixed(2)}</td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><strong>R$ ${total.toFixed(2)}</strong></td>
                            `;
                            pecasManuaisTable.appendChild(row);
                        }
                    });
                    
                    if (pecasManuaisTable.innerHTML === '') {
                        pecasManuaisTable.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa manual adicionada</td></tr>';
                    }
                } else {
                    pecasManuaisTable.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma pe√ßa</td></tr>';
                }
                
                // Ferragens
                const ferragensTable = document.getElementById("rel-ferragens");
                ferragensTable.innerHTML = "";
                let totalFerragens = 0;
                if (projeto.listaFerragens && projeto.listaFerragens.length > 0) {
                    projeto.listaFerragens.forEach(ferragem => {
                        const precoUnit = parseFloat(ferragem.preco || 0);
                        const qtd = parseFloat(ferragem.valor || 1);
                        const total = precoUnit * qtd;
                        totalFerragens += total;
                        
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>${ferragem.nome || ""}</strong></td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">${ferragem.valor || "-"}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">R$ ${precoUnit.toFixed(2)}</td>
                            <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;"><strong>R$ ${total.toFixed(2)}</strong></td>
                        `;
                        ferragensTable.appendChild(row);
                    });
                    
                    if (ferragensTable.innerHTML === '') {
                        ferragensTable.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem</td></tr>';
                    }
                } else {
                    ferragensTable.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--cor-texto-suave);">Nenhuma ferragem</td></tr>';
                }
                
                // Totais
                const totalGeral = totalPecas + totalFerragens;
                document.getElementById("rel-total-pecas").textContent = `R$ ${totalPecas.toFixed(2)}`;
                document.getElementById("rel-total-ferragens").textContent = `R$ ${totalFerragens.toFixed(2)}`;
                document.getElementById("rel-total-geral").textContent = `R$ ${totalGeral.toFixed(2)}`;
                
                // Navegar para o relat√≥rio
                window.navigateTo('view-relatorio-projeto');
            };

            window.imprimirRelatorio = function() {
                window.print();
            };

            window.exportarRelatorioCSV = function() {
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) return;
                
                const projeto = JSON.parse(projetoJSON);
                let csv = "RELAT√ìRIO DO PROJETO\n";
                csv += `Cliente: ${projeto.nomeCliente}\n`;
                csv += `Projeto: ${projeto.nome}\n`;
                csv += `Data: ${projeto.data}\n\n`;
                
                csv += "PE√áAS GERADAS DO M√ìDULO\n";
                csv += "Pe√ßa,Qtd,Altura,Largura,Material\n";
                if (projeto.listaPecas) {
                    projeto.listaPecas.forEach(peca => {
                        const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/'))) ||
                                          (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/')));
                        if (temF√≥rmula) {
                            csv += `"${peca.nome}","${peca.qtd}","${peca.altura}","${peca.largura}","${peca.espessura}"\n`;
                        }
                    });
                }
                
                csv += "\nPE√áAS ADICIONADAS MANUALMENTE\n";
                csv += "Pe√ßa,Qtd,Altura,Largura,Pre√ßo Unit.,Total\n";
                if (projeto.listaPecas) {
                    projeto.listaPecas.forEach(peca => {
                        const temF√≥rmula = (peca.altura && (peca.altura.includes('(') || peca.altura.includes('*') || peca.altura.includes('/'))) ||
                                          (peca.largura && (peca.largura.includes('(') || peca.largura.includes('*') || peca.largura.includes('/')));
                        if (!temF√≥rmula && (peca.preco && peca.preco > 0)) {
                            const precoUnit = parseFloat(peca.preco || 0);
                            const qtd = parseFloat(peca.qtd || 1);
                            const total = precoUnit * qtd;
                            csv += `"${peca.nome}","${qtd}","${peca.altura}","${peca.largura}","${precoUnit.toFixed(2)}","${total.toFixed(2)}"\n`;
                        }
                    });
                }
                
                csv += "\nFERRAGENS EXTRAS\n";
                csv += "Ferragem,Qtd/Medida,Pre√ßo Unit.,Total\n";
                if (projeto.listaFerragens) {
                    projeto.listaFerragens.forEach(ferragem => {
                        const precoUnit = parseFloat(ferragem.preco || 0);
                        const qtd = parseFloat(ferragem.valor || 1);
                        const total = precoUnit * qtd;
                        csv += `"${ferragem.nome}","${ferragem.valor}","${precoUnit.toFixed(2)}","${total.toFixed(2)}"\n`;
                    });
                }
                
                csv += "\nRESUMO FINANCEIRO\n";
                const totalPecas = Array.from(document.getElementById("rel-total-pecas").textContent.match(/[\d.,]+/g) || [0]).reduce((a, b) => a + parseFloat(b.replace(',', '.')), 0);
                const totalFerragens = Array.from(document.getElementById("rel-total-ferragens").textContent.match(/[\d.,]+/g) || [0]).reduce((a, b) => a + parseFloat(b.replace(',', '.')), 0);
                const totalGeral = totalPecas + totalFerragens;
                csv += `Total Pe√ßas,${totalPecas.toFixed(2)}\n`;
                csv += `Total Ferragens,${totalFerragens.toFixed(2)}\n`;
                csv += `TOTAL GERAL,${totalGeral.toFixed(2)}\n`;
                
                // Baixar arquivo
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio_${projeto.nome.replace(/\s/g, '_')}_${new Date().getTime()}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            };

            window.salvarAlteracoesProjetoCarregado = function() {
                const projetoJSON = sessionStorage.getItem("projetoCarregado");
                if (!projetoJSON) {
                    alert("Nenhum projeto carregado!");
                    return;
                }
                
                const projeto = JSON.parse(projetoJSON);
                const nomeClienteSalvo = projeto.nomeCliente;
                const projetoIdSalvo = projeto.id;
                
                // Atualizar dados do formul√°rio
                projeto.nome = document.getElementById("editar-projeto-nome").value;
                
                // Recalcular or√ßamento
                let total = 0;
                const pecasTable = document.getElementById("editar-pecas-tbody");
                const pecasRows = pecasTable.querySelectorAll("tr");
                pecasRows.forEach(row => {
                    const inputs = row.querySelectorAll("input[type='number']");
                    if (inputs.length >= 2) {
                        const qtd = parseFloat(inputs[0].value) || 0;
                        const preco = parseFloat(inputs[1].value) || 0;
                        total += qtd * preco;
                    }
                });
                
                const ferragensTable = document.getElementById("editar-ferragens-tbody");
                const ferragensRows = ferragensTable.querySelectorAll("tr");
                ferragensRows.forEach(row => {
                    const inputs = row.querySelectorAll("input");
                    if (inputs.length >= 2) {
                        const qtd = parseFloat(inputs[0].value) || 1;
                        const preco = parseFloat(inputs[1].value) || 0;
                        total += qtd * preco;
                    }
                });
                
                projeto.orcamento = total;
                
                // Salvar no BancoClientes
                const BancoClientes = JSON.parse(localStorage.getItem("marcenaria_pro_clientes") || "{}");
                const clienteId = nomeClienteSalvo.toLowerCase().replace(/\s+/g, '-');
                
                if (BancoClientes[clienteId]) {
                    const projetoIndex = BancoClientes[clienteId].projetos.findIndex(p => p.id === projetoIdSalvo);
                    if (projetoIndex !== -1) {
                        BancoClientes[clienteId].projetos[projetoIndex] = projeto;
                        localStorage.setItem("marcenaria_pro_clientes", JSON.stringify(BancoClientes));
                        
                        alert(`‚úÖ Altera√ß√µes salvas com sucesso!\n\nNovo or√ßamento: R$ ${total.toFixed(2)}`);
                        sessionStorage.removeItem("projetoCarregado");
                        window.navigateTo('view-projetos-clientes');
                    }
                }
            };

            // Debug - Mostrar status dos dados no console
            console.log("üîç VERIFICA√á√ÉO DE DADOS:");
            console.log("========================");
            console.log("üì¶ localStorage 'marcenaria_pro_AppData':", localStorage.getItem("marcenaria_pro_AppData") ? "‚úÖ Existe" : "‚ùå N√£o existe");
            console.log("üì¶ localStorage 'marcenaria_pro_clientes':", localStorage.getItem("marcenaria_pro_clientes") ? "‚úÖ Existe" : "‚ùå N√£o existe");
            console.log("üì¶ window.DADOS_DO_SISTEMA:", window.DADOS_DO_SISTEMA ? "‚úÖ Existe" : "‚ùå N√£o existe");
            if (window.DADOS_DO_SISTEMA) {
                console.log("   - M√≥dulos:", window.DADOS_DO_SISTEMA.catalogoModulos?.length || 0);
                console.log("   - Cores MDF:", Object.keys(window.DADOS_DO_SISTEMA.coresMDF || {}).length);
            }

            // Fun√ß√£o para carregar dados de um caminho customizado
            window.carregarDadosCustomizado = async function() {
                const caminho = document.getElementById("caminhoCustomizadoDados").value.trim();
                
                if (!caminho) {
                    alert("‚ö†Ô∏è Digite um caminho v√°lido para o arquivo dados.json");
                    return;
                }
                
                try {
                    console.log("üîç Tentando carregar de: " + caminho);
                    const resposta = await fetch(caminho, { 
                        method: "GET", 
                        cache: "no-store",
                        headers: { "Accept": "application/json" }
                    });
                    
                    if (resposta.ok) {
                        const dados = await resposta.json();
                        if (dados.catalogoModulos || dados.coresMDF || dados.catalogoFerragens) {
                            localStorage.setItem("marcenaria_pro_AppData", JSON.stringify(dados));
                            alert("‚úÖ Dados carregados com sucesso de: " + caminho + "\n\nA p√°gina ser√° recarregada...");
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            alert("‚ùå Arquivo n√£o parece ser um backup v√°lido do sistema.\n\nVerifique se cont√©m: catalogoModulos, coresMDF, catalogoFerragens");
                        }
                    } else {
                        alert("‚ùå Arquivo n√£o encontrado em: " + caminho + "\n\nHTTP Status: " + resposta.status);
                    }
                } catch (e) {
                    alert("‚ùå Erro ao carregar arquivo:\n\n" + e.message + "\n\nVerifique se o caminho est√° correto e o arquivo est√° acess√≠vel.");
                    console.error("Erro ao carregar dados customizado:", e);
                }
            };

            window.verificarStatusDados = function() {
                // Try to get AppData from window, localStorage, or DADOS_DO_SISTEMA
                const appData = window.AppData || JSON.parse(localStorage.getItem("marcenaria_pro_AppData") || "null") || window.DADOS_DO_SISTEMA || {};
                
                const status = {
                    "üîπ M√≥dulos": appData.catalogoModulos?.length || 0,
                    "üîπ Cores MDF": Object.keys(appData.coresMDF || {}).length,
                    "üîπ Cores Borda": Object.keys(appData.coresBorda || {}).length,
                    "üîπ Ferragens": Object.keys(appData.catalogoFerragens || {}).length,
                    "üîπ Perfis": Object.keys(appData.catalogoPerfis || {}).length,
                    "üîπ Pe√ßas Pr√©-definidas": Object.keys(appData.pecasPredefinidas || {}).length,
                    "üîπ LocalStorage AppData": localStorage.getItem("marcenaria_pro_AppData") ? "‚úÖ Sim" : "‚ùå N√£o",
                    "üîπ LocalStorage Clientes": localStorage.getItem("marcenaria_pro_clientes") ? "‚úÖ Sim" : "‚ùå N√£o",
                };
                
                const dadosVazios = status["üîπ M√≥dulos"] === 0 && 
                                   status["üîπ Cores MDF"] === 0 && 
                                   status["üîπ Cores Borda"] === 0;
                
                let mensagem = "üìä STATUS DOS DADOS DO SISTEMA:\n";
                mensagem += "================================\n\n";
                
                Object.entries(status).forEach(([chave, valor]) => {
                    mensagem += `${chave}: ${valor}\n`;
                });
                
                if (dadosVazios) {
                    mensagem += "\n‚ö†Ô∏è ATEN√á√ÉO: Os dados est√£o VAZIOS!\n";
                    mensagem += "================================\n";
                    mensagem += "Voc√™ precisa importar seus dados:\n\n";
                    mensagem += "1. V√° em Configura√ß√µes (√≠cone ‚öôÔ∏è)\n";
                    mensagem += "2. Clique em 'Importar Backup' ou 'Baixar dados.json'\n";
                    mensagem += "3. Se voc√™ n√£o tiver um arquivo, coloque 'dados.json' na mesma pasta do index.html\n";
                    mensagem += "4. Recarregue a p√°gina (F5)";
                }
                
                console.table(status);
                alert(mensagem);
            };

        </script>
    </body>
</html>